import apiService from "/src/services/apiService.ts";
window.showPasswordErrorModal = function() {
  document.dispatchEvent(new CustomEvent("show-password-error"));
};
document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("loginForm");
  const script = document.createElement("script");
  script.textContent = `
      // Esta función se ejecutará cuando el componente React esté listo
      document.addEventListener('astro:page-load', () => {
        // Escuchar el evento personalizado para mostrar el modal
        document.addEventListener('show-password-error', () => {
          // Buscar el elemento modal por su ID
          const modal = document.getElementById('passwordErrorModal');
          if (modal) {
            // Enviar mensaje al componente React para cambiar su estado
            const event = new CustomEvent('update-modal-state', { 
              detail: { isOpen: true } 
            });
            modal.dispatchEvent(event);
          }
        });
      });
    `;
  document.head.appendChild(script);
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    try {
      const response = await apiService.login(username, password);
      const token = response.data?.access_token || response.access_token;
      if (token) {
        console.log("Login exitoso, token recibido:", token);
        localStorage.setItem("token", token);
        if (response.data?.user || response.user) {
          const userData = response.data?.user || response.user;
          if (userData.username && userData.username.toLowerCase() === "ramon") {
            console.log("🔴 Usuario Ramon detectado, FORZANDO rol Ramon");
            userData.role = "Ramon";
            localStorage.setItem("userRole", "Ramon");
            console.log("🔴 Rol Ramon guardado separadamente para mayor seguridad");
            localStorage.setItem("ramonFix", "true");
          } else if (userData.role === "gerente") {
            console.log("Rol gerente detectado, convirtiendo a Ramon");
            userData.role = "Ramon";
            localStorage.setItem("userRole", "Ramon");
          }
          localStorage.setItem("user", JSON.stringify(userData));
          if (userData.role) {
            localStorage.setItem("userRole", userData.role);
          }
        }
        console.log("Redirigiendo a la página principal (dashboard)");
        window.location.href = "/";
        return;
      } else {
        console.error("Error de autenticación: No se encontró token en la respuesta:", response);
        window.showPasswordErrorModal();
      }
    } catch (error) {
      console.error("Error al iniciar sesión:", error);
      window.showPasswordErrorModal();
    }
  });
  function showStatus(message, type) {
    if (!loginStatus) return;
    loginStatus.textContent = message;
    loginStatus.classList.remove("hidden", "text-green-500", "text-red-500", "text-blue-500");
    switch (type) {
      case "success":
        loginStatus.classList.add("text-green-500");
        break;
      case "error":
        loginStatus.classList.add("text-red-500");
        break;
      case "info":
        loginStatus.classList.add("text-blue-500");
        break;
    }
  }
});
function extractRoleFromToken() {
  console.log("extractRoleFromToken llamada desde login.astro");
  const userJson = localStorage.getItem("user");
  if (userJson) {
    try {
      const user = JSON.parse(userJson);
      if (user.username && user.username.toLowerCase() === "ramon") {
        console.log("Usuario Ramon detectado en extractRoleFromToken de login.astro");
        return "Ramon";
      }
      if (user.role) {
        if (user.role === "gerente") {
          console.log("Rol gerente detectado, convirtiendo a Ramon");
          return "Ramon";
        }
        return user.role;
      }
    } catch (e) {
      console.error("Error al parsear usuario:", e);
    }
  }
  const explicitRole = localStorage.getItem("userRole");
  if (explicitRole) {
    if (explicitRole === "gerente") {
      return "Ramon";
    }
    return explicitRole;
  }
  return "usuario";
}
function getCurrentUserRole() {
  console.log("getCurrentUserRole llamada desde login.astro");
  const ramonFix = localStorage.getItem("ramonFix");
  if (ramonFix === "true") {
    console.log("Indicador ramonFix encontrado, retornando rol Ramon");
    return "Ramon";
  }
  return extractRoleFromToken();
}
function getStoredUser() {
  console.log("getStoredUser llamada desde login.astro");
  const userJson = localStorage.getItem("user");
  if (!userJson) {
    return null;
  }
  try {
    const user = JSON.parse(userJson);
    if (user.username && user.username.toLowerCase() === "ramon") {
      if (user.role !== "Ramon") {
        console.log("Corrigiendo rol de Ramon en getStoredUser de login.astro");
        user.role = "Ramon";
        localStorage.setItem("user", JSON.stringify(user));
        localStorage.setItem("userRole", "Ramon");
      }
    }
    return user;
  } catch (e) {
    console.error("Error al obtener usuario:", e);
    return null;
  }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxvZ2luLmFzdHJvIl0sInNvdXJjZXNDb250ZW50IjpbIi0tLVxuaW1wb3J0IExvZ2luTGF5b3V0IGZyb20gJy4uL2xheW91dHMvTG9naW5MYXlvdXQuYXN0cm8nO1xuaW1wb3J0IFBhc3N3b3JkRXJyb3JNb2RhbCBmcm9tICcuLi9jb21wb25lbnRzL21vZGFscy9QYXNzd29yZEVycm9yTW9kYWwnO1xuLS0tXG5cbjxMb2dpbkxheW91dCB0aXRsZT1cIkxvZ2luIC0gTWFzY2xldCBJbXBlcmlcIj5cbiAgPGRpdiBjbGFzcz1cIm1pbi1oLXNjcmVlbiBmbGV4IGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWNlbnRlciBiZy1ncmF5LTUwIHB5LTEyIHB4LTQgc206cHgtNiBsZzpweC04XCI+XG4gICAgPGRpdiBjbGFzcz1cIm1heC13LW1kIHctZnVsbCBzcGFjZS15LThcIj5cbiAgICAgIHsvKiBNb2RhbCBkZSBlcnJvciBkZSBjb250cmFzZcOxYSAqL31cbiAgICAgIDxQYXNzd29yZEVycm9yTW9kYWwgY2xpZW50Om9ubHk9XCJyZWFjdFwiIGlzT3Blbj17ZmFsc2V9IG9uQ2xvc2U9eygpID0+IHt9fSBpZD1cInBhc3N3b3JkRXJyb3JNb2RhbFwiIC8+XG4gICAgICA8ZGl2IGNsYXNzPVwiZmxleCBmbGV4LWNvbCBpdGVtcy1jZW50ZXJcIj5cbiAgICAgICAgPCEtLSBMb2dvIGdyYW5kZSAtLT4gICAgICAgIFxuICAgICAgICA8aW1nIHNyYz1cIi9pbWFnZXMvbG9nb19tYXNjbGV0LmpwZ1wiIGFsdD1cIkxvZ28gTWFzY2xldCBJbXBlcmlcIiBjbGFzcz1cInctNDggaC1hdXRvIG1iLTZcIj5cbiAgICAgICAgXG4gICAgICAgIDxoMiBjbGFzcz1cIm10LTIgdGV4dC1jZW50ZXIgdGV4dC0zeGwgZm9udC1leHRyYWJvbGQgdGV4dC1ncmF5LTkwMFwiPlxuICAgICAgICAgIEluaWNpYXIgc2VzacOzblxuICAgICAgICA8L2gyPlxuICAgICAgICA8cCBjbGFzcz1cIm10LTIgdGV4dC1jZW50ZXIgdGV4dC1zbSB0ZXh0LWdyYXktNjAwXCI+XG4gICAgICAgICAgQWNjZWRlIGEgbGEgcGxhdGFmb3JtYSBkZSBnZXN0acOzblxuICAgICAgICA8L3A+XG4gICAgICA8L2Rpdj5cbiAgICAgIDxkaXYgY2xhc3M9XCJtdC04IGJnLXdoaXRlIHB5LTggcHgtNCBzaGFkb3cgc206cm91bmRlZC1sZyBzbTpweC0xMFwiPlxuICAgICAgICA8Zm9ybSBpZD1cImxvZ2luRm9ybVwiIGNsYXNzPVwic3BhY2UteS02XCI+XG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJ1c2VybmFtZVwiIGNsYXNzPVwiYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwXCI+XG4gICAgICAgICAgICAgIFVzdWFyaW9cbiAgICAgICAgICAgIDwvbGFiZWw+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwibXQtMVwiPlxuICAgICAgICAgICAgICA8aW5wdXQgaWQ9XCJ1c2VybmFtZVwiIG5hbWU9XCJ1c2VybmFtZVwiIHR5cGU9XCJ0ZXh0XCIgcmVxdWlyZWQgY2xhc3M9XCJhcHBlYXJhbmNlLW5vbmUgYmxvY2sgdy1mdWxsIHB4LTMgcHktMiBib3JkZXIgYm9yZGVyLWdyYXktMzAwIHJvdW5kZWQtbWQgc2hhZG93LXNtIHBsYWNlaG9sZGVyLWdyYXktNDAwIGZvY3VzOm91dGxpbmUtbm9uZSBmb2N1czpyaW5nLWluZGlnby01MDAgZm9jdXM6Ym9yZGVyLWluZGlnby01MDAgc206dGV4dC1zbVwiIHZhbHVlPVwiYWRtaW5cIj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgPGRpdj5cbiAgICAgICAgICAgIDxsYWJlbCBmb3I9XCJwYXNzd29yZFwiIGNsYXNzPVwiYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSB0ZXh0LWdyYXktNzAwXCI+XG4gICAgICAgICAgICAgIENvbnRyYXNlw7FhXG4gICAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cIm10LTFcIj5cbiAgICAgICAgICAgICAgPGlucHV0IGlkPVwicGFzc3dvcmRcIiBuYW1lPVwicGFzc3dvcmRcIiB0eXBlPVwicGFzc3dvcmRcIiByZXF1aXJlZCBjbGFzcz1cImFwcGVhcmFuY2Utbm9uZSBibG9jayB3LWZ1bGwgcHgtMyBweS0yIGJvcmRlciBib3JkZXItZ3JheS0zMDAgcm91bmRlZC1tZCBzaGFkb3ctc20gcGxhY2Vob2xkZXItZ3JheS00MDAgZm9jdXM6b3V0bGluZS1ub25lIGZvY3VzOnJpbmctaW5kaWdvLTUwMCBmb2N1czpib3JkZXItaW5kaWdvLTUwMCBzbTp0ZXh0LXNtXCIgdmFsdWU9XCJhZG1pbjEyM1wiPlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgPC9kaXY+XG5cbiAgICAgICAgICA8ZGl2PlxuICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPVwic3VibWl0XCIgY2xhc3M9XCJ3LWZ1bGwgZmxleCBqdXN0aWZ5LWNlbnRlciBweS0yIHB4LTQgYm9yZGVyIGJvcmRlci10cmFuc3BhcmVudCByb3VuZGVkLW1kIHNoYWRvdy1zbSB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRleHQtd2hpdGUgYmctcHJpbWFyeSBob3ZlcjpiZy1wcmltYXJ5LzkwIGZvY3VzOm91dGxpbmUtbm9uZSBmb2N1czpyaW5nLTIgZm9jdXM6cmluZy1vZmZzZXQtMiBmb2N1czpyaW5nLXByaW1hcnlcIj5cbiAgICAgICAgICAgICAgSW5pY2lhciBzZXNpw7NuXG4gICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9mb3JtPlxuICAgICAgICBcbiAgICAgICAgPGRpdiBpZD1cImxvZ2luU3RhdHVzXCIgY2xhc3M9XCJtdC00IHRleHQtc20gaGlkZGVuXCI+PC9kaXY+XG4gICAgICAgIFxuICAgICAgICA8ZGl2IGNsYXNzPVwibXQtNlwiPlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJyZWxhdGl2ZVwiPlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cImFic29sdXRlIGluc2V0LTAgZmxleCBpdGVtcy1jZW50ZXJcIj5cbiAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cInctZnVsbCBib3JkZXItdCBib3JkZXItZ3JheS0zMDBcIj48L2Rpdj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cInJlbGF0aXZlIGZsZXgganVzdGlmeS1jZW50ZXIgdGV4dC1zbVwiPlxuICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cInB4LTIgYmctd2hpdGUgdGV4dC1ncmF5LTUwMFwiPlxuICAgICAgICAgICAgICAgIE1hc2NsZXQgSW1wZXJpXG4gICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbjwvTG9naW5MYXlvdXQ+XG5cbjxzY3JpcHQ+XG4gIC8vIEltcG9ydGFyIGVsIHNlcnZpY2lvIGRlIEFQSVxuICBpbXBvcnQgYXBpU2VydmljZSBmcm9tICcuLi9zZXJ2aWNlcy9hcGlTZXJ2aWNlJztcblxuICAvLyBEZWZpbmltb3MgdW5hIHZhcmlhYmxlIGdsb2JhbCBwYXJhIGVsIGVzdGFkbyBkZWwgbW9kYWxcbiAgd2luZG93LnNob3dQYXNzd29yZEVycm9yTW9kYWwgPSBmdW5jdGlvbigpIHtcbiAgICAvLyBBY2NlZGVyIGFsIGNvbXBvbmVudGUgUmVhY3QgZGlyZWN0YW1lbnRlIG1lZGlhbnRlIGV2ZW50b3MgcGVyc29uYWxpemFkb3NcbiAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudCgnc2hvdy1wYXNzd29yZC1lcnJvcicpKTtcbiAgfTtcbiAgXG4gIC8vIEZ1bmNpw7NuIHBhcmEgbWFuZWphciBlbCBpbmljaW8gZGUgc2VzacOzblxuICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgKCkgPT4ge1xuICAgIGNvbnN0IGxvZ2luRm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2dpbkZvcm0nKTtcbiAgICBcbiAgICAvLyBDcmVhciB1biBzY3JpcHQgcXVlIG1hbmVqZSBsYSBpbnRlcmFjY2nDs24gY29uIGVsIGNvbXBvbmVudGUgUmVhY3RcbiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICBzY3JpcHQudGV4dENvbnRlbnQgPSBgXG4gICAgICAvLyBFc3RhIGZ1bmNpw7NuIHNlIGVqZWN1dGFyw6EgY3VhbmRvIGVsIGNvbXBvbmVudGUgUmVhY3QgZXN0w6kgbGlzdG9cbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2FzdHJvOnBhZ2UtbG9hZCcsICgpID0+IHtcbiAgICAgICAgLy8gRXNjdWNoYXIgZWwgZXZlbnRvIHBlcnNvbmFsaXphZG8gcGFyYSBtb3N0cmFyIGVsIG1vZGFsXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3Nob3ctcGFzc3dvcmQtZXJyb3InLCAoKSA9PiB7XG4gICAgICAgICAgLy8gQnVzY2FyIGVsIGVsZW1lbnRvIG1vZGFsIHBvciBzdSBJRFxuICAgICAgICAgIGNvbnN0IG1vZGFsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Bhc3N3b3JkRXJyb3JNb2RhbCcpO1xuICAgICAgICAgIGlmIChtb2RhbCkge1xuICAgICAgICAgICAgLy8gRW52aWFyIG1lbnNhamUgYWwgY29tcG9uZW50ZSBSZWFjdCBwYXJhIGNhbWJpYXIgc3UgZXN0YWRvXG4gICAgICAgICAgICBjb25zdCBldmVudCA9IG5ldyBDdXN0b21FdmVudCgndXBkYXRlLW1vZGFsLXN0YXRlJywgeyBcbiAgICAgICAgICAgICAgZGV0YWlsOiB7IGlzT3BlbjogdHJ1ZSB9IFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBtb2RhbC5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgYDtcbiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgXG4gICAgbG9naW5Gb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIGFzeW5jIChlKSA9PiB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHVzZXJuYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzZXJuYW1lJykudmFsdWU7XG4gICAgICBjb25zdCBwYXNzd29yZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYXNzd29yZCcpLnZhbHVlO1xuICAgICAgXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFwaVNlcnZpY2UubG9naW4odXNlcm5hbWUsIHBhc3N3b3JkKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFZlcmlmaWNhciBsYSBlc3RydWN0dXJhIGRlIGxhIHJlc3B1ZXN0YSBwYXJhIG9idGVuZXIgZWwgdG9rZW5cbiAgICAgICAgY29uc3QgdG9rZW4gPSByZXNwb25zZS5kYXRhPy5hY2Nlc3NfdG9rZW4gfHwgcmVzcG9uc2UuYWNjZXNzX3Rva2VuO1xuICAgICAgICBcbiAgICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ0xvZ2luIGV4aXRvc28sIHRva2VuIHJlY2liaWRvOicsIHRva2VuKTtcbiAgICAgICAgICAvLyBHdWFyZGFyIGVsIHRva2VuIHkgcmVkaXJpZ2lyIGFsIGRhc2hib2FyZFxuICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd0b2tlbicsIHRva2VuKTtcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBHdWFyZGFyIGluZm8gZGVsIHVzdWFyaW8gc2kgZXN0w6EgZGlzcG9uaWJsZVxuICAgICAgICAgIGlmIChyZXNwb25zZS5kYXRhPy51c2VyIHx8IHJlc3BvbnNlLnVzZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IHVzZXJEYXRhID0gcmVzcG9uc2UuZGF0YT8udXNlciB8fCByZXNwb25zZS51c2VyO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBTT0xVQ0nDk04gTUVKT1JBREE6IENvcnJlZ2lyIGVsIHJvbCBwYXJhIFJhbW9uXG4gICAgICAgICAgICBpZiAodXNlckRhdGEudXNlcm5hbWUgJiYgdXNlckRhdGEudXNlcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3JhbW9uJykge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+UtCBVc3VhcmlvIFJhbW9uIGRldGVjdGFkbywgRk9SWkFORE8gcm9sIFJhbW9uJyk7XG4gICAgICAgICAgICAgIHVzZXJEYXRhLnJvbGUgPSAnUmFtb24nO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgLy8gVGFtYmnDqW4gZ3VhcmRhciBlbCByb2wgcG9yIHNlcGFyYWRvIHBhcmEgbWF5b3Igc2VndXJpZGFkXG4gICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd1c2VyUm9sZScsICdSYW1vbicpO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygn8J+UtCBSb2wgUmFtb24gZ3VhcmRhZG8gc2VwYXJhZGFtZW50ZSBwYXJhIG1heW9yIHNlZ3VyaWRhZCcpO1xuICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgLy8gQcOxYWRpciB1biBpbmRpY2Fkb3IgZXNwZWNpYWwgcGFyYSB2ZXJpZmljYWNpb25lcyBmdXR1cmFzXG4gICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdyYW1vbkZpeCcsICd0cnVlJyk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHVzZXJEYXRhLnJvbGUgPT09ICdnZXJlbnRlJykge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnUm9sIGdlcmVudGUgZGV0ZWN0YWRvLCBjb252aXJ0aWVuZG8gYSBSYW1vbicpO1xuICAgICAgICAgICAgICB1c2VyRGF0YS5yb2xlID0gJ1JhbW9uJztcbiAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXJSb2xlJywgJ1JhbW9uJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEd1YXJkYXIgZWwgdXN1YXJpbyBhY3R1YWxpemFkb1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3VzZXInLCBKU09OLnN0cmluZ2lmeSh1c2VyRGF0YSkpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBUYW1iacOpbiBndWFyZGFyIGVsIHJvbCBwb3Igc2VwYXJhZG8gcGFyYSBtYXlvciBzZWd1cmlkYWRcbiAgICAgICAgICAgIGlmICh1c2VyRGF0YS5yb2xlKSB7XG4gICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCd1c2VyUm9sZScsIHVzZXJEYXRhLnJvbGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICAvLyBSZWRpcmVjY2lvbmFyIGFsIGRhc2hib2FyZCBwcmluY2lwYWxcbiAgICAgICAgICBjb25zb2xlLmxvZygnUmVkaXJpZ2llbmRvIGEgbGEgcMOhZ2luYSBwcmluY2lwYWwgKGRhc2hib2FyZCknKTtcbiAgICAgICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9ICcvJztcbiAgICAgICAgICByZXR1cm47IC8vIEltcG9ydGFudGU6IHNhbGlyIGRlIGxhIGZ1bmNpw7NuIHBhcmEgZXZpdGFyIGVqZWN1dGFyIGPDs2RpZ28gZGVzcHXDqXMgZGUgbGEgcmVkaXJlY2Npw7NuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZGUgYXV0ZW50aWNhY2nDs246IE5vIHNlIGVuY29udHLDsyB0b2tlbiBlbiBsYSByZXNwdWVzdGE6JywgcmVzcG9uc2UpO1xuICAgICAgICAgIC8vIE1vc3RyYXIgZWwgbW9kYWwgY29uIGVsIHBlcnJvIGRlIFJhbW9uXG4gICAgICAgICAgd2luZG93LnNob3dQYXNzd29yZEVycm9yTW9kYWwoKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgYWwgaW5pY2lhciBzZXNpw7NuOicsIGVycm9yKTtcbiAgICAgICAgLy8gTW9zdHJhciBlbCBtb2RhbCBjb24gZWwgcGVycm8gZGUgUmFtb25cbiAgICAgICAgd2luZG93LnNob3dQYXNzd29yZEVycm9yTW9kYWwoKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICAvLyBGdW5jacOzbiBwYXJhIG1vc3RyYXIgbWVuc2FqZXMgZGUgZXN0YWRvXG4gICAgZnVuY3Rpb24gc2hvd1N0YXR1cyhtZXNzYWdlOiBzdHJpbmcsIHR5cGU6ICdzdWNjZXNzJyB8ICdlcnJvcicgfCAnaW5mbycpIHtcbiAgICAgIGlmICghbG9naW5TdGF0dXMpIHJldHVybjtcbiAgICAgIFxuICAgICAgbG9naW5TdGF0dXMudGV4dENvbnRlbnQgPSBtZXNzYWdlO1xuICAgICAgbG9naW5TdGF0dXMuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJywgJ3RleHQtZ3JlZW4tNTAwJywgJ3RleHQtcmVkLTUwMCcsICd0ZXh0LWJsdWUtNTAwJyk7XG4gICAgICBcbiAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICBjYXNlICdzdWNjZXNzJzpcbiAgICAgICAgICBsb2dpblN0YXR1cy5jbGFzc0xpc3QuYWRkKCd0ZXh0LWdyZWVuLTUwMCcpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdlcnJvcic6XG4gICAgICAgICAgbG9naW5TdGF0dXMuY2xhc3NMaXN0LmFkZCgndGV4dC1yZWQtNTAwJyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ2luZm8nOlxuICAgICAgICAgIGxvZ2luU3RhdHVzLmNsYXNzTGlzdC5hZGQoJ3RleHQtYmx1ZS01MDAnKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIC8vIEZ1bmNpb25lcyBhZ3JlZ2FkYXMgcGFyYSBlbCB0ZXN0IGRlIHBlcm1pc29zIGRlIFJhbW9uXG4gIFxuICAvKipcbiAgICogRXh0cmFlIGVsIHJvbCBkZWwgdG9rZW4gSldUXG4gICAqIEByZXR1cm5zIFJvbCBkZWwgdXN1YXJpbyBvICd1c3VhcmlvJyBzaSBubyBzZSBwdWVkZSBleHRyYWVyXG4gICAqL1xuICBmdW5jdGlvbiBleHRyYWN0Um9sZUZyb21Ub2tlbigpIHtcbiAgICBjb25zb2xlLmxvZygnZXh0cmFjdFJvbGVGcm9tVG9rZW4gbGxhbWFkYSBkZXNkZSBsb2dpbi5hc3RybycpO1xuICAgIFxuICAgIC8vIFZlcmlmaWNhciBwcmltZXJvIHBvciBsb2NhbFN0b3JhZ2UgKHByaW9yaWRhZCBtw6FzIGFsdGEpXG4gICAgY29uc3QgdXNlckpzb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcicpO1xuICAgIGlmICh1c2VySnNvbikge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdXNlciA9IEpTT04ucGFyc2UodXNlckpzb24pO1xuICAgICAgICBcbiAgICAgICAgLy8gVmVyaWZpY2FjacOzbiBlc3BlY2lhbCBwYXJhIFJhbW9uXG4gICAgICAgIGlmICh1c2VyLnVzZXJuYW1lICYmIHVzZXIudXNlcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3JhbW9uJykge1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdVc3VhcmlvIFJhbW9uIGRldGVjdGFkbyBlbiBleHRyYWN0Um9sZUZyb21Ub2tlbiBkZSBsb2dpbi5hc3RybycpO1xuICAgICAgICAgIHJldHVybiAnUmFtb24nO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBTaSBoYXkgdW4gcm9sIGRlZmluaWRvLCB1c2FybG9cbiAgICAgICAgaWYgKHVzZXIucm9sZSkge1xuICAgICAgICAgIC8vIENvbnZlcnRpciAnZ2VyZW50ZScgYSAnUmFtb24nIHBvciBjb21wYXRpYmlsaWRhZFxuICAgICAgICAgIGlmICh1c2VyLnJvbGUgPT09ICdnZXJlbnRlJykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1JvbCBnZXJlbnRlIGRldGVjdGFkbywgY29udmlydGllbmRvIGEgUmFtb24nKTtcbiAgICAgICAgICAgIHJldHVybiAnUmFtb24nO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdXNlci5yb2xlO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGFsIHBhcnNlYXIgdXN1YXJpbzonLCBlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLy8gVmVyaWZpY2FyIHBvciByb2wgZXhwbMOtY2l0b1xuICAgIGNvbnN0IGV4cGxpY2l0Um9sZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCd1c2VyUm9sZScpO1xuICAgIGlmIChleHBsaWNpdFJvbGUpIHtcbiAgICAgIGlmIChleHBsaWNpdFJvbGUgPT09ICdnZXJlbnRlJykge1xuICAgICAgICByZXR1cm4gJ1JhbW9uJzsgLy8gQ29tcGF0aWJpbGlkYWRcbiAgICAgIH1cbiAgICAgIHJldHVybiBleHBsaWNpdFJvbGU7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiAndXN1YXJpbyc7IC8vIFZhbG9yIHBvciBkZWZlY3RvXG4gIH1cbiAgXG4gIC8qKlxuICAgKiBPYnRpZW5lIGVsIHJvbCBkZWwgdXN1YXJpbyBhY3R1YWxcbiAgICogQHJldHVybnMgUm9sIGRlbCB1c3VhcmlvIGFjdHVhbFxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0Q3VycmVudFVzZXJSb2xlKCkge1xuICAgIGNvbnNvbGUubG9nKCdnZXRDdXJyZW50VXNlclJvbGUgbGxhbWFkYSBkZXNkZSBsb2dpbi5hc3RybycpO1xuICAgIFxuICAgIC8vIFZlcmlmaWNhciBlbCBpbmRpY2Fkb3IgZXNwZWNpYWwgZGUgUmFtb25cbiAgICBjb25zdCByYW1vbkZpeCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdyYW1vbkZpeCcpO1xuICAgIGlmIChyYW1vbkZpeCA9PT0gJ3RydWUnKSB7XG4gICAgICBjb25zb2xlLmxvZygnSW5kaWNhZG9yIHJhbW9uRml4IGVuY29udHJhZG8sIHJldG9ybmFuZG8gcm9sIFJhbW9uJyk7XG4gICAgICByZXR1cm4gJ1JhbW9uJztcbiAgICB9XG4gICAgXG4gICAgLy8gVXNhciBleHRyYWN0Um9sZUZyb21Ub2tlbiBjb21vIGZhbGxiYWNrXG4gICAgcmV0dXJuIGV4dHJhY3RSb2xlRnJvbVRva2VuKCk7XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBPYnRpZW5lIGVsIG9iamV0byBkZSB1c3VhcmlvIGFsbWFjZW5hZG9cbiAgICogQHJldHVybnMgRWwgb2JqZXRvIGRlIHVzdWFyaW8gbyBudWxsIHNpIG5vIGV4aXN0ZVxuICAgKi9cbiAgZnVuY3Rpb24gZ2V0U3RvcmVkVXNlcigpIHtcbiAgICBjb25zb2xlLmxvZygnZ2V0U3RvcmVkVXNlciBsbGFtYWRhIGRlc2RlIGxvZ2luLmFzdHJvJyk7XG4gICAgXG4gICAgY29uc3QgdXNlckpzb24gPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgndXNlcicpO1xuICAgIGlmICghdXNlckpzb24pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXNlciA9IEpTT04ucGFyc2UodXNlckpzb24pO1xuICAgICAgXG4gICAgICAvLyBWZXJpZmljYWNpw7NuIGVzcGVjaWFsIHBhcmEgUmFtb25cbiAgICAgIGlmICh1c2VyLnVzZXJuYW1lICYmIHVzZXIudXNlcm5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3JhbW9uJykge1xuICAgICAgICBpZiAodXNlci5yb2xlICE9PSAnUmFtb24nKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ0NvcnJpZ2llbmRvIHJvbCBkZSBSYW1vbiBlbiBnZXRTdG9yZWRVc2VyIGRlIGxvZ2luLmFzdHJvJyk7XG4gICAgICAgICAgdXNlci5yb2xlID0gJ1JhbW9uJztcbiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcicsIEpTT04uc3RyaW5naWZ5KHVzZXIpKTtcbiAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlclJvbGUnLCAnUmFtb24nKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICByZXR1cm4gdXNlcjtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBhbCBvYnRlbmVyIHVzdWFyaW86JywgZSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbjwvc2NyaXB0PiJdLCJtYXBwaW5ncyI6IkFBcUVFLE9BQU8sZ0JBQWdCO0FBR3ZCLE9BQU8seUJBQXlCLFdBQVc7QUFFekMsV0FBUyxjQUFjLElBQUksWUFBWSxxQkFBcUIsQ0FBQztBQUMvRDtBQUdBLFNBQVMsaUJBQWlCLG9CQUFvQixNQUFNO0FBQ2xELFFBQU0sWUFBWSxTQUFTLGVBQWUsV0FBVztBQUdyRCxRQUFNLFNBQVMsU0FBUyxjQUFjLFFBQVE7QUFDOUMsU0FBTyxjQUFjOzs7Ozs7Ozs7Ozs7Ozs7OztBQWlCckIsV0FBUyxLQUFLLFlBQVksTUFBTTtBQUVoQyxZQUFVLGlCQUFpQixVQUFVLE9BQU8sTUFBTTtBQUNoRCxNQUFFLGVBQWU7QUFFakIsVUFBTSxXQUFXLFNBQVMsZUFBZSxVQUFVLEVBQUU7QUFDckQsVUFBTSxXQUFXLFNBQVMsZUFBZSxVQUFVLEVBQUU7QUFFckQsUUFBSTtBQUNGLFlBQU0sV0FBVyxNQUFNLFdBQVcsTUFBTSxVQUFVLFFBQVE7QUFHMUQsWUFBTSxRQUFRLFNBQVMsTUFBTSxnQkFBZ0IsU0FBUztBQUV0RCxVQUFJLE9BQU87QUFDVCxnQkFBUSxJQUFJLGtDQUFrQyxLQUFLO0FBRW5ELHFCQUFhLFFBQVEsU0FBUyxLQUFLO0FBR25DLFlBQUksU0FBUyxNQUFNLFFBQVEsU0FBUyxNQUFNO0FBQ3hDLGdCQUFNLFdBQVcsU0FBUyxNQUFNLFFBQVEsU0FBUztBQUdqRCxjQUFJLFNBQVMsWUFBWSxTQUFTLFNBQVMsWUFBWSxNQUFNLFNB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