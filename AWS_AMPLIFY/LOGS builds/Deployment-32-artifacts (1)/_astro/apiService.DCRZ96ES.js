import{c as l}from"./vendor.BAk4NxX6.js";import{e as $,A as h,i as p,a as U,b as R,T as f}from"./apiConfigAdapter.B0N4Zv2p.js";let E=$;console.log(`[ApiService] Entorno: ${E}`);console.log(`[ApiService] API configurada para conectarse a: ${h}`);console.log(p?"[ApiService] Ejecutando en modo PRODUCCIÓN":"[ApiService] Ejecutando en modo LOCAL");let d=h;const n=l.create({baseURL:d,timeout:R,headers:U});n.interceptors.request.use(e=>{e.url;const a=`${e.baseURL||""}${e.url||""}`;if(a.includes("/api/v1/api/v1/")){console.log(`[API] Corrigiendo URL duplicada: ${a}`);const r=a.replace("/api/v1/api/v1/","/api/v1/"),o=e.baseURL||"";e.url=r.replace(o,""),console.log(`[API] URL corregida: ${o}${e.url}`)}return typeof localStorage<"u"&&localStorage.getItem(f)&&(e.headers.Authorization=`Bearer ${localStorage.getItem(f)}`),e.withCredentials=!1,p&&(e.url&&e.url.startsWith("http:")&&(e.url=e.url.replace("http:","https:")),e.baseURL&&e.baseURL.startsWith("http:")&&(e.baseURL=e.baseURL.replace("http:","https:")),console.log(`[PROD] URL final: ${e.baseURL}${e.url}`)),e},e=>Promise.reject(e));n.interceptors.request.use(e=>{if(typeof window<"u"&&window.localStorage)try{const a=localStorage.getItem(f);a?(e.headers.Authorization=`Bearer ${a}`,console.log("Usando token JWT para autenticación")):console.warn("No se encontró token en localStorage")}catch(a){console.warn("No se pudo acceder a localStorage:",a)}return e},e=>Promise.reject(e));function m(e,a=!1){d=e,n.defaults.baseURL=e,console.log(`API configurada con URL base: ${e}`),console.log(`Uso de datos simulados: ${a?"SÍ":"NO"}`)}async function g(e){try{const a=e.startsWith("/")?e:`/${e}`;let r=a;const o=d.includes("/api/v1");!r.startsWith("/api/v1")&&!o&&(r=`/api/v1${a}`,console.log(`Añadiendo prefijo a endpoint: ${a} -> ${r}`));const t=!r.includes("?")&&r.endsWith("/")?r.slice(0,-1):r;p||console.log(`Realizando petición GET a: ${t}`);const s=await n.get(t);return s.data===void 0||s.data===null?Array.isArray(s.data)?[]:{}:s.data}catch(a){if(l.isAxiosError(a)?console.error(`❌ Error en petición GET a ${e}: ${a.message} (${a.response?.status||"sin status"})`):console.error(`❌ Error no relacionado con Axios en ${e}: ${a}`),l.isAxiosError(a)&&a.response?.status===404){const r=a.config?.url||"",o=a.config?.baseURL?`${a.config.baseURL}${r}`:r;if(p){if(o.includes("://"))try{const t=new URL(o),s=t.pathname+t.search;try{return(await l.get(s,{baseURL:"",headers:a.config?.headers})).data}catch{}}catch{}if(r.includes("//")||r.includes("api/api")||r.includes("/api/v1")&&e.includes("/api/v1")){let t=e.replace(/api\/api/g,"api");if(t=t.replace(/\/api\/v1\/api\/v1/g,"/api/v1"),t=t.replace(/\/\/api\/v1/g,"/api/v1"),t!==e)try{return(await n.get(t)).data}catch{}}if(a.config?.baseURL)try{let t=r;return t.startsWith("/api")||(t=`/api/v1/${t.startsWith("/")?t.substring(1):t}`),(await l.get(t,{baseURL:""})).data}catch{}}if(e.includes("list")||e.includes("all")||e.includes("explotacions")||e.includes("animales"))return[]}return{}}}async function y(e,a){try{const r=e.startsWith("/")?e:`/${e}`;return(await n.post(r,a)).data}catch(r){throw console.error(`Error en petición POST a ${e}:`,r),r}}async function A(e,a){try{const r=e.startsWith("/")?e:`/${e}`;return(await n.put(r,a)).data}catch(r){throw console.error(`Error en petición PUT a ${e}:`,r),r}}async function v(e,a){try{const r=e.startsWith("/")?e:`/${e}`;return console.log(`Realizando petición PATCH a ${d}${r}`),console.log("Datos enviados:",a),(await n.patch(r,a)).data}catch(r){throw console.error(`Error en petición PATCH a ${e}:`,r),r}}async function L(e){try{const a=e.startsWith("/")?e:`/${e}`;return(await n.delete(a)).data}catch(a){throw console.error(`Error en petición DELETE a ${e}:`,a),a}}async function w(){try{return typeof window<"u"&&window.localStorage?!!localStorage.getItem("token"):!1}catch(e){return console.error("Error al verificar autenticación:",e),!1}}async function b(){try{return await w()?await g("/users/me"):null}catch(e){return console.error("Error al obtener información del usuario:",e),null}}async function S(e,a){try{const r=new URLSearchParams;r.append("username",e),r.append("password",a),r.append("grant_type","password");const o="/auth/login";let t=o,s=!1,c="";if(typeof window<"u"){const i=window.location.hostname;i==="localhost"||i==="127.0.0.1"||/^192\.168\./.test(i)||/^10\./.test(i)||/^172\.(1[6-9]|2[0-9]|3[0-1])/.test(i)?(s=!0,c="http://127.0.0.1:8000/api/v1",t="/auth/login",console.log(`Realizando login a: ${c}${t}`)):console.log(p?`Realizando login a: /api/v1${o}`:`Realizando login a: ${n.defaults.baseURL}${o}`)}else console.log(`Realizando login a: ${n.defaults.baseURL}${o}`);let u;return s?u=await l.create({baseURL:c,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).post(t,r):u=await n.post(o,r,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}),typeof window<"u"&&window.localStorage&&u.data.access_token&&(localStorage.setItem("token",u.data.access_token),console.log("Token guardado correctamente")),u}catch(r){throw console.error("Error al iniciar sesión:",r),r}}function P(){return d}const k={get:g,post:y,put:A,patch:v,del:L,isAuthenticated:w,getUserInfo:b,login:S,configureApi:m,getBaseUrl:P};export{k as a,S as l};
