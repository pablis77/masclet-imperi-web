=== DIAGN√ìSTICO DEL SISTEMA DE ROLES PARA RAMON ===


==== ANALIZANDO: Servicio de roles (frontend/src/services/roleService.ts) ====
  ‚úÖ Archivo encontrado (10102 bytes)
  ‚úÖ Funci√≥n encontrada: extractRoleFromToken - Extracci√≥n de rol del token JWT
  --- C√≥digo relevante (primeras l√≠neas) ---
  export function extractRoleFromToken(): UserRole {
    try {
      const token = getToken();
      if (!token) {
        console.warn('No hay token JWT disponible');
        return 'usuario';
      }
      // Decodificar el token JWT
      const decoded = jwtDecode<{ role?: string; username?: string; sub?: string }>(token);
      console.log('Token decodificado:', decoded);
      // IMPORTANTE: Verificaci√≥n de usuario Ramon tiene prioridad m√°xima
      // Primero verificamos por username y sub (identificadores principales)
      // Verificaci√≥n espec√≠fica para Ramon - M√ÅXIMA PRIORIDAD
      if (decoded.username && decoded.username.toLowerCase() === 'ramon') {
        console.log('‚≠ê USUARIO RAMON DETECTADO por username, asignando rol Ramon');...
  --- Fin del c√≥digo relevante ---
  ‚ùå Funci√≥n NO encontrada: getCurrentUserRole
  ‚ùå Funci√≥n NO encontrada: login
  ‚ùå Funci√≥n NO encontrada: getStoredUser

  --- Buscando patrones de problemas ---
  ‚úÖ No se encontr√≥ el patr√≥n: Problema: Se est√° asignando rol "administrador" cuando sub o username es "admin"
  ‚ö†Ô∏è PATR√ìN DETECTADO: Comprobaci√≥n de usuario Ramon
  --- L√≠neas con el patr√≥n ---
  export type UserRole = 'administrador' | 'Ramon' | 'editor' | 'usuario';
  'Ramon': 3,
  'Ramon': [
  // IMPORTANTE: Verificaci√≥n de usuario Ramon tiene prioridad m√°xima
  // Verificaci√≥n espec√≠fica para Ramon - M√ÅXIMA PRIORIDAD
  if (decoded.username && decoded.username.toLowerCase() === 'ramon') {
  console.log('‚≠ê USUARIO RAMON DETECTADO por username, asignando rol Ramon');
  return 'Ramon';
  if (decoded.sub && decoded.sub.toLowerCase() === 'ramon') {
  console.log('‚≠ê USUARIO RAMON DETECTADO por sub, asignando rol Ramon');
  return 'Ramon';
  if (rolePart === 'GERENTE' || rolePart === 'RAMON') {
  console.log('Mapeando GERENTE/RAMON a Ramon');
  return 'Ramon';
  if (['administrador', 'Ramon', 'editor', 'usuario'].includes(decoded.role)) {
  console.log('Convertiendo gerente a Ramon');
  return 'Ramon';
  if (decoded.sub === 'ramon' || decoded.sub === 'Ramon') {
  console.log('Usuario Ramon detectado en sub, asignando rol Ramon');
  return 'Ramon';
  if (storedRole && ['administrador', 'Ramon', 'editor', 'usuario'].includes(storedRole)) {
  if (rolePart === 'GERENTE') return 'Ramon';
  ['administrador', 'Ramon', 'editor', 'usuario'].includes(user.role)) {
  if (user.username === 'ramon') return 'Ramon';
  ‚ö†Ô∏è PATR√ìN DETECTADO: Compatibilidad con rol "gerente"
  --- L√≠neas con el patr√≥n ---
  if (rolePart === 'GERENTE' || rolePart === 'RAMON') {
  console.log('Mapeando GERENTE/RAMON a Ramon');
  if (decoded.role === 'gerente') {
  console.log('Convertiendo gerente a Ramon');
  if (rolePart === 'GERENTE') return 'Ramon';
  ‚úÖ No se encontr√≥ el patr√≥n: Almacenamiento del usuario en localStorage


==== ANALIZANDO: Servicio de autenticaci√≥n (frontend/src/services/authService.ts) ====
  ‚úÖ Archivo encontrado (15987 bytes)
  ‚ùå Funci√≥n NO encontrada: extractRoleFromToken
  ‚úÖ Funci√≥n encontrada: getCurrentUserRole - Obtenci√≥n del rol del usuario actual
  --- C√≥digo relevante (primeras l√≠neas) ---
  export const getCurrentUserRole = (): UserRole => {
    // Para el modo de prueba, intentar obtener el rol seleccionado en login
    if (typeof window !== 'undefined') {
      // Primero verificar si hay un rol expl√≠cito guardado en localStorage
      let storedRole = localStorage.getItem('userRole');
      if (storedRole && (['administrador', 'Ramon', 'editor', 'usuario'].includes(storedRole) || storedRole === 'gerente')) {
        // Convertir 'gerente' a 'Ramon' para compatibilidad con c√≥digo antiguo
        if (storedRole === 'gerente') {
          console.log('Convertiendo rol gerente a Ramon para compatibilidad');
          localStorage.setItem('userRole', 'Ramon');
          storedRole = 'Ramon';
        }
        console.log(`Usando rol guardado: ${storedRole}`);
        return storedRole as UserRole;
      }...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: login - Proceso de inicio de sesi√≥n
  --- C√≥digo relevante (primeras l√≠neas) ---
  export const login = async ({ username, password }: LoginRequest): Promise<LoginResponse> => {
    try {
      if (!username || !password) {
        throw new Error('Usuario y contrase√±a son obligatorios');
      }
      console.log(`Intentando iniciar sesi√≥n con usuario: ${username}`);
      // Crear los datos en formato URLEncoded como espera el backend OAuth2
      const formData = new URLSearchParams();
      formData.append('username', username);
      formData.append('password', password);
      formData.append('grant_type', 'password');
      // Configurar cabeceras para enviar datos en formato correcto
      const config = {
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: getStoredUser - Obtenci√≥n del usuario almacenado
  --- C√≥digo relevante (primeras l√≠neas) ---
  export function getStoredUser(): User | null {
    if (typeof window === 'undefined') {
      return null; // No hay usuario en el servidor
    }
    try {
      const userJson = localStorage.getItem('user');
      if (!userJson) {
        console.warn('No se encontr√≥ informaci√≥n de usuario en localStorage');
        return null;
      }
      const user = JSON.parse(userJson) as User;
      // Asegurarse que el usuario tiene un rol v√°lido
      if (!user.role) {
        // Si el usuario no tiene rol, asumimos que es 'usuario' normal
        console.warn('Usuario sin rol definido, asignando rol por defecto');...
  --- Fin del c√≥digo relevante ---

  --- Buscando patrones de problemas ---
  ‚úÖ No se encontr√≥ el patr√≥n: Problema: Se est√° asignando rol "administrador" cuando sub o username es "admin"
  ‚ö†Ô∏è PATR√ìN DETECTADO: Comprobaci√≥n de usuario Ramon
  --- L√≠neas con el patr√≥n ---
  export type UserRole = 'administrador' | 'Ramon' | 'editor' | 'usuario';
  // Verificar si el usuario es admin o Ramon (antes 'gerente') para compatibilidad
  if (storedRole && (['administrador', 'Ramon', 'editor', 'usuario'].includes(storedRole) || storedRole === 'gerente')) {
  // Convertir 'gerente' a 'Ramon' para compatibilidad con c√≥digo antiguo
  console.log('Convertiendo rol gerente a Ramon para compatibilidad');
  localStorage.setItem('userRole', 'Ramon');
  storedRole = 'Ramon';
  if (testRole && (['administrador', 'Ramon', 'editor', 'usuario'].includes(testRole) || testRole === 'gerente')) {
  // Convertir 'gerente' a 'Ramon' para compatibilidad con c√≥digo antiguo
  console.log('Convertiendo rol gerente a Ramon para compatibilidad');
  localStorage.setItem('user_role', 'Ramon');
  testRole = 'Ramon';
  if (rolePart === 'GERENTE') return 'Ramon';
  if (['administrador', 'Ramon', 'editor', 'usuario'].includes(user.role)) {
  } else if (user.username === 'ramon') {
  return 'Ramon';
  case 'Ramon':
  // Guardar datos del usuario con ajuste especial para Ramon
  // IMPORTANTE: Verificar si es Ramon y ajustar el rol
  if (username.toLowerCase() === 'ramon') {
  console.log('CORRECCI√ìN AUTOM√ÅTICA: Usuario Ramon detectado, forzando rol Ramon');
  data.user.role = 'Ramon';
  console.log('CORRECCI√ìN AUTOM√ÅTICA: Rol gerente detectado, convirtiendo a Ramon');
  data.user.role = 'Ramon';
  ‚ö†Ô∏è PATR√ìN DETECTADO: Compatibilidad con rol "gerente"
  --- L√≠neas con el patr√≥n ---
  // Verificar si el usuario es admin o Ramon (antes 'gerente') para compatibilidad
  if (storedRole && (['administrador', 'Ramon', 'editor', 'usuario'].includes(storedRole) || storedRole === 'gerente')) {
  // Convertir 'gerente' a 'Ramon' para compatibilidad con c√≥digo antiguo
  if (storedRole === 'gerente') {
  console.log('Convertiendo rol gerente a Ramon para compatibilidad');
  if (testRole && (['administrador', 'Ramon', 'editor', 'usuario'].includes(testRole) || testRole === 'gerente')) {
  // Convertir 'gerente' a 'Ramon' para compatibilidad con c√≥digo antiguo
  if (testRole === 'gerente') {
  console.log('Convertiendo rol gerente a Ramon para compatibilidad');
  if (rolePart === 'GERENTE') return 'Ramon';
  } else if (data.user.role === 'gerente') {
  console.log('CORRECCI√ìN AUTOM√ÅTICA: Rol gerente detectado, convirtiendo a Ramon');
  ‚ö†Ô∏è PATR√ìN DETECTADO: Almacenamiento del usuario en localStorage
  --- L√≠neas con el patr√≥n ---
  localStorage.setItem('user', JSON.stringify(user));
  localStorage.setItem('user', JSON.stringify(data.user));


==== ANALIZANDO: Utilidades de autenticaci√≥n (frontend/src/middlewares/authUtils.ts) ====
  ‚úÖ Archivo encontrado (6120 bytes)
  ‚úÖ Funci√≥n encontrada: extractRoleFromToken - Extracci√≥n de rol del token JWT
  --- C√≥digo relevante (primeras l√≠neas) ---
  export function extractRoleFromToken(): UserRole {
    console.log('extractRoleFromToken llamada desde authUtils (proxy)');
    // Verificar si es Ramon primero
    try {
      if (typeof window !== 'undefined') {
        const userJson = localStorage.getItem('user');
        if (userJson) {
          const user = JSON.parse(userJson);
          if (user.username && user.username.toLowerCase() === 'ramon') {
            console.log('Usuario Ramon detectado en extractRoleFromToken (authUtils)');
            return 'Ramon';
          }
        }
      }
    } catch (e) {...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: getCurrentUserRole - Obtenci√≥n del rol del usuario actual
  --- C√≥digo relevante (primeras l√≠neas) ---
  getCurrentUserRole();
    // El administrador tiene acceso a todo
    if (userRole === 'administrador') {
      return true;
    }
    // Verificar acceso para cada patr√≥n de ruta
    for (const [routePattern, allowedRoles] of Object.entries(protectedRoutes)) {
      if (route.startsWith(routePattern) && allowedRoles.includes(userRole)) {
        return true;
      }
    }
    return false;
    */
  };
  /**...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: login - Proceso de inicio de sesi√≥n
  --- C√≥digo relevante (primeras l√≠neas) ---
  export function login(credentials: any): Promise<any> {
    console.log('login llamada desde authUtils (proxy)');
    // Si es usuario Ramon, asegurar que tenga rol Ramon
    if (credentials.username && credentials.username.toLowerCase() === 'ramon') {
      console.log('Asignando rol Ramon expl√≠citamente desde authUtils');
      setTimeout(() => {
        try {
          if (typeof window !== 'undefined') {
            const userJson = localStorage.getItem('user');
            if (userJson) {
              const user = JSON.parse(userJson);
              user.role = 'Ramon';
              localStorage.setItem('user', JSON.stringify(user));
              localStorage.setItem('userRole', 'Ramon');
              console.log('Rol Ramon asignado correctamente desde authUtils');...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: getStoredUser - Obtenci√≥n del usuario almacenado
  --- C√≥digo relevante (primeras l√≠neas) ---
  export function getStoredUser(): any {
    console.log('getStoredUser llamada desde authUtils (proxy)');
    try {
      if (typeof window !== 'undefined') {
        const userJson = localStorage.getItem('user');
        if (userJson) {
          const user = JSON.parse(userJson);
          // Verificar si es Ramon y corregir rol si es necesario
          if (user.username && user.username.toLowerCase() === 'ramon' && user.role !== 'Ramon') {
            console.log('Corrigiendo rol de Ramon en getStoredUser (authUtils)');
            user.role = 'Ramon';
            localStorage.setItem('user', JSON.stringify(user));
          }
          return user;
        }...
  --- Fin del c√≥digo relevante ---

  --- Buscando patrones de problemas ---
  ‚úÖ No se encontr√≥ el patr√≥n: Problema: Se est√° asignando rol "administrador" cuando sub o username es "admin"
  ‚ö†Ô∏è PATR√ìN DETECTADO: Comprobaci√≥n de usuario Ramon
  --- L√≠neas con el patr√≥n ---
  '/dashboard': ['administrador', 'Ramon'],
  // Nota: El backend sigue usando 'gerente', el frontend usa 'Ramon'
  '/users': ['administrador', 'Ramon'],
  '/animals': ['administrador', 'Ramon', 'editor', 'usuario'],
  '/animals/create': ['administrador', 'Ramon'],
  '/animals/edit': ['administrador', 'Ramon', 'editor'],
  '/explotacions': ['administrador', 'Ramon', 'editor', 'usuario'],
  '/explotacions/create': ['administrador', 'Ramon'],
  '/explotacions/edit': ['administrador', 'Ramon', 'editor'],
  // Verificar si es Ramon primero
  if (user.username && user.username.toLowerCase() === 'ramon') {
  console.log('Usuario Ramon detectado en extractRoleFromToken (authUtils)');
  return 'Ramon';
  // Si es usuario Ramon, asegurar que tenga rol Ramon
  if (credentials.username && credentials.username.toLowerCase() === 'ramon') {
  console.log('Asignando rol Ramon expl√≠citamente desde authUtils');
  user.role = 'Ramon';
  localStorage.setItem('userRole', 'Ramon');
  console.log('Rol Ramon asignado correctamente desde authUtils');
  console.error('Error al asignar rol Ramon desde authUtils:', e);
  user: { username: credentials.username, role: credentials.username.toLowerCase() === 'ramon' ? 'Ramon' : 'usuario' }
  // Verificar si es Ramon y corregir rol si es necesario
  if (user.username && user.username.toLowerCase() === 'ramon' && user.role !== 'Ramon') {
  console.log('Corrigiendo rol de Ramon en getStoredUser (authUtils)');
  user.role = 'Ramon';
  ‚ö†Ô∏è PATR√ìN DETECTADO: Compatibilidad con rol "gerente"
  --- L√≠neas con el patr√≥n ---
  // Nota: El backend sigue usando 'gerente', el frontend usa 'Ramon'
  case 'gerente':
  ‚ö†Ô∏è PATR√ìN DETECTADO: Almacenamiento del usuario en localStorage
  --- L√≠neas con el patr√≥n ---
  localStorage.setItem('user', JSON.stringify(user));
  localStorage.setItem('user', JSON.stringify(user));


==== ANALIZANDO: P√°gina de login (frontend/src/pages/login.astro) ====
  ‚úÖ Archivo encontrado (10601 bytes)
  ‚úÖ Funci√≥n encontrada: extractRoleFromToken - Extracci√≥n de rol del token JWT
  --- C√≥digo relevante (primeras l√≠neas) ---
  function extractRoleFromToken() {
      console.log('extractRoleFromToken llamada desde login.astro');
      // Verificar primero por localStorage (prioridad m√°s alta)
      const userJson = localStorage.getItem('user');
      if (userJson) {
        try {
          const user = JSON.parse(userJson);
          // Verificaci√≥n especial para Ramon
          if (user.username && user.username.toLowerCase() === 'ramon') {
            console.log('Usuario Ramon detectado en extractRoleFromToken de login.astro');
            return 'Ramon';
          }
          // Si hay un rol definido, usarlo
          if (user.role) {
            // Convertir 'gerente' a 'Ramon' por compatibilidad...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: getCurrentUserRole - Obtenci√≥n del rol del usuario actual
  --- C√≥digo relevante (primeras l√≠neas) ---
  function getCurrentUserRole() {
      console.log('getCurrentUserRole llamada desde login.astro');
      // Verificar el indicador especial de Ramon
      const ramonFix = localStorage.getItem('ramonFix');
      if (ramonFix === 'true') {
        console.log('Indicador ramonFix encontrado, retornando rol Ramon');
        return 'Ramon';
      }
      // Usar extractRoleFromToken como fallback
      return extractRoleFromToken();
    }
    /**
     * Obtiene el objeto de usuario almacenado
     * @returns El objeto de usuario o null si no existe
     */...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: login - Proceso de inicio de sesi√≥n
  --- C√≥digo relevante (primeras l√≠neas) ---
  const loginForm = document.getElementById('loginForm');
      // Crear un script que maneje la interacci√≥n con el componente React
      const script = document.createElement('script');
      script.textContent = `
        // Esta funci√≥n se ejecutar√° cuando el componente React est√© listo
        document.addEventListener('astro:page-load', () => {
          // Escuchar el evento personalizado para mostrar el modal
          document.addEventListener('show-password-error', () => {
            // Buscar el elemento modal por su ID
            const modal = document.getElementById('passwordErrorModal');
            if (modal) {
              // Enviar mensaje al componente React para cambiar su estado
              const event = new CustomEvent('update-modal-state', { 
                detail: { isOpen: true } 
              });...
  --- Fin del c√≥digo relevante ---
  ‚úÖ Funci√≥n encontrada: getStoredUser - Obtenci√≥n del usuario almacenado
  --- C√≥digo relevante (primeras l√≠neas) ---
  function getStoredUser() {
      console.log('getStoredUser llamada desde login.astro');
      const userJson = localStorage.getItem('user');
      if (!userJson) {
        return null;
      }
      try {
        const user = JSON.parse(userJson);
        // Verificaci√≥n especial para Ramon
        if (user.username && user.username.toLowerCase() === 'ramon') {
          if (user.role !== 'Ramon') {
            console.log('Corrigiendo rol de Ramon en getStoredUser de login.astro');
            user.role = 'Ramon';
            localStorage.setItem('user', JSON.stringify(user));
            localStorage.setItem('userRole', 'Ramon');...
  --- Fin del c√≥digo relevante ---

  --- Buscando patrones de problemas ---
  ‚úÖ No se encontr√≥ el patr√≥n: Problema: Se est√° asignando rol "administrador" cuando sub o username es "admin"
  ‚ö†Ô∏è PATR√ìN DETECTADO: Comprobaci√≥n de usuario Ramon
  --- L√≠neas con el patr√≥n ---
  // SOLUCI√ìN MEJORADA: Corregir el rol para Ramon
  if (userData.username && userData.username.toLowerCase() === 'ramon') {
  console.log('üî¥ Usuario Ramon detectado, FORZANDO rol Ramon');
  userData.role = 'Ramon';
  localStorage.setItem('userRole', 'Ramon');
  console.log('üî¥ Rol Ramon guardado separadamente para mayor seguridad');
  localStorage.setItem('ramonFix', 'true');
  console.log('Rol gerente detectado, convirtiendo a Ramon');
  userData.role = 'Ramon';
  localStorage.setItem('userRole', 'Ramon');
  // Mostrar el modal con el perro de Ramon
  // Mostrar el modal con el perro de Ramon
  // Funciones agregadas para el test de permisos de Ramon
  // Verificaci√≥n especial para Ramon
  if (user.username && user.username.toLowerCase() === 'ramon') {
  console.log('Usuario Ramon detectado en extractRoleFromToken de login.astro');
  return 'Ramon';
  // Convertir 'gerente' a 'Ramon' por compatibilidad
  console.log('Rol gerente detectado, convirtiendo a Ramon');
  return 'Ramon';
  return 'Ramon'; // Compatibilidad
  // Verificar el indicador especial de Ramon
  const ramonFix = localStorage.getItem('ramonFix');
  if (ramonFix === 'true') {
  console.log('Indicador ramonFix encontrado, retornando rol Ramon');
  return 'Ramon';
  // Verificaci√≥n especial para Ramon
  if (user.username && user.username.toLowerCase() === 'ramon') {
  if (user.role !== 'Ramon') {
  console.log('Corrigiendo rol de Ramon en getStoredUser de login.astro');
  user.role = 'Ramon';
  localStorage.setItem('userRole', 'Ramon');
  ‚ö†Ô∏è PATR√ìN DETECTADO: Compatibilidad con rol "gerente"
  --- L√≠neas con el patr√≥n ---
  } else if (userData.role === 'gerente') {
  console.log('Rol gerente detectado, convirtiendo a Ramon');
  // Convertir 'gerente' a 'Ramon' por compatibilidad
  if (user.role === 'gerente') {
  console.log('Rol gerente detectado, convirtiendo a Ramon');
  if (explicitRole === 'gerente') {
  ‚ö†Ô∏è PATR√ìN DETECTADO: Almacenamiento del usuario en localStorage
  --- L√≠neas con el patr√≥n ---
  localStorage.setItem('user', JSON.stringify(userData));
  localStorage.setItem('user', JSON.stringify(user));


==== DIAGN√ìSTICO FINAL Y PROPUESTA DE SOLUCI√ìN ====

El problema probablemente est√° en alguna de estas √°reas:
1. El proceso de login no est√° asignando correctamente el rol a Ramon
2. La funci√≥n extractRoleFromToken est√° priorizando incorrectamente la detecci√≥n de "admin"
3. El objeto de usuario guardado en localStorage tiene informaci√≥n incorrecta

SOLUCI√ìN PROPUESTA:
1. Modificar roleService.ts para priorizar la detecci√≥n de Ramon por nombre de usuario
2. Corregir el proceso de login para asignar expl√≠citamente el rol Ramon cuando corresponda
3. Revisar c√≥mo se guarda el usuario en localStorage despu√©s del login

=== FIN DEL DIAGN√ìSTICO ===
