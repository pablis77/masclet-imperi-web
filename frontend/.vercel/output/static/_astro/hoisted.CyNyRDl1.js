import"./hoisted.Aq9NsjF5.js";import"./LanguageSwitcher.astro_astro_type_script_index_0_lang.DhuIQNJ0.js";import"./vendor.DPE1g--N.js";document.addEventListener("DOMContentLoaded",function(){console.log("[Tabs] Inicializando pestañas de animal con traducciones");const l=document.getElementById("tabs-animal-update");if(!l){console.error("[Tabs] No se encontró el contenedor de pestañas");return}const r=l.querySelectorAll(".tab-button");console.log(`[Tabs] Encontradas ${r.length} pestañas`);function e(t){console.log(`[Tabs] Activando pestaña: ${t}`),r.forEach(s=>{const a=s.id===`tab-${t}`;s.classList.toggle("bg-lime-500",a),s.classList.toggle("text-white",a),s.classList.toggle("bg-gray-200",!a),s.classList.toggle("text-gray-700",!a),s.classList.toggle("dark:bg-gray-700",!a),s.classList.toggle("dark:text-gray-300",!a)}),document.querySelectorAll(".tab-content").forEach(s=>{const a=s.id===`content-${t}`;s.classList.toggle("hidden",!a),console.log(`[Tabs] Contenido ${s.id}: ${a?"visible":"oculto"}`)})}r.forEach(t=>{t.addEventListener("click",()=>{const o=t.id.replace("tab-","");e(o)})}),e("general")});document.addEventListener("DOMContentLoaded",function(){console.log("DOM completamente cargado y analizado");const l=window.location.pathname.split("/"),r=l[l.length-1];window.animalId=r,window.apiBaseUrl="http://127.0.0.1:8000/api/v1",console.log(`[AnimalUpdate] ID del animal definido globalmente: ${window.animalId}`),console.log(`[AnimalUpdate] URL base API definida globalmente: ${window.apiBaseUrl}`);const e=document.querySelectorAll("[data-tab]"),t=document.querySelectorAll(".tab-content");e.forEach(i=>{i.addEventListener("click",function(){const c=this.getAttribute("data-tab");e.forEach(m=>m.classList.remove("text-lime-500","border-lime-500","text-primary","border-primary","dark:text-primary-light","dark:border-primary-light")),this.classList.add("text-lime-500","border-lime-500","dark:text-lime-400","dark:border-lime-400"),t.forEach(m=>m.classList.add("hidden")),document.getElementById(`content-${c}`).classList.remove("hidden"),console.log(`Cambio a pestaña ${c}`)})});const o=document.getElementById("form-general"),s=document.getElementById("form-habitual"),a=document.getElementById("form-habituales");console.log("Configurando formularios..."),console.log("Form general encontrado:",o?"Sí":"No"),console.log("Form habitual encontrado:",s?"Sí":"No"),console.log("Form habituales encontrado:",a?"Sí":"No");const n=document.getElementById("registrar-parto-btn");n?(console.log("Botón de registrar parto encontrado, configurando..."),n.addEventListener("click",function(){console.log("Botón de registrar parto clickeado"),$()})):console.log("Botón de registrar parto NO encontrado"),o?(console.log("Formulario general encontrado, configurando..."),o.addEventListener("submit",function(i){i.preventDefault(),console.log("Formulario general enviado"),f(o)})):console.log("Formulario general no encontrado"),s?(console.log("Formulario habitual encontrado, configurando..."),s.addEventListener("submit",function(i){i.preventDefault(),console.log("Formulario habitual enviado"),f(s)})):console.log("Formulario habitual no encontrado"),a?(console.log("Formulario habituales encontrado, configurando..."),a.addEventListener("submit",function(i){i.preventDefault(),console.log("Formulario habituales enviado"),f(a)})):console.log("Formulario habituales no encontrado"),document.querySelectorAll("form").forEach(i=>{i._hasSubmitListener||(i.addEventListener("submit",function(c){c.preventDefault(),console.log("Formulario genérico enviado:",i.id),f(i)}),i._hasSubmitListener=!0)})});async function f(l){try{console.log("Procesando formulario:",l.id);const r=new FormData(l);console.log("Campos en el formulario:");for(let[t,o]of r.entries())console.log(`  ${t}: ${o}`);if(l.id==="form-habituales"&&r.entries().next().done){console.log("Formulario habituales está vacío, verificando campos manualmente...");const t=l.querySelector('select[name="alletar"]');t&&(console.log("Encontrado select alletar con valor:",t.value),r.append("alletar",t.value));const o=l.querySelector('select[name="estado_hab"]');o&&(console.log("Encontrado select estado_hab con valor:",o.value),r.append("estado_hab",o.value))}const e={};for(const[t,o]of r.entries())switch(t){case"nombre":e.nom=o||"";break;case"genere":e.genere=o||"F";break;case"dob":if(o)if(o.match(/^\d{4}-\d{2}-\d{2}$/)){const[s,a,n]=o.split("-");e.dob=`${n}/${a}/${s}`}else e.dob=o;break;case"codigo":e.cod=o||null;break;case"num_serie":e.num_serie=o||null;break;case"explotacio":e.explotacio=o||"";break;case"origen":e.origen=o||null;break;case"pare":e.pare=o||null;break;case"mare":e.mare=o||null;break;case"observaciones":e.observaciones=o||null;break;case"estado_hab":e.estado=o||"OK";break;case"alletar":o===""||o===void 0||o===null?e.alletar="0":e.alletar=String(o);break;case"estado":e.estado=o||"OK";break;default:console.log("Campo no mapeado:",t)}window.mostrarMensaje("Actualizando animal...","info"),window.mostrarMensaje("Enviando actualización al servidor...","info"),window.animalesFormData=e,console.log("Datos a enviar directamente al backend:",e);try{console.log("Obteniendo datos actuales del animal para comparar...");const t=localStorage.getItem("token")||"admin123",o=await fetch(`http://localhost:8000/api/v1/animals/${window.animalId}`,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error(`Error al obtener los datos actuales: ${o.status} ${o.statusText}`);const s=await o.json(),a=s.data||s;console.log("Datos actuales del animal:",a);const n={};console.log("Datos del formulario:");for(const[g,d]of Object.entries(e))console.log(`  ${g}: ${d} (${typeof d})`);console.log("Datos actuales del animal:");for(const[g,d]of Object.entries(a))console.log(`  ${g}: ${d} (${typeof d})`);e.nom!==a.nom&&(n.nom=e.nom),e.genere!==a.genere&&(n.genere=e.genere),e.explotacio!==a.explotacio&&(n.explotacio=e.explotacio),e.estado!==a.estado&&(n.estado=e.estado),e.dob&&e.dob!==a.dob&&(n.dob=e.dob),e.mare!==a.mare&&(n.mare=e.mare),e.pare!==a.pare&&(n.pare=e.pare),e.origen!==a.origen&&(n.origen=e.origen),e.cod!==a.cod&&(n.cod=e.cod),e.num_serie!==a.num_serie&&(n.num_serie=e.num_serie),e.observaciones!==a.observaciones&&(n.observaciones=e.observaciones),console.log("Comparando alletar:",`Valor formulario: ${e.alletar} (${typeof e.alletar})`,`Valor actual: ${a.alletar} (${typeof a.alletar})`);const i=String(e.alletar||"0"),c=String(a.alletar||"0");if(e.alletar&&i!==c&&(console.log(`Valor de alletar diferente: ${i} !== ${c}`),n.alletar=i),console.log("Campos modificados a enviar:",n),Object.keys(n).length===0){window.mostrarMensaje("No se detectaron cambios que actualizar","info");return}console.log("Enviando solo campos modificados para actualización:",n);const m=await fetch(`${window.apiBaseUrl}/animals/${window.animalId}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(n)});if(console.log(`Respuesta recibida: ${m.status} ${m.statusText}`),m.ok){const g=await m.json();console.log("Respuesta de actualización:",g),window.mostrarMensaje("¡Animal actualizado con éxito!","success"),setTimeout(()=>{window.location.href=`/animals/${window.animalId}`},1500)}else{let g=`Error ${m.status}: ${m.statusText}`;try{const d=await m.json();console.error("Error detallado:",d),d.detail&&(Array.isArray(d.detail)?g="Errores de validación: "+d.detail.map(u=>u.msg).join(", "):g=d.detail)}catch{try{const u=await m.text();g+=` - ${u}`}catch{console.error("No se pudo obtener detalle del error")}}window.mostrarMensaje("Error: "+g,"error")}}catch(t){console.error("Error en la petición:",t),window.mostrarMensaje("Error: "+(t.message||"Error desconocido"),"error")}}catch(r){console.error("Error al actualizar el animal:",r),window.mostrarMensaje(`Error: ${r.message||"Error desconocido"}`,"error")}}const b=document.getElementById("delete-animal-btn"),w=document.getElementById("delete-animal-modal"),E=document.getElementById("close-delete-modal"),h=document.getElementById("cancel-delete"),p=document.getElementById("confirm-delete"),v=document.getElementById("animal-name-confirm");if(b&&w){const l=document.querySelector("h1.text-3xl")?.textContent||"este animal",r=window.animalId;b.addEventListener("click",()=>{v&&(v.textContent=l),w.classList.remove("hidden")});const e=()=>{w.classList.add("hidden")};E&&E.addEventListener("click",e),h&&h.addEventListener("click",e),p&&p.addEventListener("click",async()=>{try{p.disabled=!0,p.innerHTML='<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Eliminando...';const t=localStorage.getItem("token"),o=window.apiBaseUrl,s=await fetch(`${o}/animals/${r}`,{method:"DELETE",headers:{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}}});if(s.ok)window.mostrarMensaje("Animal eliminado correctamente","success"),setTimeout(()=>{window.location.href="/animals"},1500);else{let a="Error al eliminar el animal";try{const n=await s.json();a=n.detail||n.message||a}catch{}window.mostrarMensaje(`Error: ${a}`,"error"),e(),p.disabled=!1,p.textContent="Eliminar definitivamente"}}catch(t){console.error("Error al eliminar animal:",t),window.mostrarMensaje("Error de conexión al intentar eliminar el animal","error"),e(),p.disabled=!1,p.textContent="Eliminar definitivamente"}})}async function $(){console.log("Iniciando proceso de registro de parto...");try{const l=document.getElementById("part")?.value,r=document.getElementById("GenereT")?.value,e=document.getElementById("EstadoT")?.value,t=document.getElementById("observacions")?.value;if(console.log("Datos del parto:",{part:l,genereT:r,estadoT:e,observacions:t}),!l||!r||!e){window.mostrarMensaje("Por favor, completa todos los campos obligatorios (fecha, género y estado)","error");return}let o=l;if(l.match(/^\d{4}-\d{2}-\d{2}$/)){const[i,c,m]=l.split("-");o=`${m}/${c}/${i}`}const s={part:o,GenereT:r,EstadoT:e};t&&(s.observacions=t),console.log("Datos del parto formateados:",s);const a=localStorage.getItem("token")||"admin123";window.mostrarMensaje("Registrando nuevo parto...","info");const n=await fetch(`http://localhost:8000/api/v1/animals/${window.animalId}/partos`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify(s)});if(console.log(`Respuesta recibida: ${n.status} ${n.statusText}`),n.ok){const i=await n.json();console.log("Respuesta de registro de parto:",i),window.mostrarMensaje("¡Parto registrado con éxito!","success"),document.getElementById("part").value="",document.getElementById("GenereT").value="",document.getElementById("EstadoT").value="",document.getElementById("observacions")&&(document.getElementById("observacions").value=""),setTimeout(()=>{window.location.href=`/animals/${window.animalId}`},1500)}else{let i="Error al registrar el parto";try{const c=await n.json();i=c.detail||c.message||i,console.error("Error detallado:",c)}catch(c){console.error("Error al procesar respuesta de error:",c)}window.mostrarMensaje(`Error: ${i}`,"error")}}catch(l){console.error("Error en el registro de parto:",l),window.mostrarMensaje(`Error: ${l.message||"Error desconocido al registrar el parto"}`,"error")}}document.addEventListener("DOMContentLoaded",function(){const l=localStorage.getItem("userLanguage"),r=localStorage.getItem("lastPageLang");if(console.log("[Language] Página cargada - Idioma actual:",l,"Idioma anterior:",r),r&&l!==r&&!window.location.search.includes("lang=")){console.log("[Language] Detectado cambio de idioma, forzando recarga completa");const e=new URL(window.location.href);e.searchParams.set("lang",l),e.searchParams.set("_t",Date.now()),window.location.href=e.toString();return}localStorage.setItem("lastPageLang",l)});document.addEventListener("DOMContentLoaded",function(){const l=document.getElementById("registrar-parto-btn");l?(console.log("Configurando botón de registro de partos..."),l.addEventListener("click",async function(){console.log("Botón de registrar parto clickeado");try{const r=document.getElementById("part")?.value,e=document.getElementById("GenereT")?.value,t=document.getElementById("EstadoT")?.value,o=document.getElementById("observacions")?.value;if(console.log("Datos del parto:",{part:r,genereT:e,estadoT:t,observacions:o}),!r||!e||!t){window.mostrarMensaje("Por favor, completa todos los campos obligatorios (fecha, género y estado)","error");return}let s=r;if(r.match(/^\d{4}-\d{2}-\d{2}$/)){const[d,u,y]=r.split("-");s=`${y}/${u}/${d}`}const a={part:s,GenereT:e,EstadoT:t};o&&(a.observacions=o),console.log("Datos del parto formateados:",a);const n=localStorage.getItem("token")||"admin123",i=window.animalId;if(!i){window.mostrarMensaje("Error: No se pudo determinar el ID del animal","error");return}window.mostrarMensaje("Registrando nuevo parto...","info");let c="";typeof window<"u"&&window.apiBaseUrl?(c=window.apiBaseUrl,console.log("Usando URL para API desde variable global: "+c)):(c="http://127.0.0.1:8000/api/v1",console.log("Usando URL fallback para API: "+c));const m=`/animals/${i}/partos/`;console.log(`Enviando petición a: ${c}${m}`);const g=await fetch(`${c}${m}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(a)});if(console.log(`Respuesta recibida: ${g.status} ${g.statusText}`),g.ok){const d=await g.json();console.log("Respuesta de registro de parto:",d),window.mostrarMensaje("¡Parto registrado con éxito!","success"),document.getElementById("part").value="",document.getElementById("GenereT").value="",document.getElementById("EstadoT").value="",document.getElementById("observacions")&&(document.getElementById("observacions").value=""),setTimeout(()=>{window.location.href=`/animals/${i}`},1500)}else{let d="Error al registrar el parto";try{const u=await g.json();d=u.detail||u.message||d,console.error("Error detallado:",u)}catch(u){console.error("Error al procesar respuesta de error:",u)}window.mostrarMensaje(`Error: ${d}`,"error")}}catch(r){console.error("Error en el registro de parto:",r),window.mostrarMensaje(`Error: ${r.message||"Error desconocido al registrar el parto"}`,"error")}})):console.warn("No se encontró el botón de registrar parto")});
