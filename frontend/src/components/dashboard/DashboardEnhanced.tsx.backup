import React, { useState, useEffect } from 'react';
import axios from 'axios';
import apiService from '../../services/apiService';
import { Chart as ChartJS, ArcElement, Tooltip, Legend, CategoryScale, LinearScale, BarElement, Title, PointElement, LineElement } from 'chart.js';
import { Pie, Bar, Line } from 'react-chartjs-2';
import './dashboardStyles.css';

// Registrar los componentes de ChartJS necesarios
ChartJS.register(
  ArcElement, 
  Tooltip, 
  Legend, 
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  PointElement,
  LineElement
);

// Interfaces para los tipos de respuesta de cada endpoint
interface DashboardResumen {
  // Endpoint #6: /api/v1/dashboard/resumen/
  total_animales: number;
  total_terneros: number;
  total_partos: number;
  ratio_partos_animal: number;
  tendencias: {
    partos_mes_anterior: number;
    partos_actual: number;
    nacimientos_promedio: number;
  };
  terneros: {
    total: number;
  };
  explotaciones: {
    count: number;
  };
  partos: {
    total: number;
  };
  periodo: {
    inicio: string;
    fin: string;
  };
}

interface DashboardStats {
  // Endpoint #1: /api/v1/dashboard/stats
  animales: {
    total: number;
    machos: number;
    hembras: number;
    ratio_m_h: number;
    por_estado: Record<string, number>;
    por_alletar?: Record<string, number>;
    por_quadra?: Record<string, number>;
    edades?: Record<string, number>;
  };
  partos: {
    total: number;
    ultimo_mes: number;
    ultimo_año: number;
    promedio_mensual: number;
    por_mes: Record<string, number>;
    por_genero_cria?: Record<string, number>;
    tasa_supervivencia?: number;
    distribucion_anual?: Record<string, number>;
  };
  explotaciones?: {
    total: number;
    activas: number;
    inactivas: number;
    por_provincia?: Record<string, number>;
    ranking_partos?: Array<Record<string, any>>;
    ranking_animales?: Array<Record<string, any>>;
  };
  comparativas?: {
    mes_actual_vs_anterior?: Record<string, number>;
    año_actual_vs_anterior?: Record<string, number>;
    tendencia_partos?: Record<string, any>;
    tendencia_animales?: Record<string, any>;
  };
  explotacio?: string;
  nombre_explotacio?: string;
  periodo?: {
    inicio: string;
    fin: string;
  };
}

interface PartosStats {
  // Endpoint #5: /api/v1/dashboard/partos
  total: number;
  por_mes: Record<string, number>;
  por_genero_cria: Record<string, number>;
  tasa_supervivencia: number;
  distribucion_anual: Record<string, number>;
  tendencia: Record<string, number>;
  por_animal?: Array<Record<string, any>>;
  ultimo_mes: number;
  ultimo_año: number; // Cambiado de ultimo_anio a ultimo_año para coincidir con el backend
  promedio_mensual: number;
  explotacio?: string;
  periodo?: {
    inicio: string;
    fin: string;
  };
}

interface CombinedStats {
  // Endpoint #7: /api/v1/dashboard/combined
  animales: {
    total: number;
    machos: number;
    hembras: number;
    ratio_m_h: number;
    por_estado: Record<string, number>;
    por_alletar?: Record<string, number>;
    por_quadra?: Record<string, number>;
    edades?: Record<string, number>;
  };
  partos: {
    total: number;
    ultimo_mes: number;
    ultimo_año: number;
    promedio_mensual: number;
    por_mes: Record<string, number>;
    por_genero_cria?: Record<string, number>;
    tasa_supervivencia?: number;
    distribucion_anual?: Record<string, number>;
  };
  explotaciones?: {
    total: number;
    activas: number;
    inactivas: number;
    por_provincia?: Record<string, number>;
    ranking_partos?: Array<Record<string, any>>;
    ranking_animales?: Array<Record<string, any>>;
  };
  comparativas: {
    mes_actual_vs_anterior?: Record<string, number>;
    año_actual_vs_anterior?: Record<string, number>;
    tendencia_partos?: Record<string, any>;
    tendencia_animales?: Record<string, any>;
  };
  por_quadra: Record<string, Record<string, any>>;
  rendimiento_partos: Record<string, number>;
  tendencias: Record<string, Record<string, number>>;
  explotacio?: string;
  nombre_explotacio?: string;
  periodo: {
    inicio: string;
    fin: string;
  };
}

interface ExplotacionInfo {
  // Endpoints #2, #3 y #4: Información de explotaciones
  explotacio: string;
  nombre?: string;
  count?: number;
  total_animales?: number;
  total_partos?: number;
}

interface AnimalStats {
  total: number;
  machos: number;
  hembras: number;
  ratio_m_h: number;
  por_estado: Record<string, number>;
  por_alletar: Record<string, number>;
  por_quadra: Record<string, number>;
  edades: Record<string, number>;
}

/**
 * Componente Dashboard Mejorado con múltiples endpoints
 */
const DashboardEnhanced: React.FC = () => {
  // Estados para los diferentes endpoints
  const [resumenData, setResumenData] = useState<DashboardResumen | null>(null);
  const [statsData, setStatsData] = useState<DashboardStats | null>(null);
  const [partosData, setPartosData] = useState<PartosStats | null>(null);
  const [combinedData, setCombinedData] = useState<CombinedStats | null>(null);
  const [explotaciones, setExplotaciones] = useState<ExplotacionInfo[]>([]);
  const [rendimientoPartos, setRendimientoPartos] = useState<Record<string, number>>({});
  const [tendencias, setTendencias] = useState<Record<string, any>>({});
  const [distribucionPorQuadra, setDistribucionPorQuadra] = useState<Record<string, number>>({});
  const [animalStats, setAnimalStats] = useState<AnimalStats>({
    total: 0,
    machos: 0,
    hembras: 0,
    ratio_m_h: 0,
    por_estado: {},
    por_alletar: {},
    por_quadra: {},
    edades: {}
  });
  
  // Estados generales
  const [loading, setLoading] = useState<Record<string, boolean>>({
    resumen: true,
    stats: true,
    partos: true,
    combined: true,
    explotaciones: true
  });
  const [error, setError] = useState<Record<string, string | null>>({
    resumen: null,
    stats: null,
    partos: null,
    combined: null,
    explotaciones: null
  });
  const [requestLogs, setRequestLogs] = useState<string[]>([]);
  
  // Estado para el tema (sincronizado con tema global)
  const [darkMode, setDarkMode] = useState<boolean>(false);

  // Efecto para sincronizar con el tema global al cargar
  useEffect(() => {
    const isDarkMode = document.documentElement.classList.contains('dark');
    setDarkMode(isDarkMode);
    
    // Observar cambios en el tema
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const isDark = document.documentElement.classList.contains('dark');
          setDarkMode(isDark);
        }
      });
    });
    
    observer.observe(document.documentElement, { attributes: true });
    
    return () => observer.disconnect();
  }, []);

  // Función para añadir logs de depuración
  const addLog = (message: string) => {
    const timestamp = new Date().toISOString();
    setRequestLogs(prev => [...prev, `${timestamp} - ${message}`]);
    console.log(`[DashboardEnhanced] ${message}`);
  };

  // Funciones para obtener datos de los diferentes endpoints
  const fetchResumenData = async () => {
    try {
      addLog('Iniciando petición a /dashboard/resumen/ usando apiService');
      
      // Verificar token (no es necesario, apiService ya lo maneja)
      if (!localStorage.getItem('token')) {
        addLog('⚠️ No se encontró token en localStorage');
        setError(prev => ({ ...prev, resumen: 'No hay token de autenticación' }));
        setLoading(prev => ({ ...prev, resumen: false }));
        return;
      }
      
      // Usar apiService que detecta automáticamente la IP
      const response = await apiService.get('/dashboard/resumen/');
      
      addLog('✅ Datos de resumen recibidos');
      console.log('Datos de resumen recibidos:', response);
      
      // En lugar de response.data, ahora usamos response directamente
      // ya que el servicio apiService ya extrae .data
      if (!response) {
        addLog('⚠️ Respuesta vacía recibida');
        throw new Error('Formato de respuesta inválido - datos vacíos');
      }
      
      // Imprimir la respuesta completa para depuración
      console.log('Estructura de la respuesta:', {
        keys: Object.keys(response),
        type: typeof response,
        isArray: Array.isArray(response)
      });
      
      // Validar y establecer valores predeterminados para campos faltantes
      const validatedData = {
        total_animales: response.total_animales ?? 0,
        total_terneros: response.total_terneros ?? 0,
        total_partos: response.total_partos ?? 0,
        ratio_partos_animal: response.ratio_partos_animal ?? 0,
        tendencias: response.tendencias ? {
          partos_mes_anterior: response.tendencias.partos_mes_anterior ?? 0,
          partos_actual: response.tendencias.partos_actual ?? 0,
          nacimientos_promedio: response.tendencias.nacimientos_promedio ?? 0
        } : {
          partos_mes_anterior: 0,
          partos_actual: 0,
          nacimientos_promedio: 0
        },
        terneros: response.terneros ? { total: response.terneros.total ?? 0 } : { total: 0 },
        explotaciones: response.explotaciones ? { count: response.explotaciones.count ?? 0 } : { count: 0 },
        partos: response.partos ? { total: response.partos.total ?? 0 } : { total: 0 },
        periodo: response.periodo ? {
          inicio: response.periodo.inicio ?? new Date().toISOString().split('T')[0],
          fin: response.periodo.fin ?? new Date().toISOString().split('T')[0]
        } : {
          inicio: new Date().toISOString().split('T')[0],
          fin: new Date().toISOString().split('T')[0]
        }
      };
      
      addLog(`Datos validados y procesados correctamente`);
      setResumenData(validatedData);
      setLoading(prev => ({ ...prev, resumen: false }));
    } catch (err) {
      if (axios.isAxiosError(err)) {
        addLog(`❌ Error en resumen: ${err.message}`);
        setError(prev => ({ ...prev, resumen: `Error: ${err.message}` }));
      } else {
        addLog(`❌ Error desconocido en resumen: ${err instanceof Error ? err.message : 'Error sin detalles'}`);
        setError(prev => ({ ...prev, resumen: 'Error procesando datos' }));
      }
      // Crear valores predeterminados cuando falla
      setResumenData({
        total_animales: 0,
        total_terneros: 0,
        total_partos: 0,
        ratio_partos_animal: 0,
        tendencias: {
          partos_mes_anterior: 0,
          partos_actual: 0,
          nacimientos_promedio: 0
        },
        terneros: { total: 0 },
        explotaciones: { count: 0 },
        partos: { total: 0 },
        periodo: {
          inicio: new Date().toISOString().split('T')[0],
          fin: new Date().toISOString().split('T')[0]
        }
      });
      setLoading(prev => ({ ...prev, resumen: false }));
    }
  };

  const fetchStatsData = async () => {
    try {
      addLog('Iniciando petición a /dashboard/stats usando apiService');
      
      // Verificar token (no es necesario, apiService ya lo maneja)
      if (!localStorage.getItem('token')) {
        addLog('⚠️ No se encontró token en localStorage');
        setError(prev => ({ ...prev, stats: 'No hay token de autenticación' }));
        setLoading(prev => ({ ...prev, stats: false }));
        return;
      }
      
      const response = await apiService.get('/dashboard/stats');
      
      addLog('✅ Datos de stats recibidos');
      console.log('Datos de stats recibidos:', response);

      // Usar response directamente en lugar de response.data
      if (!response) {
        addLog('⚠️ Respuesta vacía recibida en stats');
        throw new Error('Formato de respuesta inválido en stats - datos vacíos');
      }

      // Imprimir la estructura para depuración
      console.log('Estructura de stats:', {
        keys: Object.keys(response),
        type: typeof response,
        isArray: Array.isArray(response)
      });
      
      // Asegurar que otros campos requeridos estén presentes
      const defaultStats = {
        animales: {
          total: 0,
          machos: 0,
          hembras: 0,
          ratio_m_h: 0,
          por_estado: {},
          por_quadra: {},
          por_alletar: {},
          edades: {
            menos_1_año: 0,
            "1_2_años": 0,
            "2_5_años": 0,
            mas_5_años: 0
          }
        },
        partos: {
          total: 0,
          ultimo_mes: 0,
          ultimo_año: 0,
          promedio_mensual: 0,
          por_mes: {},
          por_genero_cria: { "M": 0, "F": 0 },
          tasa_supervivencia: 0,
          distribucion_anual: {}
        },
        explotaciones: {
          total: 0,
          activas: 0,
          inactivas: 0
        },
        comparativas: {
          mes_actual_vs_anterior: {
            partos: 0,
            animales: 0
          },
          año_actual_vs_anterior: {
            partos: 0
          }
        },
        periodo: {
          inicio: new Date().toISOString().split('T')[0],
          fin: new Date().toISOString().split('T')[0]
        }
      };
      
      // Utilizar una estrategia de fusión profunda para asegurar que la estructura sea completa
      const mergeObjects = (target: any, source: any) => {
        if (!source) return target;
        const result = {...target};
        
        for (const key in source) {
          if (source[key] !== null && typeof source[key] === 'object' && !Array.isArray(source[key])) {
            result[key] = mergeObjects(result[key] || {}, source[key]);
          } else {
            result[key] = source[key];
          }
        }
        return result;
      };
      
      // Mezclar con valores predeterminados para campos faltantes
      const validatedData = mergeObjects(defaultStats, response);
      
      // Actualizar el estado con datos validados
      addLog('Datos de stats validados y procesados correctamente');
      setStatsData(validatedData);
      setLoading(prev => ({ ...prev, stats: false }));
    } catch (err) {
      if (axios.isAxiosError(err)) {
        addLog(`❌ Error en stats: ${err.message}`);
        setError(prev => ({ ...prev, stats: `Error: ${err.message}` }));
      } else {
        addLog(`❌ Error desconocido en stats: ${err instanceof Error ? err.message : 'Error sin detalles'}`);
        setError(prev => ({ ...prev, stats: 'Error procesando datos' }));
      }
      // Establecer valores predeterminados en caso de error
      setStatsData({
        animales: {
          total: 0,
          machos: 0,
          hembras: 0,
          ratio_m_h: 0,
          por_estado: {},
          por_quadra: {},
          por_alletar: {},
          edades: {
            menos_1_año: 0,
            "1_2_años": 0,
            "2_5_años": 0,
            mas_5_años: 0
          }
        },
        partos: {
          total: 0,
          ultimo_mes: 0,
          ultimo_año: 0,
          promedio_mensual: 0,
          por_mes: {},
          por_genero_cria: { "M": 0, "F": 0 },
          tasa_supervivencia: 0,
          distribucion_anual: {}
        },
        explotaciones: {
          total: 0,
          activas: 0,
          inactivas: 0
        },
        comparativas: {
          mes_actual_vs_anterior: {
            partos: 0,
            animales: 0
          },
          año_actual_vs_anterior: {
            partos: 0
          }
        },
        periodo: {
          inicio: new Date().toISOString().split('T')[0],
          fin: new Date().toISOString().split('T')[0]
        }
      });
      setLoading(prev => ({ ...prev, stats: false }));
    }
  };

  const fetchPartosData = async () => {
    try {
      addLog('Iniciando petición a /dashboard/partos usando apiService');
      
      // Verificar token (no es necesario, apiService ya lo maneja)
      if (!localStorage.getItem('token')) {
        addLog('⚠️ No se encontró token en localStorage');
        setError(prev => ({ ...prev, partos: 'No hay token de autenticación' }));
        setLoading(prev => ({ ...prev, partos: false }));
        return;
      }
      
      const response = await apiService.get('/dashboard/partos');
      
      addLog('✅ Datos de partos recibidos');
      console.log('Datos de partos completos:', response);
      
      // Validar estructura de datos
      if (!response || typeof response !== 'object') {
        throw new Error('Formato de respuesta inválido en partos');
      }
      
      // Definir valores predeterminados para campos requeridos
      const defaultPartosData = {
        total: 0,
        por_mes: {},
        por_genero_cria: { M: 0, F: 0 },
        tasa_supervivencia: 0,
        distribucion_anual: {},
        tendencia: {},
        ultimo_mes: 0,
        ultimo_año: 0,
        promedio_mensual: 0
      };
      
      // Mezclar con valores predeterminados para campos faltantes
      const validatedData = {
        ...defaultPartosData,
        // Asegurarnos de que estos campos sean números válidos
        total: typeof response.total === 'number' ? response.total : 0,
        ultimo_mes: typeof response.ultimo_mes === 'number' ? response.ultimo_mes : 0,
        ultimo_año: typeof response.ultimo_año === 'number' ? response.ultimo_año : 0,
        tasa_supervivencia: typeof response.tasa_supervivencia === 'number' ? response.tasa_supervivencia : 0,
        // Asegurar que estos objetos estén presentes y no sean null
        por_mes: response.por_mes || {},
        por_genero_cria: response.por_genero_cria || { M: 0, F: 0 },
        distribucion_anual: response.distribucion_anual || {}
      };
      
      console.log('Datos de partos procesados:', validatedData);
      addLog(`Datos de partos validados correctamente`);
      setPartosData(validatedData);
      setLoading(prev => ({ ...prev, partos: false }));
    } catch (err) {
      if (axios.isAxiosError(err)) {
        addLog(`❌ Error en partos: ${err.message}`);
        setError(prev => ({ ...prev, partos: `Error: ${err.message}` }));
      } else {
        addLog(`❌ Error desconocido en partos: ${err instanceof Error ? err.message : 'Error sin detalles'}`);
        setError(prev => ({ ...prev, partos: 'Error procesando datos de partos' }));
      }
      setLoading(prev => ({ ...prev, partos: false }));
    }
  };

  const fetchCombinedData = async () => {
    try {
      addLog('Iniciando petición a /dashboard/combined usando apiService');
      
      const response = await apiService.get('/dashboard/combined');
      
      addLog('✅ Datos combinados recibidos');
      
      try {
        // Usar response directamente en lugar de response.data
        const dashboardData = response;
        const animales = dashboardData.animales || {};
        const partos = dashboardData.partos || {};
        
        // Procesar datos sobre rendimiento de partos
        if (dashboardData.rendimiento_partos) {
          setRendimientoPartos(dashboardData.rendimiento_partos);
        }
        
        // Actualizar tendencias
        if (dashboardData.tendencias) {
          setTendencias(dashboardData.tendencias);
        }
        
        // Actualizar distribución por quadra
        if (dashboardData.animales && dashboardData.animales.por_quadra) {
          setDistribucionPorQuadra(dashboardData.animales.por_quadra);
        }
        
        setCombinedData(dashboardData);
      } catch (err) {
        console.error('Error procesando datos combinados:', err);
        addLog(`❌ Error desconocido en combined: ${err instanceof Error ? err.message : 'Error sin detalles'}`);
        setError(prev => ({ ...prev, combined: 'Error procesando datos combinados' }));
      }
      setLoading(prev => ({ ...prev, combined: false }));
    } catch (err) {
      if (axios.isAxiosError(err)) {
        addLog(`❌ Error en combined: ${err.message}`);
        setError(prev => ({ ...prev, combined: `Error: ${err.message}` }));
      } else {
        addLog(`❌ Error desconocido en combined: ${err instanceof Error ? err.message : 'Error sin detalles'}`);
        setError(prev => ({ ...prev, combined: 'Error procesando datos combinados' }));
      }
      setLoading(prev => ({ ...prev, combined: false }));
    }
  };

  const fetchExplotacionesData = async () => {
    try {
      addLog('Iniciando petición a /dashboard/explotacions usando apiService');
      
      // Verificar token (no es necesario, apiService ya lo maneja)
      if (!localStorage.getItem('token')) {
        addLog('⚠️ No se encontró token en localStorage');
        setError(prev => ({ ...prev, explotaciones: 'No hay token de autenticación' }));
        setLoading(prev => ({ ...prev, explotaciones: false }));
        return;
      }
      
      const response = await apiService.get('/dashboard/explotacions');
      
      addLog('✅ Lista de explotaciones recibida');
      
      // Extraer los datos principales del dashboard
      const animales = response.animales || {};
      const partos = response.partos || {};
      const explotacions = response.explotacions || {};
      
      // Obtener información de las 3 principales explotaciones
      if (response && response.length > 0) {
        const top3Explotaciones = response.slice(0, 3);
        const explotacionesInfo: ExplotacionInfo[] = [];
        
        for (const explotacion of top3Explotaciones) {
          try {
            const infoResponse = await apiService.get(`/dashboard/explotacions/${explotacion.explotacio}`);
            
            // La respuesta de apiService.get() ya contiene los datos directamente, no hace falta .data
            explotacionesInfo.push({
              ...infoResponse,  // Usar directamente la respuesta sin .data
              explotacio: explotacion.explotacio
            });
          } catch (err) {
            addLog(`⚠️ No se pudo obtener info de explotación ${explotacion.explotacio}`);
          }
        }
        
        setExplotaciones(explotacionesInfo);
      }
      
      setLoading(prev => ({ ...prev, explotaciones: false }));
    } catch (err) {
      if (axios.isAxiosError(err)) {
        addLog(`❌ Error en explotaciones: ${err.message}`);
        setError(prev => ({ ...prev, explotaciones: `Error: ${err.message}` }));
      } else {
        addLog(`❌ Error desconocido en explotaciones`);
        setError(prev => ({ ...prev, explotaciones: 'Error desconocido' }));
      }
      setLoading(prev => ({ ...prev, explotaciones: false }));
    }
  };

  // Función para autenticar y obtener un token nuevo cada vez
  const authenticate = async () => {
    try {
      addLog('Iniciando autenticación con apiService.login');
      
      // Autenticar usando el apiService que ya tiene la IP correcta
      const loginResponse = await apiService.login('admin', 'admin123');
      
      // Guardar el token
      if (loginResponse.data && loginResponse.data.access_token) {
        localStorage.setItem('token', loginResponse.data.access_token);
        addLog('✅ Autenticación exitosa, token guardado');
        return loginResponse.data.access_token;
      } else {
        throw new Error('Token no encontrado en la respuesta');
      }
      
    } catch (err) {
      if (axios.isAxiosError(err)) {
        addLog(`❌ Error en autenticación: ${err.message}`);
        throw new Error(`Error de autenticación: ${err.message}`);
      } else {
        addLog(`❌ Error desconocido en autenticación`);
        throw new Error('Error desconocido en autenticación');
      }
    }
  };

  // Función para cambiar tema manualmente
  const toggleTheme = () => {
    setDarkMode(prev => !prev);
  };

  // Cargar datos al montar el componente
  useEffect(() => {
    // Función simple para cargar todos los datos sin preocuparse por la autenticación
    // ya que los endpoints ahora son accesibles sin token
    const loadDashboardData = async () => {
      try {
        addLog('Cargando datos del dashboard');
        
        // Cargar todos los endpoints en paralelo para acelerar la carga
        await Promise.all([
          fetchResumenData(),
          fetchStatsData(),
          fetchPartosData(), 
          fetchCombinedData(),
          fetchExplotacionesData()
        ]);
        
        addLog('✅ Datos del dashboard cargados correctamente');
      } catch (error) {
        console.error('Error cargando datos del dashboard:', error);
        setError(prev => ({
          ...prev,
          global: 'Error cargando datos del dashboard. Inténtalo de nuevo más tarde.'
        }));
      }
    };
    
    // Cargar los datos inmediatamente
    loadDashboardData();
  }, []);

  // Renderizar gráfico de distribución por género
  const renderGenderChart = (data: Record<string, number> | undefined) => {
    if (!data) return null;
    
    // Si el objeto está vacío o todos los valores son 0, mostrar un gráfico con valores de ejemplo
    const totalValue = Object.values(data).reduce((sum, value) => sum + value, 0);
    if (Object.keys(data).length === 0 || totalValue === 0) {
      console.log('No hay datos para el gráfico de género, mostrando plantilla');
      data = {
        'Machos': 0,
        'Hembras': 0,
        'Otros': 0
      };
    }
    
    // Mapear etiquetas especiales
    const labels = Object.keys(data).map(key => {
      if (key === 'M') return 'Machos';
      if (key === 'F') return 'Hembras';
      if (key === 'esforrada') return 'Esforradas';
      return key;
    });
    
    // Asignar colores consistentes para cada categoría
    const colors: string[] = [];
    labels.forEach(label => {
      if (label === 'Machos' || label === 'Toros') colors.push('#1d4ed8'); // Azul oscuro para toros
      else if (label === 'Hembras' || label === 'Vacas') colors.push('#db2777'); // Rosa fuerte para vacas
      else if (label === 'Esforradas') colors.push('#8b5cf6'); // Púrpura
      else if (label === 'Fallecidos') colors.push('#f97316'); // Naranja
      else colors.push('#10b981'); // Verde para otros casos
    });

    const chartData = {
      labels: labels,
      datasets: [
        {
          data: Object.values(data),
          backgroundColor: colors,
          borderWidth: 1,
          borderColor: darkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)',
        },
      ],
    };

    return <Pie 
      data={chartData} 
      options={{
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: darkMode ? '#e5e7eb' : '#374151',
              font: {
                size: 12
              }
            }
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = context.raw as number;
                const total = context.dataset.data.reduce((sum: number, val: number) => sum + val, 0) as number;
                const percentage = total === 0 ? '0%' : Math.round((value / total) * 100) + '%';
                return `${context.label}: ${value} (${percentage})`;
              }
            }
          }
        }
      }} 
    />
  };

  // Renderizar gráfico de barras para distribución mensual
  const renderMonthlyChart = (data: Record<string, number> | undefined) => {
    if (!data) return null;
    
    // Crear array de todos los meses en español
    const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    
    // Si el objeto está vacío, mostrar un gráfico de barras con todos los meses pero valores 0
    if (Object.keys(data).length === 0) {
      const emptyData: Record<string, number> = {};
      months.forEach(month => {
        emptyData[month] = 0;
      });
      data = emptyData;
    }

    // Ordenar los meses en el orden correcto (de enero a diciembre)
    const monthOrder = {
      'Ene': 1, 'Feb': 2, 'Mar': 3, 'Abr': 4, 'May': 5, 'Jun': 6,
      'Jul': 7, 'Ago': 8, 'Sep': 9, 'Oct': 10, 'Nov': 11, 'Dic': 12
    };
    
    // Preparar datos por mes asegurándonos que todos los meses estén representados
    const preparedData: Record<string, number> = {};
    months.forEach(month => {
      preparedData[month] = data[month] || 0;
    });
    
    // Generar colores para cada mes con diferentes tonalidades
    const colorGradient = [
      '#3b82f6', // azul
      '#60a5fa', // azul más claro
      '#93c5fd', // azul aún más claro
      '#2563eb', // azul más oscuro
      '#1e40af', // azul muy oscuro
      '#818cf8', // púrpura
      '#8b5cf6', // púrpura-azul
      '#6366f1', // indigo
      '#4f46e5', // indigo oscuro
      '#a855f7', // púrpura medio
      '#9333ea', // púrpura oscuro
      '#7c3aed'  // violeta
    ];

    const chartData = {
      labels: months, // Usar todos los meses en orden correcto
      datasets: [
        {
          label: 'Partos por mes',
          data: months.map(month => preparedData[month]),
          backgroundColor: colorGradient,
          borderWidth: 1,
          borderColor: darkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)',
        },
      ],
    };

    return <Bar data={chartData} options={{
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0 // Solo mostrar enteros
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: (context) => {
              const value = context.raw as number;
              return `Partos: ${value}`;
            }
          }
        }
      }
    }} />
  };

  // Renderizar gráfico de evolución anual de partos
  const renderYearlyChart = (data: Record<string, number> | undefined) => {
    if (!data) return null;
    
    // Asegurar que tenemos datos desde 2010 hasta el año actual
    const currentYear = new Date().getFullYear();
    const startYear = 2010;
    
    // Preparar datos asegurándonos que todos los años estén representados
    const years: string[] = [];
    const preparedData: number[] = [];
    
    for (let year = startYear; year <= currentYear; year++) {
      years.push(year.toString());
      preparedData.push(data[year.toString()] || 0);
    }
    
    const chartData = {
      labels: years,
      datasets: [
        {
          label: 'Partos por año',
          data: preparedData,
          backgroundColor: '#0891b2', // Un tono de azul-verdoso
          borderColor: '#0e7490',    // Azul-verdoso más oscuro
          borderWidth: 1,
        },
      ],
    };

    return <Bar data={chartData} options={{
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0 // Solo mostrar enteros
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            title: (items) => `Año ${items[0].label}`,
            label: (context) => {
              const value = context.raw as number;
              return `Partos: ${value}`;
            }
          }
        }
      }
    }} />
  };

  // Renderizar gráfico de línea para tendencias
  const renderTrendChart = (data: Record<string, number> | undefined) => {
    if (!data) return null;

    const chartData = {
      labels: Object.keys(data),
      datasets: [
        {
          label: 'Tendencia',
          data: Object.values(data),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.5)',
          tension: 0.4,
        },
      ],
    };

    return <Line data={chartData} />
  };

  // Renderizar tarjeta de estadísticas
  const StatCard = ({ title, value, color }: { title: string, value: number | string, color: string }) => {
    return (
      <div 
        className={`${color}`} 
        style={{
          width: '100%',
          padding: '0.75rem',
          borderRadius: '0.5rem',
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          marginBottom: '0.5rem',
          border: darkMode ? '1px solid rgba(255, 255, 255, 0.1)' : '1px solid rgba(0, 0, 0, 0.1)',
          boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)'
        }}
      >
        <h3 style={{color: 'white', fontWeight: 'bold', marginBottom: '0.25rem'}}>{title}</h3>
        <p style={{color: 'white', fontSize: '1.75rem', fontWeight: 'bold', margin: 0}}>{value}</p>
      </div>
    );
  };

  // Renderizar título de sección con número circular
  const SectionTitle = ({ number, title }: { number: string, title: string }) => {
    return (
      <div style={{
        display: 'flex',
        alignItems: 'center',
        marginBottom: '0.5rem',
        marginTop: '1rem',
        padding: '0.5rem',
        backgroundColor: darkMode ? '#111827' : '#e5e7eb',
        border: darkMode ? '1px solid #374151' : 'none',
      }}>
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '1.5rem',
          height: '1.5rem',
          borderRadius: '9999px',
          backgroundColor: '#3b82f6',
          color: 'white',
          fontWeight: 'bold',
          marginRight: '0.5rem',
        }}>
          {number}
        </div>
        <h2 style={{
          fontSize: '1.25rem',
          fontWeight: 'bold',
          color: darkMode ? 'white' : '#111827',
        }}>{title}</h2>
      </div>
    );
  };

  // Renderizar tarjeta de dashboard para gráficos
  const DashboardCard = ({ title, children, className = '' }: { title: string, children: React.ReactNode, className?: string }) => {
    return (
      <div 
        style={{
          backgroundColor: darkMode ? '#111827' : '#ffffff',
          color: darkMode ? '#f9fafb' : '#111827',
          borderRadius: '0.5rem',
          padding: '1rem',
          marginBottom: '1rem',
          border: darkMode ? '1px solid #374151' : '1px solid rgba(0, 0, 0, 0.1)',
          boxShadow: darkMode ? '0 4px 6px rgba(0, 0, 0, 0.3)' : '0 2px 4px rgba(0, 0, 0, 0.1)'
        }}
        className={className}
        data-component-name="DashboardEnhanced"
      >
        <h3 
          style={{
            fontSize: '1.125rem',
            fontWeight: 'bold',
            marginBottom: '1rem',
            color: darkMode ? '#f9fafb' : '#111827',
          }}
          data-component-name="DashboardEnhanced"
        >
          {title}
        </h3>
        {children}
      </div>
    );
  };

  // Renderizar etiqueta para tarjeta
  const CardLabel = ({ children }: { children: React.ReactNode }) => {
    return (
      <div 
        style={{
          color: darkMode ? '#d1d5db' : '#4b5563',
          fontSize: '0.875rem',
          fontWeight: '500',
          marginBottom: '0.25rem'
        }}
        data-component-name="DashboardEnhanced"
      >
        {children}
      </div>
    );
  };

  // Renderizar divisor para tarjeta
  const CardDivider = ({ children }: { children: React.ReactNode }) => {
    return (
      <div 
        style={{
          borderBottom: darkMode ? '1px solid rgba(255, 255, 255, 0.1)' : '1px solid rgba(0, 0, 0, 0.1)',
          paddingBottom: '0.5rem',
          marginBottom: '0.5rem'
        }}
        data-component-name="DashboardEnhanced"
      >
        {children}
      </div>
    );
  };

  return (
    <div 
      className={`dashboard-container ${darkMode ? 'theme-dark' : 'theme-light'}`} 
      data-component-name="DashboardEnhanced"
    >
      {/* Botón para cambiar tema */}
      <button 
        onClick={toggleTheme} 
        style={{
          position: 'fixed',
          bottom: '6rem',
          left: '1rem',
          backgroundColor: darkMode ? '#374151' : '#e5e7eb',
          color: darkMode ? 'white' : 'black',
          padding: '0.75rem',
          borderRadius: '9999px',
          boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
          zIndex: 20,
          border: 'none',
          cursor: 'pointer',
          fontSize: '1.2rem',
        }}
      >
        {darkMode ? '☀️' : '🌙'}
      </button>
      {/* Sección de logs para desarrollo - COMPLETAMENTE ELIMINADA */}
      {false && (
        <div className="log-container" style={{ maxHeight: '200px', overflow: 'auto' }}>
          <h3 className="text-lg font-bold mb-2">Logs de desarrollo</h3>
          {requestLogs.map((log, index) => (
            <div key={index} className="text-sm mb-1">{log}</div>
          ))}
        </div>
      )}

      {/* SECCIÓN 1: Resumen General - Estadísticas clave */}
      <SectionTitle number="1" title="Resumen General" />
      <div className="stats-grid-lg">
        {loading.stats || loading.partos ? (
          <div className="col-span-12 text-center py-4">Cargando resumen general...</div>
        ) : (error.stats || error.partos) ? (
          <div className="col-span-12 text-center py-4 text-red-500">
            Error al cargar estadísticas: {error.stats || error.partos}
          </div>
        ) : (statsData && partosData) ? (
          <>
            {/* Tarjeta de resumen de animales */}
            <div className="dashboard-card" style={{ gridColumn: "span 4" }}>
              <h3 className="text-lg font-semibold mb-4">Resumen de Animales</h3>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0.75rem" }}>
                <div style={{
                  backgroundColor: "#3b82f6",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Total Animales</div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.total}</div>
                </div>
                <div style={{
                  backgroundColor: "#10b981",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Animales Vivos</div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.por_estado["OK"] || 0}</div>
                </div>
                <div style={{
                  backgroundColor: "#6366f1",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Toros</div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.machos}</div>
                </div>
                <div style={{
                  backgroundColor: "#8b5cf6",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Vacas</div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.hembras}</div>
                </div>
              </div>
            </div>
            
            {/* Tarjeta de estado de amamantamiento */}
            <div className="dashboard-card" style={{ gridColumn: "span 4" }}>
              <h3 className="text-lg font-semibold mb-4">Estado de Amamantamiento</h3>
              {statsData.animales.por_alletar ? (
                <div style={{ display: "grid", gridTemplateColumns: "1fr", gap: "0.75rem" }}>
                  <div style={{
                    backgroundColor: "#fbbf24",
                    padding: "1rem",
                    borderRadius: "0.5rem",
                    color: "white"
                  }}>
                    <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Vacas Sin Amamantar</div>
                    <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.por_alletar["0"] || 0}</div>
                  </div>
                  <div style={{
                    backgroundColor: "#f59e0b",
                    padding: "1rem",
                    borderRadius: "0.5rem",
                    color: "white"
                  }}>
                    <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Vacas con Un Ternero</div>
                    <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.por_alletar["1"] || 0}</div>
                  </div>
                  <div style={{
                    backgroundColor: "#ef4444",
                    padding: "1rem",
                    borderRadius: "0.5rem",
                    color: "white"
                  }}>
                    <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Vacas con Dos Terneros</div>
                    <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{statsData.animales.por_alletar["2"] || 0}</div>
                  </div>
                </div>
              ) : (
                <div className="text-center py-4 text-gray-500">No hay datos de amamantamiento disponibles</div>
              )}
            </div>
            
            {/* Gráfico de distribución*/}
            <div className="dashboard-card" style={{ gridColumn: "span 4" }}>
              <h3 className="text-lg font-semibold mb-4">Análisis Poblacional</h3>
              <div className="h-64 flex items-center justify-center">
                {renderGenderChart({
                  'Toros': statsData.animales.machos,
                  'Vacas': statsData.animales.hembras,
                  'Fallecidos': statsData.animales.por_estado["DEF"] || 0
                })}
              </div>
              <div style={{ textAlign: "center", marginTop: "0.5rem", fontSize: "0.875rem", color: darkMode ? "#9ca3af" : "#6b7280" }}>
                Ratio Machos/Hembras: <span style={{ fontWeight: "bold" }}>{statsData.animales.ratio_m_h.toFixed(2)}</span>
              </div>
            </div>
          </>
        ) : (
          <div className="col-span-12 text-center py-4 text-gray-500">No hay datos disponibles</div>
        )}
      </div>
      
      {/* SECCIÓN 2: Análisis de Partos */}
      <SectionTitle number="2" title="Análisis de Partos" />
      <div className="stats-grid-lg">
        {loading.partos ? (
          <div className="col-span-12 text-center py-4">Cargando datos de partos...</div>
        ) : error.partos ? (
          <div className="col-span-12 text-center py-4 bg-yellow-100 dark:bg-yellow-900 p-3 rounded border border-yellow-300 dark:border-yellow-700">
            <h3 className="font-bold mb-2">Aviso: Datos parcialmente disponibles</h3>
            <p className="text-sm">
              Algunos datos de partos no están disponibles temporalmente debido a un problema técnico. 
              El equipo técnico está trabajando en solucionarlo.
            </p>
            <p className="text-xs mt-2 text-gray-500 dark:text-gray-400">Detalles técnicos: {error.partos}</p>
          </div>
        ) : partosData ? (
          <>
            {/* Tarjeta de estadísticas clave de partos */}
            <div className="dashboard-card" style={{ gridColumn: "span 4" }}>
              <h3 className="text-lg font-semibold mb-4">Resumen de Partos</h3>
              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "0.75rem" }}>
                <div style={{
                  backgroundColor: "#4f46e5",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Total Partos</div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{partosData.total}</div>
                </div>
                <div style={{
                  backgroundColor: "#06b6d4",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  {/* Usando el nombre del mes actual */}
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>
                    {new Date().toLocaleString('es-ES', { month: 'long' })}
                  </div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{partosData.ultimo_mes}</div>
                </div>
                <div style={{
                  backgroundColor: "#0ea5e9",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  {/* Usando el año actual */}
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>
                    {new Date().getFullYear()}
                  </div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{partosData.ultimo_año}</div>
                </div>
                <div style={{
                  backgroundColor: "#14b8a6",
                  padding: "1rem",
                  borderRadius: "0.5rem",
                  color: "white"
                }}>
                  <div style={{ fontSize: "0.875rem", marginBottom: "0.25rem" }}>Supervivencia</div>
                  <div style={{ fontSize: "1.5rem", fontWeight: "bold" }}>{partosData.tasa_supervivencia.toFixed(1)}%</div>
                </div>
              </div>
            </div>
            
            {/* Gráfico de distribución mensual */}
            <div className="dashboard-card" style={{ gridColumn: "span 8" }}>
              <h3 className="text-lg font-semibold mb-4">Distribución Mensual de Partos</h3>
              <div className="h-64">
                {renderMonthlyChart(partosData.por_mes)}
              </div>
              <div style={{ textAlign: "center", marginTop: "0.5rem", fontSize: "0.875rem", color: darkMode ? "#9ca3af" : "#6b7280" }}>
                Promedio mensual: <span style={{ fontWeight: "bold" }}>{partosData.promedio_mensual.toFixed(1)}</span> partos
              </div>
            </div>
            
            {/* Género de crías */}
            <div className="dashboard-card" style={{ gridColumn: "span 6" }}>
              <h3 className="text-lg font-semibold mb-4">Distribución por Género</h3>
              <div style={{marginBottom: "10px", fontSize: "12px", color: "gray"}}>
                {/* Depuración de datos */}
                Datos por_genero_cria: {JSON.stringify(partosData.por_genero_cria)}
              </div>
              <div className="h-64 flex items-center justify-center">
                {renderGenderChart({
                  'Machos': partosData.por_genero_cria?.M || 0,
                  'Hembras': partosData.por_genero_cria?.F || 0,
                  'Esforradas': partosData.por_genero_cria?.esforrada || 0
                })}
              </div>
            </div>
            
            {/* Distribución anual */}
            <div className="dashboard-card" style={{ gridColumn: "span 6" }}>
              <h3 className="text-lg font-semibold mb-4">Evolución Anual</h3>
              <div className="h-64">
                {renderYearlyChart(partosData.distribucion_anual)}
              </div>
            </div>
            
            {/* Top animales si hay datos */}
            {partosData.por_animal && partosData.por_animal.length > 0 && (
              <div className="dashboard-card" style={{ gridColumn: "span 12" }}>
                <h3 className="text-lg font-semibold mb-4">Top Animales por Partos</h3>
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(250px, 1fr))", gap: "1rem" }}>
                  {partosData.por_animal.slice(0, 5).map((animal, index) => (
                    <div key={index} style={{
                      backgroundColor: darkMode ? "#1f2937" : "#f3f4f6",
                      padding: "1rem",
                      borderRadius: "0.5rem",
                      border: darkMode ? "1px solid #374151" : "1px solid #e5e7eb"
                    }}>
                      <div style={{ fontWeight: "bold", marginBottom: "0.5rem" }}>{animal.nom}</div>
                      <div style={{ fontSize: "0.875rem" }}>
                        ID: {animal.id} <span style={{ float: "right", fontWeight: "bold" }}>{animal.count} partos</span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </>
        ) : (
          <div className="col-span-12 text-center py-4 text-gray-500">No hay datos de partos disponibles</div>
        )}
      </div>
      
      {/* SECCIÓN 3: Top Explotaciones */}
      <SectionTitle number="3" title="Principales Explotaciones" />
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(300px, 1fr))", gap: "1rem", margin: "1rem 0" }}>
        {loading.explotaciones ? (
          <div style={{ gridColumn: "1 / -1", textAlign: "center", padding: "2rem", backgroundColor: darkMode ? "#1f2937" : "#f9fafb", borderRadius: "0.5rem" }}>
            <div style={{ fontSize: "1rem", marginBottom: "0.5rem" }}>Cargando explotaciones...</div>
            <div style={{ width: "2rem", height: "2rem", borderRadius: "50%", border: "2px solid #6366f1", borderTopColor: "transparent", animation: "spin 1s linear infinite", margin: "0 auto" }}></div>
          </div>
        ) : error.explotaciones ? (
          <div style={{ gridColumn: "1 / -1", textAlign: "center", padding: "1rem", backgroundColor: darkMode ? "#991b1b" : "#fee2e2", color: darkMode ? "#fecaca" : "#991b1b", borderRadius: "0.5rem" }}>
            Error al cargar explotaciones: {error.explotaciones}
          </div>
        ) : explotaciones.length > 0 ? (
          explotaciones.map((expl, index) => (
            <div key={index} style={{
              backgroundColor: darkMode ? "#1f2937" : "#ffffff",
              borderRadius: "0.5rem",
              boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)",
              border: darkMode ? "1px solid #374151" : "1px solid #e5e7eb",
              overflow: "hidden"
            }}>
              {/* Cabecera */}
              <div style={{
                backgroundColor: index === 0 ? "#4f46e5" : (index === 1 ? "#2563eb" : "#3b82f6"),
                color: "white",
                padding: "1rem",
                position: "relative"
              }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                  <h3 style={{ fontSize: "1.25rem", fontWeight: "bold", margin: 0 }}>
                    {expl.nombre || expl.explotacio}
                  </h3>
                  <div style={{ 
                    backgroundColor: "rgba(255, 255, 255, 0.3)", 
                    borderRadius: "9999px", 
                    width: "1.75rem", 
                    height: "1.75rem", 
                    display: "flex", 
                    alignItems: "center", 
                    justifyContent: "center",
                    fontWeight: "bold"
                  }}>
                    #{index + 1}
                  </div>
                </div>
                <div style={{ fontSize: "0.875rem", marginTop: "0.25rem" }}>Código: {expl.explotacio}</div>
              </div>
              
              {/* Detalles */}
              <div style={{ padding: "1rem" }}>
                <div style={{ 
                  display: "grid", 
                  gridTemplateColumns: "1fr 1fr", 
                  gap: "0.5rem", 
                  marginBottom: "0.5rem",
                  textAlign: "center"
                }}>
                  <div style={{
                    backgroundColor: darkMode ? "#374151" : "#f3f4f6",
                    padding: "0.75rem",
                    borderRadius: "0.375rem"
                  }}>
                    <div style={{ fontSize: "0.875rem", color: darkMode ? "#9ca3af" : "#6b7280", marginBottom: "0.25rem" }}>Total Animales</div>
                    <div style={{ fontSize: "1.25rem", fontWeight: "bold" }}>{expl.total_animales || 0}</div>
                  </div>
                  <div style={{
                    backgroundColor: darkMode ? "#374151" : "#f3f4f6",
                    padding: "0.75rem",
                    borderRadius: "0.375rem"
                  }}>
                    <div style={{ fontSize: "0.875rem", color: darkMode ? "#9ca3af" : "#6b7280", marginBottom: "0.25rem" }}>Total Partos</div>
                    <div style={{ fontSize: "1.25rem", fontWeight: "bold" }}>{expl.total_partos || 0}</div>
                  </div>
                </div>
                
                {/* Distribución (se podría añadir si tuviéramos esos datos) */}
                <div style={{ display: "flex", justifyContent: "space-between", fontSize: "0.875rem", color: darkMode ? "#9ca3af" : "#6b7280" }}>
                  <div>Código de explotación: {expl.explotacio}</div>
                </div>
              </div>
            </div>
          ))
        ) : (
          <div className="col-span-3 text-center py-4 text-gray-500">No hay explotaciones disponibles</div>
        )}
      </div>
      
      {/* Estadísticas Combinadas - COMPLETAMENTE ELIMINADAS */}
      {false && (
        <>
          <SectionTitle number="7" title="Estadísticas Combinadas" />
          <div className="combined-stats-grid">
            {loading.combined ? (
              <div className="col-span-2 text-center py-4">Cargando estadísticas combinadas...</div>
            ) : error.combined ? (
              <div className="col-span-2 text-center py-4 text-red-500">{error.combined}</div>
            ) : combinedData ? (
              <>
                <div className="dashboard-card">
                  <h3 className="text-lg font-semibold mb-4">Rendimiento de Partos</h3>
                  <div className="grid grid-cols-2 gap-4">
                    {Object.entries(combinedData?.rendimiento_partos || {}).map(([key, value], index) => (
                      <div key={index} className="card-divider">
                        <div className="card-label">{key}</div>
                        <div className="text-xl font-bold">{typeof value === 'number' ? value.toFixed(2) : value}</div>
                      </div>
                    ))}
                  </div>
                </div>
                
                <div className="dashboard-card">
                  <h3 className="text-lg font-semibold mb-4">Tendencias</h3>
                  <div className="h-64">
                    {combinedData?.tendencias && Object.keys(combinedData?.tendencias || {}).length > 0 && 
                      renderTrendChart(Object.values(combinedData?.tendencias || {})[0])}
                  </div>
                </div>
              </>
            ) : (
              <div className="col-span-2 text-center py-4 text-gray-500">No hay datos combinados disponibles</div>
            )}
          </div>
        </>
      )}
      
      {/* Período de análisis */}
      <div className="dashboard-card mb-8">
        <h3 className="text-lg font-semibold mb-2">Período de Análisis</h3>
        <div className="flex justify-between items-center">
          <div>
            <div className="card-label">Desde</div>
            <div className="text-lg font-semibold">
              {resumenData?.periodo?.inicio ? new Date(resumenData.periodo.inicio).toLocaleDateString() : 'N/A'}
            </div>
          </div>
          <div>
            <div className="card-label">Hasta</div>
            <div className="text-lg font-semibold">
              {resumenData?.periodo?.fin ? new Date(resumenData.periodo.fin).toLocaleDateString() : 'N/A'}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default DashboardEnhanced;
