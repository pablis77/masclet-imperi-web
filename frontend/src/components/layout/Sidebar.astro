---
// Props que pueden ser pasados al componente
interface Props {
  userRole?: string;
  currentPath?: string;
}

// Valores por defecto
const { 
  userRole = "administrador",
  currentPath = "/"
} = Astro.props;

// Importar config de idioma
import { getCurrentLanguage } from '../../i18n/config';

// Obtener el idioma actual en el servidor para la renderizaciÃ³n inicial
const serverLang = getCurrentLanguage();

// Traducciones para tÃ­tulos de secciones
const sectionTitles = {
  es: {
    navigation: "NAVEGACIÃ“N",
    admin: "ADMINISTRACIÃ“N"
  },
  ca: {
    navigation: "NAVEGACIÃ“",
    admin: "ADMINISTRACIÃ“"
  }
};

// Traducciones para items del menÃº
const menuTranslations = {
  es: {
    dashboard: "Dashboard",
    animals: "Animales",
    listings: "Listados",
    exploitations: "Explotaciones",
    users: "Usuarios",
    imports: "ImportaciÃ³n",
    backup: "Copias de seguridad",
    management_system: "Sistema de GestiÃ³n Ganadera"
  },
  ca: {
    dashboard: "Tauler de control",
    animals: "Animals",
    listings: "Llistats",
    exploitations: "Explotacions",
    users: "Usuaris",
    imports: "ImportaciÃ³",
    backup: "CÃ²pies de seguretat",
    management_system: "Sistema de GestiÃ³ Ramadera"
  }
};

// FunciÃ³n para obtener traducciÃ³n
function t(key: string, section = 'menu'): string {
  if (section === 'section') {
    return sectionTitles[serverLang as 'es' | 'ca']?.[key] || key;
  }
  return menuTranslations[serverLang as 'es' | 'ca']?.[key] || key;
}

// Definir las secciones del menÃº segÃºn roles
const menuSections = [
  {
    title: t("navigation", 'section'),
    key: "navigation",
    items: [
      { name: t("dashboard"), key: "dashboard", url: "/", icon: "ðŸ“Š", roles: ["administrador", "gerente", "editor", "usuario"] },
      { name: t("exploitations"), key: "exploitations", url: "/explotaciones-react", icon: "ðŸ¡", roles: ["administrador", "gerente", "editor", "usuario"] },
      { name: t("animals"), key: "animals", url: "/animals", icon: "ðŸ„", roles: ["administrador", "gerente", "editor", "usuario"] },
      { name: t("listings"), key: "listings", url: "/listados", icon: "ðŸ“‹", roles: ["administrador", "gerente", "editor", "usuario"] },
    ]
  },
  {
    title: t("admin", 'section'),
    key: "admin",
    items: [
      { name: t("imports"), key: "imports", url: "/imports", icon: "ðŸ“¥", roles: ["administrador"] },
      { name: t("users"), key: "users", url: "/users", icon: "ðŸ‘¥", roles: ["administrador", "gerente"] },
      { name: t("backup"), key: "backup", url: "/backup", icon: "ðŸ’¾", roles: ["administrador"] },
    ]
  }
];

// Importar getCurrentUserRole con nombre diferente para evitar conflictos
import { getCurrentUserRole as getUserRole } from '../../services/authService';

// Obtener el rol del usuario actual desde el servicio de autenticaciÃ³n
let currentUserRole = 'usuario';

// Verificar si estamos en un entorno de navegador (client-side)
if (typeof window !== 'undefined') {
  // Ejecutar esto solo en el cliente para evitar problemas de hidrataciÃ³n
  document.addEventListener('DOMContentLoaded', () => {
    currentUserRole = getUserRole();
    console.log('Rol actual:', currentUserRole);
  });
}

// Filtrar las secciones segÃºn el rol del usuario
// Por ahora mostramos todos los elementos para evitar problemas de hidrataciÃ³n
// El filtrado real ocurrirÃ¡ en el cliente via JavaScript
const filteredSections = menuSections;

// FunciÃ³n para determinar si un elemento estÃ¡ activo
const isActive = (itemUrl: string) => {
  if (itemUrl === '/' && currentPath === '/') return true;
  if (itemUrl !== '/' && currentPath.startsWith(itemUrl)) return true;
  return false;
};
---

<aside class="masclet-sidebar w-64 bg-white dark:bg-gray-800 min-h-screen shadow-md border-r border-gray-100 dark:border-gray-800 z-40 fixed top-0 left-0 h-screen overflow-y-auto">
  <!-- Cabecera del sidebar con logo -->
  <div class="py-4 px-0 border-b border-gray-100 dark:border-gray-700 flex items-center justify-center" style="min-height: 150px;">
    <div class="w-full h-full flex items-center justify-center">
      <img src="/images/logo_masclet.png" alt="Masclet Imperi Logo" class="max-w-full max-h-full" style="object-fit: contain;">
    </div>
  </div>

  <!-- BotÃ³n para cerrar el sidebar en mÃ³vil -->
  <button id="close-sidebar" class="md:hidden absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
    <span class="text-2xl">âœ•</span>
  </button>

  <!-- TÃ­tulo del sistema -->
  <div class="px-6 pt-4 pb-2 text-center">
    <p class="font-bold text-sm text-gray-700 dark:text-gray-300 uppercase tracking-wider">
      {serverLang === 'ca' ? menuTranslations.ca.management_system : menuTranslations.es.management_system}
    </p>
  </div>
  
  <!-- NavegaciÃ³n -->
  <nav class="py-2 overflow-y-auto max-h-[calc(100vh-240px)]">
    {filteredSections.map((section) => (
      <div class="mb-6">
        {section.key === "navigation" ? (
          <h3 class="px-6 mb-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-section-key="navigation" id="nav-title">
            NAVEGACIÃ“N
          </h3>
        ) : (
          <h3 class="px-6 mb-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider" data-section-key={section.key}>
            {section.title}
          </h3>
        )}
        <div class="space-y-1">
          {section.items.map((item) => (
            <a 
              href={item.url} 
              class:list={[
                "flex items-center px-6 py-3 text-sm font-medium transition-colors duration-150",
                {
                  "text-primary-dark bg-primary/10 dark:text-primary-light dark:bg-primary-dark/20 border-r-4 border-primary dark:border-primary-light": isActive(item.url),
                  "text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700": !isActive(item.url)
                }
              ]}
            >
              <span class="text-xl mr-3" style="width: 2rem; display: inline-block; text-align: center;">{item.icon}</span>
              {item.name}
            </a>
          ))}
        </div>
      </div>
    ))}
  </nav>

  <!-- Eliminado banner de versiÃ³n -->
</aside>

<script>
  // Script para manejar el cierre del sidebar en mÃ³vil y traducir elementos
  document.addEventListener('DOMContentLoaded', () => {
    // El sistema de permisos original estaba ocultando todos los elementos
    // Desactivamos temporalmente el filtrado para solucionar el problema
    
    // NOTA: Vamos a simplificar el enfoque para permitir a todos los usuarios ver todas las opciones
    // En el futuro, implementaremos un sistema mÃ¡s robusto con roles desde el backend
    
    /*
    // CÃ“DIGO COMENTADO - Sistema de filtrado que estaba causando problemas
    const userRole = localStorage.getItem('userRole') || 'usuario';
    console.log('Rol detectado para filtrado:', userRole);
    
    // AÃ±adir atributo data-roles a cada elemento del menÃº
    const menuLinks = document.querySelectorAll('nav a');
    menuLinks.forEach(link => {
      const href = link.getAttribute('href');
      // Asignar roles permitidos segÃºn la URL
      if (href === '/' || href.includes('/animals') || href.includes('/explotaciones') || href.includes('/listados')) {
        // PÃ¡ginas accesibles para todos los roles
        link.setAttribute('data-roles', 'administrador,gerente,editor,usuario');
      } else if (href.includes('/users')) {
        // Usuarios: solo admin y gerente (Ramon)
        link.setAttribute('data-roles', 'administrador,gerente');
      } else {
        // El resto de pÃ¡ginas administrativas: solo admin
        link.setAttribute('data-roles', 'administrador');
      }
    });
    */
    
    // Traducciones del menÃº para cliente - sin incluir tÃ­tulos de secciones
    const translations = {
      es: {
        // MenÃº principal
        dashboard: "Dashboard",
        animals: "Animales",
        listings: "Listados",
        exploitations: "Explotaciones",
        // MenÃº administrativo
        users: "Usuarios",
        imports: "ImportaciÃ³n",
        backup: "Copias de seguridad",
        // TÃ­tulos
        management_system: "Sistema de GestiÃ³n",
        // Roles
        administrador: "Administrador",
        gerente: "Ramon",
        editor: "Editor",
        usuario: "Usuario"
      },
      ca: {
        // MenÃº principal
        dashboard: "Tauler de control",
        animals: "Animals",
        listings: "Llistats",
        exploitations: "Explotacions",
        // MenÃº administrativo
        users: "Usuaris",
        imports: "ImportaciÃ³",
        backup: "CÃ²pies de seguretat",
        // TÃ­tulos
        management_system: "Sistema de GestiÃ³",
        // Roles
        administrador: "Administrador",
        gerente: "Ramon",
        editor: "Editor",
        usuario: "Usuari"
      }
    };

    // FunciÃ³n para traducir
    function t(key, lang) {
      return translations[lang]?.[key] || key;
    }

    // FunciÃ³n para traducir la barra lateral
    function translateSidebar() {
      const currentLang = localStorage.getItem('userLanguage') || 'es';

      // Forzar directamente el tÃ­tulo de navegaciÃ³n por ID
      const navTitle = document.getElementById('nav-title');
      if (navTitle) {
        navTitle.textContent = "NAVEGACIÃ“N";
      }
      
      // Forzar los tÃ­tulos de secciones por atributo data
      document.querySelectorAll('h3[data-section-key="navigation"]').forEach(header => {
        header.textContent = "NAVEGACIÃ“N";
      });
      
      document.querySelectorAll('h3[data-section-key="admin"]').forEach(header => {
        header.textContent = "ADMINISTRACIÃ“N";
      });

      // Traducir los elementos del menÃº lateral
      document.querySelectorAll('nav a').forEach(link => {
        const text = link.textContent.trim();
        // Extraer el emoji si existe
        const emoji = text.match(/^([\u{1F300}-\u{1F5FF}\u{1F900}-\u{1F9FF}\u{1F600}-\u{1F64F}\u{1F680}-\u{1F6FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F1E6}-\u{1F1FF}\u{1F191}-\u{1F251}\u{1F004}\u{1F0CF}\u{1F170}-\u{1F171}\u{1F17E}-\u{1F17F}\u{1F18E}\u{3030}\u{2B50}\u{2B55}\u{2934}-\u{2935}\u{2B05}-\u{2B07}\u{2B1B}-\u{2B1C}\u{3297}\u{3299}\u{303D}\u{00A9}\u{00AE}\u{2122}\u{23F3}\u{24C2}\u{23E9}-\u{23EF}\u{25B6}\u{23F8}-\u{23FA}]+)/u);
        const emojiPrefix = emoji ? emoji[0] + ' ' : '';

        // Mapear los nombres del menÃº a claves de traducciÃ³n
        let translationKey = '';
        if (text.includes('Dashboard')) translationKey = 'dashboard';
        else if (text.includes('Animales')) translationKey = 'animals';
        else if (text.includes('Explotaciones')) translationKey = 'exploitations';
        else if (text.includes('Usuarios')) translationKey = 'users';
        else if (text.includes('ImportaciÃ³n')) translationKey = 'imports';
        else if (text.includes('Backup') || text.includes('Copias')) translationKey = 'backup';

        if (translationKey) {
          link.innerHTML = `${emojiPrefix} ${t(translationKey, currentLang)}`;
        }
      });

      // Traducir el texto del sistema de gestiÃ³n
      const systemText = document.querySelector('p.text-sm.text-gray-500.dark\\:text-gray-300.text-center');
      if (systemText) {
        systemText.textContent = t('management_system', currentLang);
      }
    }

    // Ejecutar traducciÃ³n inicial
    translateSidebar();
    
    // Forzar el tÃ­tulo de navegaciÃ³n cada segundo para evitar que algo lo cambie
    setInterval(() => {
      document.querySelectorAll('h3[data-section-key="navigation"]').forEach(header => {
        if (header.textContent !== "NAVEGACIÃ“N") {
          console.log('Corrigiendo tÃ­tulo de navegaciÃ³n');
          header.textContent = "NAVEGACIÃ“N";
        }
      });
    }, 1000);

    // Retraducir cuando cambie el idioma
    window.addEventListener('storage', function(e) {
      if (e.key === 'userLanguage') {
        translateSidebar();
      }
    });

    // FunciÃ³n para cerrar sidebar en mÃ³vil
    const closeSidebarButton = document.getElementById('close-sidebar');
    
    if (closeSidebarButton) {
      closeSidebarButton.addEventListener('click', () => {
        // Disparar un evento personalizado para cerrar el sidebar
        document.dispatchEvent(new CustomEvent('close-sidebar'));
      });
    }
  });
</script>

<style>
  /* Estilos especÃ­ficos del sidebar */
  .masclet-sidebar {
    transition: transform 0.3s ease-in-out;
  }
  
  @media (max-width: 768px) {
    .masclet-sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 80%; /* Reducir ancho en mÃ³vil para mejor usabilidad */
      max-width: 280px;
    }
  }
</style>