---
// Importar el layout y componentes
import MainLayout from '../../components/layout/MainLayout.astro';
import animalService from '../../services/animalService';

// Obtener el ID del animal de los par√°metros de la URL
const { id } = Astro.params;

// Definir t√≠tulo y rol de usuario
const title = "Ficha de Animal";
const userRole = "administrador"; // Simulaci√≥n de rol

// Variables para almacenar datos y estado
let animal = null;
let error = null;
let loading = true;

try {
  if (!id || isNaN(parseInt(id))) {
    throw new Error('ID de animal no v√°lido');
  }

  // Intentar cargar los datos del animal
  console.log(`Intentando cargar animal con ID: ${id}`);
  animal = await animalService.getAnimalById(parseInt(id));
  console.log('Animal cargado:', animal);
  
  if (!animal) {
    throw new Error('No se pudo encontrar el animal');
  }
  
  loading = false;
} catch (e) {
  console.error('Error al cargar datos del animal:', e);
  error = e.message || 'Error al cargar los datos del animal';
  loading = false;
}

// Variables para controlar pesta√±as
const showPartosTab = animal && animal.genere === 'F'; // Solo mostrar pesta√±a de partos para hembras

// Obtener el icono del animal
const icon = animal ? animalService.getAnimalIcon(animal) : 'üêÇ';

// Obtener la clase CSS para el estado del animal
const estadoClass = animal ? animalService.getAnimalStatusClass(animal.estado) : 'bg-gray-100 text-gray-800';

---

<MainLayout title={title} userRole={userRole} currentPath="/animals">
  <div class="mb-6">
    <div class="flex items-center gap-2 mb-2">
      <a href="/animals" class="flex items-center text-primary hover:text-primary/80 dark:text-primary-light dark:hover:text-primary transition-colors">
        <span class="mr-1">‚Üê</span> Volver al listado
      </a>
    </div>
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{title}</h1>
    <p class="text-gray-600 dark:text-gray-300">ID Animal: {id}</p>
  </div>

  {loading && (
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 p-6 mb-6 flex justify-center items-center">
      <div class="flex items-center space-x-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
        <p>Cargando datos del animal...</p>
      </div>
    </div>
  )}

  {error && (
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 mb-6">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          ‚ö†Ô∏è
        </div>
        <div class="ml-3">
          <h3 class="text-lg font-medium text-red-800 dark:text-red-300">Error</h3>
          <div class="mt-2 text-red-700 dark:text-red-200">
            <p>{error}</p>
          </div>
          <div class="mt-4">
            <button 
              id="retry-button"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            >
              ‚Üª Reintentar
            </button>
          </div>
        </div>
      </div>
    </div>
  )}

  {animal && (
    <>
      <!-- Elemento oculto con datos del animal para el script -->
      <div id="animal-data" class="hidden" 
        data-genere={animal.genere}
        data-tiene-partos={
          (animal.partos && animal.partos.items && animal.partos.items.length > 0) || 
          (animal.partos && Array.isArray(animal.partos) && animal.partos.length > 0) || 
          (animal.parts && Array.isArray(animal.parts) && animal.parts.length > 0) ? 'true' : 'false'
        }
      ></div>
      <!-- Resumen del animal -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-6">
          <!-- Icono y estado -->
          <div class="flex flex-col items-center md:items-start">
            <div class="text-6xl mb-3">{icon}</div>
            <span class={`px-3 py-1 rounded-full ${estadoClass} text-sm font-medium`}>
              {animal.estat === 'ACT' ? 'Activo' : 'Baja'}
            </span>
          </div>
          
          <!-- Informaci√≥n b√°sica -->
          <div class="flex-grow">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{animal.nom}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">C√≥digo</p>
                <p class="font-medium">{animal.cod || 'No disponible'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Sexo</p>
                <p class="font-medium">{animal.genere === 'M' ? 'Macho' : 'Hembra'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Fecha de nacimiento</p>
                <p class="font-medium">{animal.dob ? new Date(animal.dob).toLocaleDateString() : 'No disponible'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Explotaci√≥n</p>
                <p class="font-medium">{animal.explotacio || 'No disponible'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Cuadra</p>
                <p class="font-medium">{animal.quadra || 'No asignada'}</p>
              </div>
              {animal.genere === 'F' && (
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Estado amamantamiento</p>
                  <p class="font-medium">
                    {animal.alletar === '0' ? 'No amamanta' : 
                     animal.alletar === '1' ? 'Amamanta un ternero' : 
                     animal.alletar === '2' ? 'Amamanta dos terneros' : 'No disponible'}
                  </p>
                </div>
              )}
            </div>
          </div>
          
          <!-- Acciones -->
          <div class="flex flex-col gap-2">
            <a href={`/animals/update/${id}`} class="flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
              ‚Üª Actualizar
            </a>
          </div>
        </div>
      </div>

      <!-- Pesta√±as de informaci√≥n detallada -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 overflow-hidden">
        <!-- Pesta√±as de navegaci√≥n -->
        <div class="flex border-b border-gray-200 dark:border-gray-700">
          <button id="tab-info" class="px-6 py-3 text-primary border-b-2 border-primary font-medium">
            Informaci√≥n Completa
          </button>
          {showPartosTab && (
            <button id="tab-partos" class="px-6 py-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
              Historial de Partos
            </button>
          )}
          <button id="tab-changes" class="px-6 py-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
            Historial de Cambios
          </button>
        </div>

        <!-- Contenido de pesta√±as -->
        <div class="p-6">
          <!-- Pesta√±a 1: Informaci√≥n Completa -->
          <div id="content-info">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Datos de Identificaci√≥n</h3>
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">C√≥digo</p>
                    <p class="font-medium">{animal.cod || 'No disponible'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Nombre</p>
                    <p class="font-medium">{animal.nom}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">N√∫mero de Serie</p>
                    <p class="font-medium">{animal.num_serie || 'No disponible'}</p>
                  </div>
                </div>
              </div>
              
              <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Datos Generales</h3>
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Sexo</p>
                    <p class="font-medium">{animal.genere === 'M' ? 'Macho' : 'Hembra'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Fecha de nacimiento</p>
                    <p class="font-medium">
                      {animal.dob ? 
                        (() => {
                          try {
                            const fecha = new Date(animal.dob);
                            // Verificar si es una fecha v√°lida
                            if (!isNaN(fecha.getTime())) {
                              // Formatear DD/MM/YYYY
                              return fecha.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'});
                            }
                            // Si es una cadena con formato DD/MM/YYYY, mostrarla directamente
                            if (typeof animal.dob === 'string' && new RegExp('^\\d{1,2}[/\\-]\\d{1,2}[/\\-]\\d{4}$').test(animal.dob)) {
                              return animal.dob;
                            }
                            return String(animal.dob);
                          } catch (e) {
                            return 'Fecha incorrecta';
                          }
                        })() 
                        : 'No disponible'
                      }
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Estado</p>
                    <p class="font-medium">{animal.estado === 'OK' ? 'Activo' : 'Fallecido'}</p>
                  </div>
                </div>
              </div>
              
              <div>
                <!-- Eliminado encabezado de Ubicaci√≥n -->
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Explotaci√≥n</p>
                    <p class="font-medium">{animal.explotacio || 'No disponible'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Cuadra</p>
                    <p class="font-medium">{animal.quadra || 'No asignada'}</p>
                  </div>
                </div>
              </div>
              
              <div>
                <!-- Eliminado encabezado de Parentesco -->
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Padre</p>
                    <p class="font-medium">{animal.pare || 'No disponible'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Madre</p>
                    <p class="font-medium">{animal.mare || 'No disponible'}</p>
                  </div>
                  {animal.genere === 'F' && (
                    <div>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Estado de amamantamiento</p>
                      <p class="font-medium">
                        {animal.alletar === '0' ? 'No amamanta' : 
                         animal.alletar === '1' ? 'Amamanta a un ternero' : 
                         animal.alletar === '2' ? 'Amamanta a dos terneros' : 'No disponible'}
                      </p>
                    </div>
                  )}
                </div>
              </div>
              
              <!-- Bot√≥n Volver al listado al final de la pesta√±a Informaci√≥n -->
              <div class="mt-6 text-center">
                <a href="/animals" class="inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
                  <span class="mr-2">‚Üê</span> Volver al listado de animales
                </a>
              </div>
            </div>
          </div>

          <!-- Pesta√±a 2: Historial de Partos (oculta por defecto) -->
          <div id="content-partos" class="hidden">
            <div class="mb-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Historial de Partos</h3>
              <p class="text-gray-500 dark:text-gray-400">Registro de todos los partos del animal</p>
            </div>
            {showPartosTab && (
              
              <div class="overflow-x-auto">
                <table id="tabla-partos" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer" id="sort-fecha">
                        Fecha <span class="ml-1 sort-indicator">‚Üë</span>
                      </th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer" id="sort-genero">G√©nero</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer" id="sort-estado">Estado</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ficha Ternero</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {animal && (() => {
                      // Manejar diferentes estructuras posibles de partos
                      let partosArray = [];
                      
                      if (animal.partos && animal.partos.items && animal.partos.items.length > 0) {
                        // Estructura esperada: animal.partos.items[]
                        partosArray = animal.partos.items;
                      } else if (animal.partos && Array.isArray(animal.partos) && animal.partos.length > 0) {
                        // Estructura alternativa: animal.partos[]
                        partosArray = animal.partos;
                      } else if (animal.parts && Array.isArray(animal.parts) && animal.parts.length > 0) {
                        // Estructura antigua: animal.parts[]
                        partosArray = animal.parts;
                      }
                      
                      if (partosArray.length > 0) {
                        // Ordenar partos por fecha (de m√°s antiguo a m√°s reciente por defecto)
                        partosArray.sort((a, b) => {
                          const fechaA = a.part ? new Date(a.part) : new Date(0);
                          const fechaB = b.part ? new Date(b.part) : new Date(0);
                          return fechaA - fechaB; // Orden ascendente (m√°s antiguo primero)
                        });
                        
                        return partosArray.map((parto) => (
                          <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                              {parto.part ? 
                                (() => {
                                  try {
                                    if (typeof parto.part === 'string') {
                                      const fecha = new Date(parto.part);
                                      // Verificar si es una fecha v√°lida
                                      if (!isNaN(fecha.getTime())) {
                                        // Formatear DD/MM/YYYY
                                        return fecha.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'});
                                      }
                                      // Si es una cadena con formato DD/MM/YYYY, mostrarla directamente
                                      if (new RegExp('^\\d{1,2}[/\\-]\\d{1,2}[/\\-]\\d{4}$').test(parto.part)) {
                                        return parto.part;
                                      }
                                    }
                                    return String(parto.part);
                                  } catch (e) {
                                    return 'Fecha incorrecta';
                                  }
                                })() 
                                : 'N/A'
                              }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                              {parto.GenereT === 'M' ? 'Macho' : 
                               parto.GenereT === 'F' ? 'Hembra' : 
                               parto.GenereT === 'esforrada' ? 'Esforr√°' : parto.GenereT || 'No disponible'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                              <span class={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                parto.EstadoT === 'OK' ? 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100' : 
                                'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100'
                              }`}>
                                {parto.EstadoT === 'OK' ? 'Vivo' : 'Fallecido'}
                              </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                              No disponible
                            </td>
                          </tr>
                        ));
                      } else {
                        return (
                          <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                              No hay registros de partos para este animal
                            </td>
                          </tr>
                        );
                      }
                    })()}
                  </tbody>
                </table>
              </div>
            )}
            <div class="p-6 text-center text-gray-500 dark:text-gray-400">
              {!showPartosTab && (
                <p>Este animal no tiene partos registrados</p>
              )}
              
              <!-- Bot√≥n Volver al listado al final de la pesta√±a Partos -->
              <div class="mt-6 text-center">
                <a href="/animals" class="inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
                  <span class="mr-2">‚Üê</span> Volver al listado de animales
                </a>
              </div>
            </div>
          </div>

          <!-- Pesta√±a 3: Historial de Cambios (oculta por defecto) -->
          <div id="content-changes" class="hidden">
            <div class="mb-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Historial de Cambios</h3>
              <p class="text-gray-500 dark:text-gray-400">Actualmente no se registran cambios hist√≥ricos en la ficha del animal</p>
            </div>
            
            <div class="p-6 text-center text-gray-500 dark:text-gray-400">
              <p>No hay datos hist√≥ricos disponibles</p>
            </div>
            
            <!-- Bot√≥n Volver al listado al final de la pesta√±a Historial de Cambios -->
            <div class="mt-6 text-center">
              <a href="/animals" class="inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
                <span class="mr-2">‚Üê</span> Volver al listado de animales
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Bot√≥n flotante para volver al listado -->
      <div class="fixed bottom-6 right-6 z-10">
        <a href="/animals" class="flex items-center justify-center w-12 h-12 rounded-full bg-primary text-white shadow-lg hover:bg-primary/80 transition-colors">
          <span class="text-xl">‚Üê</span>
        </a>
      </div>
    </>
  )}
</MainLayout>

<script>
  // Script para manejar interacciones de la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM completamente cargado y analizado');
    
    // Bot√≥n de reintentar carga
    const retryButton = document.getElementById('retry-button');
    if (retryButton) {
      retryButton.addEventListener('click', () => {
        window.location.reload();
      });
    }
    
    // Obtener todas las pesta√±as y contenidos
    const tabs = document.querySelectorAll('#tab-info, #tab-partos, #tab-changes');
    const contents = document.querySelectorAll('#content-info, #content-partos, #content-changes');
    
    console.log('Pesta√±as encontradas:', tabs.length);
    console.log('Contenidos encontrados:', contents.length);
    
    // Funci√≥n para mostrar pesta√±a y ocultar las dem√°s
    const showTab = (tabId) => {
      console.log('Cambiando a pesta√±a:', tabId);
      
      // Ocultar todos los contenidos
      contents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // Resetear estilos de todas las pesta√±as
      tabs.forEach(tab => {
        tab.classList.remove('text-primary', 'border-b-2', 'border-primary', 'font-medium');
        tab.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300');
      });
      
      // Activar pesta√±a seleccionada
      const selectedTab = document.getElementById(tabId);
      if (selectedTab) {
        selectedTab.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300');
        selectedTab.classList.add('text-primary', 'border-b-2', 'border-primary', 'font-medium');
      }
      
      // Mostrar contenido correspondiente
      const contentId = tabId.replace('tab-', 'content-');
      const selectedContent = document.getElementById(contentId);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }
    };
    
    // Inicializar con la pesta√±a de informaci√≥n abierta
    showTab('tab-info');
    
    // Eventos de clic para pesta√±as
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        showTab(tab.id);
        console.log('Clic en pesta√±a:', tab.id);
      });
    });

    // Ordenaci√≥n de la tabla de partos
    const sortColumns = document.querySelectorAll('#sort-fecha, #sort-genero, #sort-estado');
    let currentSortColumn = 'sort-fecha';
    let currentSortDirection = 'asc';

    // Funci√≥n para ordenar la tabla
    const sortTable = (columnId, direction) => {
      const table = document.getElementById('tabla-partos');
      if (!table) return;

      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));
      const sortedRows = [...rows];

      // Obtener el √≠ndice de la columna seg√∫n el ID del encabezado
      let columnIndex = 0;
      if (columnId === 'sort-genero') columnIndex = 1;
      if (columnId === 'sort-estado') columnIndex = 2;

      // Ordenar filas
      sortedRows.sort((a, b) => {
        const cellA = a.querySelectorAll('td')[columnIndex].textContent.trim();
        const cellB = b.querySelectorAll('td')[columnIndex].textContent.trim();
        
        if (columnId === 'sort-fecha') {
          // Para fechas, intentar convertir a objetos Date para comparaci√≥n
          const dateA = parseDate(cellA);
          const dateB = parseDate(cellB);
          
          if (direction === 'asc') {
            return dateA - dateB;
          } else {
            return dateB - dateA;
          }
        } else {
          // Para texto, comparar strings
          if (direction === 'asc') {
            return cellA.localeCompare(cellB, 'es');
          } else {
            return cellB.localeCompare(cellA, 'es');
          }
        }
      });

      // Limpiar y reconstruir la tabla
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }

      sortedRows.forEach(row => tbody.appendChild(row));

      // Actualizar indicadores de ordenaci√≥n
      sortColumns.forEach(col => {
        const indicator = col.querySelector('.sort-indicator');
        if (indicator) {
          indicator.textContent = '';
        }
      });

      const activeHeader = document.getElementById(columnId);
      const indicator = activeHeader.querySelector('.sort-indicator');
      if (indicator) {
        indicator.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
      }
    };

    // Ayudante para convertir texto de fecha a objeto Date
    const parseDate = (dateStr) => {
      if (dateStr === 'N/A' || dateStr === 'Fecha incorrecta') {
        return new Date(0); // Para valores no fechas, usar una fecha muy antigua
      }
      
      // Intenta analizar la fecha en formato DD/MM/YYYY
      const parts = dateStr.split(/[\/\-]/);
      if (parts.length === 3) {
        // Asumir formato DD/MM/YYYY
        return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      
      // Como √∫ltimo recurso, intentar crear fecha directamente
      return new Date(dateStr);
    };

    // Agregar eventos de clic a las columnas
    sortColumns.forEach(col => {
      col.addEventListener('click', () => {
        // Si es la misma columna, cambiar direcci√≥n
        if (col.id === currentSortColumn) {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          // Si es una nueva columna, establecer como ascendente
          currentSortColumn = col.id;
          currentSortDirection = 'asc';
        }
        
        sortTable(currentSortColumn, currentSortDirection);
      });
    });

    // Ordenar por fecha ascendente al cargar la p√°gina
    sortTable('sort-fecha', 'asc');
  });
</script>
