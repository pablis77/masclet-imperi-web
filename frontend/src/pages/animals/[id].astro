---
// Importar el layout y componentes
import MainLayout from '../../components/layout/MainLayout.astro';
import animalService from '../../services/animalService';

// Obtener el ID del animal de los par√°metros de la URL
const { id } = Astro.params;

// Definir t√≠tulo y rol de usuario
const title = "Ficha de Animal";
const userRole = "administrador"; // Simulaci√≥n de rol

// Variables para almacenar datos y estado
let animal = null;
let error = null;
let loading = true;

try {
  if (!id || isNaN(parseInt(id))) {
    throw new Error('ID de animal no v√°lido');
  }

  // Intentar cargar los datos del animal
  console.log(`Intentando cargar animal con ID: ${id}`);
  animal = await animalService.getAnimalById(parseInt(id));
  console.log('Animal cargado:', animal);
  
  if (!animal) {
    throw new Error('No se pudo encontrar el animal');
  }
  
  loading = false;
} catch (e) {
  console.error('Error al cargar datos del animal:', e);
  error = e.message || 'Error al cargar los datos del animal';
  loading = false;
}

// Variables para controlar pesta√±as
const showPartosTab = animal && animal.genere === 'F'; // Solo mostrar pesta√±a de partos para hembras

// Obtener el icono del animal
const icon = animal ? animalService.getAnimalIcon(animal) : 'üêÇ';

// Obtener la clase CSS para el estado del animal
const estadoClass = animal ? animalService.getAnimalStatusClass(animal.estado) : 'bg-gray-100 text-gray-800';

---

<MainLayout title={title} userRole={userRole} currentPath="/animals">
  <div class="mb-6">
    <div class="flex items-center gap-2 mb-2">
      <a href="/animals" class="flex items-center text-primary hover:text-primary/80 dark:text-primary-light dark:hover:text-primary transition-colors">
        <span class="mr-1">‚Üê</span> Volver al listado
      </a>
    </div>
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{title}</h1>
    <p class="text-gray-600 dark:text-gray-300">ID Animal: {id}</p>
  </div>

  {loading && (
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 p-6 mb-6 flex justify-center items-center">
      <div class="flex items-center space-x-2">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
        <p>Cargando datos del animal...</p>
      </div>
    </div>
  )}

  {error && (
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 mb-6">
      <div class="flex items-start">
        <div class="flex-shrink-0">
          ‚ö†Ô∏è
        </div>
        <div class="ml-3">
          <h3 class="text-lg font-medium text-red-800 dark:text-red-300">Error</h3>
          <div class="mt-2 text-red-700 dark:text-red-200">
            <p>{error}</p>
          </div>
          <div class="mt-4">
            <button 
              id="retry-button"
              class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            >
              ‚Üª Reintentar
            </button>
          </div>
        </div>
      </div>
    </div>
  )}

  {animal && (
    <>
      <!-- Elemento oculto con datos del animal para el script -->
      <div id="animal-data" class="hidden" 
        data-genere={animal.genere}
        data-tiene-partos={
          (animal.partos && animal.partos.items && animal.partos.items.length > 0) || 
          (animal.partos && Array.isArray(animal.partos) && animal.partos.length > 0) || 
          (animal.parts && Array.isArray(animal.parts) && animal.parts.length > 0) ? 'true' : 'false'
        }
      ></div>
      <!-- Resumen del animal -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-6">
          <!-- Icono y estado -->
          <div class="flex flex-col items-center md:items-start">
            <div class="text-6xl mb-3">{icon}</div>
            <span class={`px-3 py-1 rounded-full ${estadoClass} text-sm font-medium`}>
              {animal.estat === 'ACT' ? 'Activo' : 'Baja'}
            </span>
          </div>
          
          <!-- Informaci√≥n b√°sica -->
          <div class="flex-grow">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">{animal.nom}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">C√≥digo</p>
                <p class="font-medium">{animal.cod || 'No disponible'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Sexo</p>
                <p class="font-medium">{animal.genere === 'M' ? 'Macho' : 'Hembra'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Fecha de nacimiento</p>
                <p class="font-medium">
                  {animal.dob ? 
                    (() => {
                      try {
                        // Primero verificar si ya viene en formato espa√±ol DD/MM/YYYY
                        if (typeof animal.dob === 'string' && new RegExp('^\\d{1,2}[/\\-]\\d{1,2}[/\\-]\\d{4}$').test(animal.dob)) {
                          // Interpretar como DD/MM/YYYY (formato espa√±ol)
                          const partes = animal.dob.split(/[\/\-]/);
                          if (partes.length === 3) {
                            // Asegurar que se interprete como d√≠a/mes/a√±o
                            const fecha = new Date(parseInt(partes[2]), parseInt(partes[1])-1, parseInt(partes[0]));
                            if (!isNaN(fecha.getTime())) {
                              return `${partes[0].padStart(2, '0')}/${partes[1].padStart(2, '0')}/${partes[2]}`;
                            }
                          }
                          // Si no pudimos procesar pero tiene el formato adecuado, lo mostramos como est√°
                          return animal.dob;
                        }
                        
                        // Intentar procesar otros formatos de fecha
                        const fecha = new Date(animal.dob);
                        if (!isNaN(fecha.getTime())) {
                          return fecha.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'});
                        }
                        
                        return String(animal.dob);
                      } catch (e) {
                        return 'Fecha incorrecta';
                      }
                    })() 
                    : 'No disponible'
                  }
                </p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Explotaci√≥n</p>
                <p class="font-medium">{animal.explotacio || 'No disponible'}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Cuadra</p>
                <p class="font-medium">{animal.quadra || 'No asignada'}</p>
              </div>
              {animal.genere === 'F' && (
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Estado amamantamiento</p>
                  <p class="font-medium">
                    {animal.alletar === '0' ? 'No amamanta' : 
                     animal.alletar === '1' ? 'Amamanta un ternero' : 
                     animal.alletar === '2' ? 'Amamanta dos terneros' : 'No disponible'}
                  </p>
                </div>
              )}
            </div>
          </div>
          
          <!-- Acciones -->
          <div class="flex flex-col gap-2">
            <a href={`/animals/update/${id}`} class="flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
              ‚Üª Actualizar
            </a>
          </div>
        </div>
      </div>

      <!-- Pesta√±as de informaci√≥n detallada -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 overflow-hidden">
        <!-- Pesta√±as de navegaci√≥n -->
        <div class="flex border-b border-gray-200 dark:border-gray-700">
          <button id="tab-info" class="px-6 py-3 text-primary border-b-2 border-primary font-medium">
            Informaci√≥n Completa
          </button>
          {showPartosTab && (
            <button id="tab-partos" class="px-6 py-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
              Historial de Partos
            </button>
          )}
          <button id="tab-changes" class="px-6 py-3 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
            Historial de Cambios
          </button>
        </div>

        <!-- Contenido de pesta√±as -->
        <div class="p-6">
          <!-- Pesta√±a 1: Informaci√≥n Completa -->
          <div id="content-info">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Datos de Identificaci√≥n</h3>
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">C√≥digo</p>
                    <p class="font-medium">{animal.cod || 'No disponible'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Nombre</p>
                    <p class="font-medium">{animal.nom}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">N√∫mero de Serie</p>
                    <p class="font-medium">{animal.num_serie || 'No disponible'}</p>
                  </div>
                </div>
              </div>
              
              <div>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Datos Generales</h3>
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Sexo</p>
                    <p class="font-medium">{animal.genere === 'M' ? 'Macho' : 'Hembra'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Fecha de nacimiento</p>
                    <p class="font-medium">
                      {animal.dob ? 
                        (() => {
                          try {
                            const fecha = new Date(animal.dob);
                            // Verificar si es una fecha v√°lida
                            if (!isNaN(fecha.getTime())) {
                              // Formatear DD/MM/YYYY
                              return fecha.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'});
                            }
                            // Si es una cadena con formato DD/MM/YYYY, mostrarla directamente
                            if (typeof animal.dob === 'string' && new RegExp('^\\d{1,2}[/\\-]\\d{1,2}[/\\-]\\d{4}$').test(animal.dob)) {
                              return animal.dob;
                            }
                            return String(animal.dob);
                          } catch (e) {
                            return 'Fecha incorrecta';
                          }
                        })() 
                        : 'No disponible'
                      }
                    </p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Estado</p>
                    <p class="font-medium">{animal.estado === 'OK' ? 'Activo' : 'Fallecido'}</p>
                  </div>
                </div>
              </div>
              
              <div>
                <!-- Eliminado encabezado de Ubicaci√≥n -->
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Explotaci√≥n</p>
                    <p class="font-medium">{animal.explotacio || 'No disponible'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Cuadra</p>
                    <p class="font-medium">{animal.quadra || 'No asignada'}</p>
                  </div>
                </div>
              </div>
              
              <div>
                <!-- Eliminado encabezado de Parentesco -->
                <div class="space-y-3">
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Padre</p>
                    <p class="font-medium">{animal.pare || 'No disponible'}</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Madre</p>
                    <p class="font-medium">{animal.mare || 'No disponible'}</p>
                  </div>
                  {animal.genere === 'F' && (
                    <div>
                      <p class="text-sm text-gray-500 dark:text-gray-400">Estado de amamantamiento</p>
                      <p class="font-medium">
                        {animal.alletar === '0' ? 'No amamanta' : 
                         animal.alletar === '1' ? 'Amamanta a un ternero' : 
                         animal.alletar === '2' ? 'Amamanta a dos terneros' : 'No disponible'}
                      </p>
                    </div>
                  )}
                </div>
              </div>
              
              <!-- Bot√≥n Volver al listado al final de la pesta√±a Informaci√≥n -->
              <div class="mt-6 text-center">
                <a href="/animals" class="inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
                  <span class="mr-2">‚Üê</span> Volver al listado de animales
                </a>
              </div>
            </div>
          </div>

          <!-- Pesta√±a 2: Historial de Partos (oculta por defecto) -->
          <div id="content-partos" class="hidden">
            <div class="mb-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Historial de Partos</h3>
              <p class="text-gray-500 dark:text-gray-400">Registro de todos los partos del animal</p>
            </div>
            {showPartosTab && (
              
              <div class="overflow-x-auto">
                <table id="tabla-partos" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                  <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer" id="sort-fecha">
                        Fecha <span class="ml-1 sort-indicator">‚Üë</span>
                      </th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer" id="sort-genero">G√©nero</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer" id="sort-estado">Estado</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Observaciones</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {animal && (() => {
                      // Manejar diferentes estructuras posibles de partos
                      let partosArray = [];
                      
                      if (animal.partos && animal.partos.items && animal.partos.items.length > 0) {
                        // Estructura esperada: animal.partos.items[]
                        partosArray = animal.partos.items;
                      } else if (animal.partos && Array.isArray(animal.partos) && animal.partos.length > 0) {
                        // Estructura alternativa: animal.partos[]
                        partosArray = animal.partos;
                      } else if (animal.parts && Array.isArray(animal.parts) && animal.parts.length > 0) {
                        // Estructura antigua: animal.parts[]
                        partosArray = animal.parts;
                      }
                      
                      if (partosArray.length > 0) {
                        // Ordenar partos por fecha (de m√°s antiguo a m√°s reciente por defecto)
                        partosArray.sort((a, b) => {
                          const fechaA = a.part ? new Date(a.part) : new Date(0);
                          const fechaB = b.part ? new Date(b.part) : new Date(0);
                          return fechaA - fechaB; // Orden ascendente (m√°s antiguo primero)
                        });
                        
                        return partosArray.map((parto) => (
                          <tr data-id={parto.id}>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                              {parto.part ? 
                                (() => {
                                  try {
                                    if (typeof parto.part === 'string') {
                                      // Primero verificar si ya viene en formato espa√±ol DD/MM/YYYY
                                      if (new RegExp('^\\d{1,2}[/\\-]\\d{1,2}[/\\-]\\d{4}$').test(parto.part)) {
                                        // Interpretar como DD/MM/YYYY (formato espa√±ol)
                                        const partes = parto.part.split(/[\/\-]/);
                                        if (partes.length === 3) {
                                          // Asegurar que se interprete como d√≠a/mes/a√±o
                                          const fecha = new Date(parseInt(partes[2]), parseInt(partes[1])-1, parseInt(partes[0]));
                                          if (!isNaN(fecha.getTime())) {
                                            return `${partes[0].padStart(2, '0')}/${partes[1].padStart(2, '0')}/${partes[2]}`;
                                          }
                                        }
                                        // Si no pudimos procesar pero tiene el formato adecuado, lo mostramos como est√°
                                        return parto.part;
                                      } else {
                                        // Intentar procesar otros formatos de fecha
                                        const fecha = new Date(parto.part);
                                        if (!isNaN(fecha.getTime())) {
                                          return fecha.toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'});
                                        }
                                      }
                                    }
                                    return String(parto.part);
                                  } catch (e) {
                                    return 'Fecha incorrecta';
                                  }
                                })() 
                                : 'N/A'
                              }
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                              {parto.GenereT === 'M' ? 'Macho' : 
                               parto.GenereT === 'F' ? 'Hembra' : 
                               parto.GenereT === 'esforrada' ? 'Esforr√°' : parto.GenereT || 'No disponible'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                              <span class={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                parto.EstadoT === 'OK' ? 'bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100' : 
                                'bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100'
                              }`}>
                                {parto.EstadoT === 'OK' ? 'Vivo' : 'Fallecido'}
                              </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                              {parto.observacions || parto.observaciones || parto.obs || 'Sin observaciones'}
                            </td>
                          </tr>
                        ));
                      } else {
                        return (
                          <tr>
                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                              No hay registros de partos para este animal
                            </td>
                          </tr>
                        );
                      }
                    })()}
                  </tbody>
                </table>
              </div>
            )}
            <div class="p-6 text-center text-gray-500 dark:text-gray-400">
              {!showPartosTab && (
                <p>Este animal no tiene partos registrados</p>
              )}
              
              <!-- Bot√≥n Volver al listado al final de la pesta√±a Partos -->
              <div class="mt-6 text-center">
                <a href="/animals" class="inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
                  <span class="mr-2">‚Üê</span> Volver al listado de animales
                </a>
              </div>
            </div>
          </div>

          <!-- Pesta√±a 3: Historial de Cambios (oculta por defecto) -->
          <div id="content-changes" class="hidden">
            <div class="mb-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Historial de Cambios</h3>
              <p class="text-gray-500 dark:text-gray-400">Actualmente no se registran cambios hist√≥ricos en la ficha del animal</p>
            </div>
            
            <div class="p-6 text-center text-gray-500 dark:text-gray-400">
              <p>No hay datos hist√≥ricos disponibles</p>
            </div>
            
            <!-- Bot√≥n Volver al listado al final de la pesta√±a Historial de Cambios -->
            <div class="mt-6 text-center">
              <a href="/animals" class="inline-flex items-center justify-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/80 transition-colors">
                <span class="mr-2">‚Üê</span> Volver al listado de animales
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Bot√≥n flotante para volver al listado -->
      <div class="fixed bottom-6 right-6 z-10">
        <a href="/animals" class="flex items-center justify-center w-12 h-12 rounded-full bg-primary text-white shadow-lg hover:bg-primary/80 transition-colors">
          <span class="text-xl">‚Üê</span>
        </a>
      </div>
    </>
  )}
</MainLayout>

<script>
  // Script para manejar interacciones de la p√°gina
  document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM completamente cargado y analizado');
    
    // Bot√≥n de reintentar carga
    const retryButton = document.getElementById('retry-button');
    if (retryButton) {
      retryButton.addEventListener('click', () => {
        window.location.reload();
      });
    }
    
    // Obtener todas las pesta√±as y contenidos
    const tabs = document.querySelectorAll('#tab-info, #tab-partos, #tab-changes');
    const contents = document.querySelectorAll('#content-info, #content-partos, #content-changes');
    
    console.log('Pesta√±as encontradas:', tabs.length);
    console.log('Contenidos encontrados:', contents.length);
    
    // Funci√≥n para mostrar pesta√±a y ocultar las dem√°s
    const showTab = (tabId) => {
      console.log('Cambiando a pesta√±a:', tabId);
      
      // Ocultar todos los contenidos
      contents.forEach(content => {
        content.classList.add('hidden');
      });
      
      // Resetear estilos de todas las pesta√±as
      tabs.forEach(tab => {
        tab.classList.remove('text-primary', 'border-b-2', 'border-primary', 'font-medium');
        tab.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300');
      });
      
      // Activar pesta√±a seleccionada
      const selectedTab = document.getElementById(tabId);
      if (selectedTab) {
        selectedTab.classList.remove('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300');
        selectedTab.classList.add('text-primary', 'border-b-2', 'border-primary', 'font-medium');
      }
      
      // Mostrar contenido correspondiente
      const contentId = tabId.replace('tab-', 'content-');
      const selectedContent = document.getElementById(contentId);
      if (selectedContent) {
        selectedContent.classList.remove('hidden');
      }
    };
    
    // Inicializar con la pesta√±a de informaci√≥n abierta
    showTab('tab-info');
    
    // Eventos de clic para pesta√±as
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        showTab(tab.id);
        console.log('Clic en pesta√±a:', tab.id);
      });
    });

    // Ordenaci√≥n de la tabla de partos
    const sortColumns = document.querySelectorAll('#sort-fecha, #sort-genero, #sort-estado');
    let currentSortColumn = 'sort-fecha';
    let currentSortDirection = 'asc';

    // Funci√≥n para ordenar la tabla
    const sortTable = (columnId, direction) => {
      const table = document.getElementById('tabla-partos');
      if (!table) return;

      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));
      const sortedRows = [...rows];

      // Obtener el √≠ndice de la columna seg√∫n el ID del encabezado
      let columnIndex = 0;
      if (columnId === 'sort-genero') columnIndex = 1;
      if (columnId === 'sort-estado') columnIndex = 2;

      // Ordenar filas
      sortedRows.sort((a, b) => {
        const cellA = a.querySelectorAll('td')[columnIndex].textContent.trim();
        const cellB = b.querySelectorAll('td')[columnIndex].textContent.trim();
        
        if (columnId === 'sort-fecha') {
          // Para fechas, intentar convertir a objetos Date para comparaci√≥n
          const dateA = parseDate(cellA);
          const dateB = parseDate(cellB);
          
          if (direction === 'asc') {
            return dateA - dateB;
          } else {
            return dateB - dateA;
          }
        } else {
          // Para texto, comparar strings
          if (direction === 'asc') {
            return cellA.localeCompare(cellB, 'es');
          } else {
            return cellB.localeCompare(cellA, 'es');
          }
        }
      });

      // Limpiar y reconstruir la tabla
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }

      sortedRows.forEach(row => tbody.appendChild(row));

      // Actualizar indicadores de ordenaci√≥n
      sortColumns.forEach(col => {
        const indicator = col.querySelector('.sort-indicator');
        if (indicator) {
          indicator.textContent = '';
        }
      });

      const activeHeader = document.getElementById(columnId);
      const indicator = activeHeader.querySelector('.sort-indicator');
      if (indicator) {
        indicator.textContent = direction === 'asc' ? '‚Üë' : '‚Üì';
      }
    };

    // Ayudante para convertir texto de fecha a objeto Date
    const parseDate = (dateStr) => {
      if (dateStr === 'N/A' || dateStr === 'Fecha incorrecta') {
        return new Date(0); // Para valores no fechas, usar una fecha muy antigua
      }
      
      // Intenta analizar la fecha en formato DD/MM/YYYY
      const parts = dateStr.split(/[\/\-]/);
      if (parts.length === 3) {
        // Asumir formato DD/MM/YYYY
        return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      
      // Como √∫ltimo recurso, intentar crear fecha directamente
      return new Date(dateStr);
    };

    // Agregar eventos de clic a las columnas
    sortColumns.forEach(col => {
      col.addEventListener('click', () => {
        // Si es la misma columna, cambiar direcci√≥n
        if (col.id === currentSortColumn) {
          currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          // Si es una nueva columna, establecer como ascendente
          currentSortColumn = col.id;
          currentSortDirection = 'asc';
        }
        
        sortTable(currentSortColumn, currentSortDirection);
      });
    });

    // Ordenar por fecha ascendente al cargar la p√°gina
    sortTable('sort-fecha', 'asc');
  });
  // Crear un modal personalizado para interacciones con el usuario
  function crearModalPersonalizado() {
    // Comprobar si ya existe un modal
    let modal = document.getElementById('modal-personalizado');
    if (modal) return modal;
    
    // Crear el modal
    modal = document.createElement('div');
    modal.id = 'modal-personalizado';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 hidden';
    modal.innerHTML = `
      <div class="fixed inset-0 bg-black bg-opacity-25" onclick="document.getElementById('modal-personalizado').classList.add('hidden')"></div>
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-auto z-50 relative shadow-lg">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4" id="modal-titulo"></h3>
        <p class="text-gray-600 dark:text-gray-300 mb-6" id="modal-mensaje"></p>
        <div class="flex justify-end space-x-4">
          <button id="modal-btn-cancelar" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none">Cancelar</button>
          <button id="modal-btn-confirmar" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 focus:outline-none">Confirmar</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
    // Configurar el bot√≥n Cancelar
    const btnCancelar = modal.querySelector('#modal-btn-cancelar');
    btnCancelar.addEventListener('click', function() {
      modal.classList.add('hidden');
    });
    
    return modal;
  }
  
  // Funci√≥n para mostrar una notificaci√≥n
  function mostrarNotificacion(mensaje, tipo = 'success') {
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${tipo === 'success' ? 'bg-green-500' : 'bg-red-500'} z-50 animate-fadeIn`;
    notificacion.textContent = mensaje;
    document.body.appendChild(notificacion);
    
    // Eliminar despu√©s de 3 segundos
    setTimeout(() => {
      notificacion.classList.add('animate-fadeOut');
      setTimeout(() => {
        notificacion.remove();
      }, 500);
    }, 3000);
  }
  
  // A√±adir botones de acciones a la tabla de partos
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado: Inicializando funcionalidades de animal...');
    
    // Agregar estilos para animaciones
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(10px); }
      }
      .animate-fadeIn {
        animation: fadeIn 0.3s ease-out forwards;
      }
      .animate-fadeOut {
        animation: fadeOut 0.3s ease-in forwards;
      }
    `;
    document.head.appendChild(style);
    
    // Crear modal personalizado
    const modal = crearModalPersonalizado();
    
    const tablaPartos = document.getElementById('tabla-partos');
    if (!tablaPartos) return;
    
    const tbody = tablaPartos.querySelector('tbody');
    if (!tbody) return;
    
    // No a√±adir botones si no hay partos (solo hay mensaje de 'no hay registros')
    const filasVacias = tbody.querySelectorAll('tr[data-empty="true"]');
    if (filasVacias.length > 0) return;
    
    // A√±adir columna de acciones al encabezado
    const thead = tablaPartos.querySelector('thead tr');
    if (thead) {
      const thAcciones = document.createElement('th');
      thAcciones.scope = 'col';
      thAcciones.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider';
      thAcciones.textContent = 'Acciones';
      thead.appendChild(thAcciones);
    }
    
    // A√±adir botones a cada fila
    const filas = tbody.querySelectorAll('tr');
    filas.forEach(function(fila) {
      // Si es una fila vac√≠a, no a√±adir botones
      if (fila.getAttribute('data-empty') === 'true') return;
      
      // Extraer el ID del parto - intentaremos obtenerlo de un atributo data-id
      // Si no est√° disponible, usaremos un ID generado
      const partoId = fila.getAttribute('data-id') || `parto-${Math.floor(Math.random() * 1000000)}`;
      
      // Crear celda para botones
      const tdAcciones = document.createElement('td');
      tdAcciones.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400';
      
      // Bot√≥n editar (deshabilitado por ahora)
      const btnEditar = document.createElement('button');
      btnEditar.className = 'bg-gray-100 text-blue-600 py-1 px-3 rounded-md mr-2 text-xs font-medium hover:bg-gray-200 cursor-not-allowed opacity-50 dark:bg-gray-700 dark:text-blue-400 dark:hover:bg-gray-600';
      btnEditar.title = 'Funcionalidad en desarrollo';
      btnEditar.textContent = 'Editar';
      btnEditar.disabled = true;
      
      // Bot√≥n eliminar
      const btnEliminar = document.createElement('button');
      btnEliminar.className = 'bg-gray-100 text-red-600 py-1 px-3 rounded-md text-xs font-medium hover:bg-gray-200 dark:bg-gray-700 dark:text-red-400 dark:hover:bg-gray-600';
      btnEliminar.textContent = 'Eliminar';
      btnEliminar.setAttribute('data-id', partoId);
      btnEliminar.title = 'Eliminar parto';
      
      // A√±adir botones a la celda
      tdAcciones.appendChild(btnEditar);
      tdAcciones.appendChild(btnEliminar);
      
      // A√±adir celda a la fila
      fila.appendChild(tdAcciones);
      
      // Evento para eliminar parto
      btnEliminar.addEventListener('click', function(event) {
        const partoId = this.getAttribute('data-id');
        const fila = this.closest('tr');
        const rect = this.getBoundingClientRect();
        
        // Configurar el modal
        document.getElementById('modal-titulo').textContent = 'Eliminar parto';
        document.getElementById('modal-mensaje').textContent = '¬øSeguro que desea eliminar este parto? Esta acci√≥n no se puede deshacer.';
        
        // Mostrar el modal
        modal.classList.remove('hidden');
        
        // Configurar el bot√≥n Confirmar
        const btnConfirmar = modal.querySelector('#modal-btn-confirmar');
        btnConfirmar.onclick = function() {
          modal.classList.add('hidden');
          console.log('Eliminando parto:', partoId);
          
          const token = localStorage.getItem('token');
          if (!token) {
            mostrarNotificacion('Error: No se ha encontrado el token de autenticaci√≥n', 'error');
            return;
          }
          
          // Obtener el ID del animal de la URL
          const animalIdMatch = window.location.pathname.match(/\/animals\/([0-9]+)/);
          const animalId = animalIdMatch ? animalIdMatch[1] : null;
          
          if (!animalId) {
            alert('Error: No se pudo determinar el ID del animal');
            return;
          }
          
          // Vamos a intentar diferentes rutas de API en orden de prioridad
          const apiUrls = [
            `http://localhost:8000/api/v1/animals/${animalId}/partos/${partoId}`, // Ruta preferida con ID de animal
            `http://localhost:8000/api/v1/partos/${partoId}` // Ruta alternativa
          ];
          
          // Probar con el endpoint principal (animal_id/partos/parto_id)
          console.log(`Intentando eliminar parto ${partoId} del animal ${animalId}`);
          fetch(apiUrls[0], {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          })
          .then(function(response) {
            if (!response.ok) {
              // Si el primer endpoint falla, probar con el endpoint alternativo
              console.log(`Endpoint principal fall√≥ con ${response.status}, intentando endpoint alternativo...`);
              return fetch(apiUrls[1], {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });
            }
            
            // Algunos endpoints no devuelven JSON v√°lido
            return response.json().catch(() => ({ success: true }));
          })
          .then(function(responseOrData) {
            // Si es una respuesta HTTP de la segunda petici√≥n
            if (responseOrData instanceof Response) {
              const response = responseOrData;
              if (!response.ok) {
                throw new Error(`Error en la API: ${response.status}`);
              }
              
              // Algunos endpoints no devuelven JSON v√°lido
              return response.json().catch(() => ({ success: true }));
            }
            
            // Si son datos de una petici√≥n exitosa anterior
            return responseOrData;
          })
          .then(function(data) {
            console.log('Parto eliminado correctamente:', data);
            
            // Eliminar la fila de la tabla
            if (fila) {
              fila.remove();
              
              // Si no quedan filas, mostrar mensaje
              const filas = tablaPartos.querySelectorAll('tbody tr');
              if (filas.length === 0) {
                const tbody = tablaPartos.querySelector('tbody');
                if (tbody) {
                  const tr = document.createElement('tr');
                  tr.setAttribute('data-empty', 'true');
                  tr.innerHTML = `
                    <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                      No hay registros de partos para este animal
                    </td>
                  `;
                  tbody.appendChild(tr);
                }
              }
            }
            
            mostrarNotificacion('Parto eliminado correctamente', 'success');
          })
          .catch(function(error) {
            console.error('Error al eliminar parto:', error);
            
            // Intentar mostrar un mensaje m√°s descriptivo basado en el error
            let mensajeError = error.message || 'Error desconocido';
            
            // Si es un error espec√≠fico de API, intentar extraer m√°s informaci√≥n
            if (mensajeError.includes('500')) {
              mensajeError = 'Error interno del servidor. Posible problema con la base de datos.';
            } else if (mensajeError.includes('404')) {
              mensajeError = 'No se encontr√≥ el recurso. Es posible que el parto ya haya sido eliminado.';
            } else if (mensajeError.includes('403')) {
              mensajeError = 'No tiene permisos para eliminar este parto.';
            } else if (mensajeError.includes('401')) {
              mensajeError = 'Su sesi√≥n ha expirado. Por favor, inicie sesi√≥n nuevamente.';
            }
            
            mostrarNotificacion(`Error al eliminar parto: ${mensajeError}`, 'error');
          });
        }
      });
    });
  });
</script>
