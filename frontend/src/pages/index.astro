---
// Importar el layout completo
import MainLayout from '../components/layout/MainLayout.astro';

// Importar el componente DashboardV2 optimizado y funcional
import DashboardV2 from '../components/dashboardv2/DashboardV2';

// Definir rol de usuario
const userRole = "administrador";

// Importar funciones de i18n
import { t, getCurrentLanguage } from '../i18n/config';

// Obtener el idioma actual para el servidor
const currentLang = getCurrentLanguage();

// El texto de bienvenida según idioma utilizando el sistema i18n
const welcomeText = t('common.welcome', currentLang);

// Crear script para actualizar el título cuando cambie el idioma usando el sistema i18n
const updateWelcomeScript = `
document.addEventListener('DOMContentLoaded', () => {
  const welcomeElement = document.querySelector('h1.welcome-title');
  if (welcomeElement) {
    // Actualizar título cuando cambie el idioma
    const updateTitle = () => {
      const lang = localStorage.getItem('userLanguage') || 'es';
      // Obtener traducciones desde la API i18n
      const i18n = window.i18next || { t: (key) => key };
      welcomeElement.textContent = i18n.t('common.welcome');
    };
    
    // Actualizar inmediatamente
    updateTitle();
    
    // Escuchar cambios en el almacenamiento
    window.addEventListener('storage', (event) => {
      if (event.key === 'userLanguage') {
        updateTitle();
      }
    });
  }
});
`;
---

<!-- Script para crear token JWT automáticamente en desarrollo con comprobación mejorada -->
<script>
  // Crear token JWT para desarrollo - versión mejorada
  window.addEventListener('DOMContentLoaded', () => {
    // DESACTIVADO: Ya no eliminamos tokens para permitir login real
    // localStorage.removeItem('token');
    
    // NOTA: Código de inyección de token para desarrollo deshabilitado
    // Este código estaba sobreescribiendo tokens válidos con uno hardcodeado inválido
    // Para habilitar el flujo normal de autenticación, se ha comentado
    // -----------------------------------------------------------------
    // // Crear token nuevo para asegurar funcionamiento correcto
    // console.log('Configurando token JWT para desarrollo');
    // localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6NDEwMjQ0NDgwMH0.x');
    // console.log('Token JWT creado correctamente');
    // 
    // // Comprobar que realmente se guardó
    // const token = localStorage.getItem('token');
    // if (token) {
    //   console.log('✅ Token verificado en localStorage');
    // } else {
    //   console.error('❌ Error: No se pudo guardar el token');
    //   // Intentar de nuevo
    //   localStorage.setItem('token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbiIsImV4cCI6NDEwMjQ0NDgwMH0.x');
    // }
    
    // Verificar si hay un token existente (autenticación real)
    const token = localStorage.getItem('token');
    if (token) {
      console.log('✅ Token JWT existente encontrado - usando autenticación real');
    }
  });
</script>

<!-- Script para actualizar el título cuando cambia el idioma -->
<script set:html={updateWelcomeScript}></script>

<MainLayout title={`${t('dashboard.title', currentLang)} - Masclet Imperi`} userRole={userRole} currentPath="/">
  <div class="mx-auto px-4 py-6 bg-white dark:bg-gray-900">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-8 welcome-title">{welcomeText}</h1>
    
    <!-- Componente DashboardV2 optimizado - Renderizado solo en el cliente -->
    <DashboardV2 client:only="react" />
    
    <!-- Botones de prueba eliminados -->
  </div>
</MainLayout>
