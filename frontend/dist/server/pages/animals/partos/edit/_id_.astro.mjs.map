{"version":3,"file":"_id_.astro.mjs","sources":["../../../../../../src/pages/animals/partos/edit/[id].astro"],"sourcesContent":["---\nimport MainLayout from '../../../../components/layout/MainLayout.astro';\nimport MessageContainer from '../../../../components/ui/MessageContainer.astro';\n\n// Obtener el ID del parto de los parámetros de la URL\nconst { id } = Astro.params;\n\n// Obtener el rol del usuario de la sesión\nconst userRole = Astro.cookies.get('userRole')?.value || 'user';\n\n// Estado inicial\nlet parto = null;\nlet animal = null;\nlet loading = true;\nlet error = null;\nlet title = 'Cargando parto...';\n\ntry {\n  // Token para la autenticación (en producción, usar el almacenado en cookies/localStorage)\n  const token = 'admin123';\n  \n  // Primero obtenemos los datos de todos los animales para buscar el parto\n  const animalsResponse = await fetch(`http://localhost:8000/api/v1/animals/?limit=1000`, {\n    headers: {\n      'Authorization': `Bearer ${token}`\n    }\n  });\n  \n  if (!animalsResponse.ok) {\n    throw new Error(`Error al cargar los animales: ${animalsResponse.statusText}`);\n  }\n  \n  const animalsData = await animalsResponse.json();\n  let animalId = null;\n  \n  // Buscar en todos los animales\n  if (animalsData && animalsData.data) {\n    for (const animalItem of animalsData.data) {\n      // Buscar en partos.items (estructura habitual)\n      if (animalItem.partos && animalItem.partos.items && Array.isArray(animalItem.partos.items)) {\n        const foundParto = animalItem.partos.items.find(p => p.id == id);\n        if (foundParto) {\n          parto = foundParto;\n          animal = animalItem;\n          animalId = animalItem.id;\n          break;\n        }\n      }\n      // Buscar también en partos directo (estructura alternativa)\n      else if (animalItem.partos && Array.isArray(animalItem.partos)) {\n        const foundParto = animalItem.partos.find(p => p.id == id);\n        if (foundParto) {\n          parto = foundParto;\n          animal = animalItem;\n          animalId = animalItem.id;\n          break;\n        }\n      }\n    }\n  }\n  \n  // Si no encontramos el parto en la lista general, intentar con el endpoint directo del animal\n  if (!parto && !animalId) {\n    // Como no tenemos el animal_id, esto es un problema.\n    // Podríamos pedir al usuario que especifique el animal_id, pero por ahora mostraremos un error.\n    throw new Error('No se pudo encontrar el parto en ninguno de los animales.');\n  }\n  \n  title = parto ? `Editar Parto - ${animal?.nom || 'Animal'}` : 'Parto no encontrado';\n  loading = false;\n} catch (err) {\n  console.error('Error al cargar los datos:', err);\n  error = err.message || 'Error al cargar los datos del parto';\n  loading = false;\n  title = 'Error al cargar parto';\n}\n---\n\n<MainLayout title={title} userRole={userRole} currentPath=\"/animals\">\n  <!-- Encabezado con botón de volver -->\n  <div class=\"mb-6\">\n    <div class=\"flex items-center gap-2 mb-2\">\n      <a href={`/animals/${parto?.animal_id}`} class=\"flex items-center text-primary hover:text-primary/80 dark:text-primary-light dark:hover:text-primary transition-colors\">\n        <span class=\"mr-1\">←</span> Volver al detalle del animal\n      </a>\n    </div>\n    <h1 class=\"text-3xl font-bold text-gray-900 dark:text-white mb-2\">{title}</h1>\n    {animal && <p class=\"text-gray-600 dark:text-gray-300\">Animal: {animal.nom} (ID: {animal.id})</p>}\n  </div>\n\n  <!-- Estado de carga -->\n  {loading && (\n    <div class=\"bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 p-6\">\n      <div class=\"flex justify-center items-center py-10\">\n        <div class=\"animate-spin rounded-full h-10 w-10 border-b-2 border-primary\"></div>\n        <span class=\"ml-3 text-gray-700 dark:text-gray-300\">Cargando...</span>\n      </div>\n    </div>\n  )}\n\n  <!-- Mensaje de error -->\n  {error && (\n    <MessageContainer \n      type=\"error\"\n      title=\"Error\"\n      message={error}\n    />\n  )}\n\n  {!loading && !error && parto && (\n    <div class=\"grid grid-cols-1 gap-6\">\n      <div class=\"bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-100 dark:border-gray-700 p-6\">\n        <form id=\"edit-parto-form\" class=\"space-y-6\">\n          <!-- Fecha del Parto -->\n          <div>\n            <label for=\"part\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">Fecha del Parto</label>\n            <input \n              type=\"date\" \n              id=\"part\" \n              name=\"part\" \n              value={parto.part ? new Date(parto.part.split('/').reverse().join('-')).toISOString().split('T')[0] : ''} \n              class=\"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white\"\n              required\n            />\n            <p class=\"mt-1 text-sm text-gray-500 dark:text-gray-400\">Formato: DD/MM/YYYY</p>\n          </div>\n\n          <!-- Género de la Cría -->\n          <div>\n            <label for=\"GenereT\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">Género de la Cría</label>\n            <select \n              id=\"GenereT\" \n              name=\"GenereT\" \n              class=\"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white\"\n              required\n            >\n              <option value=\"\">Selecciona una opción</option>\n              <option value=\"M\" selected={parto.GenereT === 'M'}>Macho</option>\n              <option value=\"F\" selected={parto.GenereT === 'F'}>Hembra</option>\n              <option value=\"esforrada\" selected={parto.GenereT === 'esforrada'}>Esforrada</option>\n            </select>\n          </div>\n\n          <!-- Estado de la Cría -->\n          <div>\n            <label for=\"EstadoT\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">Estado de la Cría</label>\n            <select \n              id=\"EstadoT\" \n              name=\"EstadoT\" \n              class=\"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white\"\n              required\n            >\n              <option value=\"\">Selecciona una opción</option>\n              <option value=\"OK\" selected={parto.EstadoT === 'OK'}>Vivo</option>\n              <option value=\"DEF\" selected={parto.EstadoT === 'DEF'}>Fallecido</option>\n            </select>\n          </div>\n\n          <!-- Observaciones -->\n          <div>\n            <label for=\"observacions\" class=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">Observaciones</label>\n            <textarea \n              id=\"observacions\" \n              name=\"observacions\" \n              rows=\"3\" \n              class=\"w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-white\"\n            >{parto.observacions || ''}</textarea>\n          </div>\n\n          <!-- Campo oculto para visibilidad -->\n          <div>\n            <label for=\"visible\" class=\"flex items-center\">\n              <input \n                type=\"checkbox\" \n                id=\"visible\" \n                name=\"visible\" \n                class=\"h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded\"\n                checked={parto.visible !== false}\n              />\n              <span class=\"ml-2 text-sm text-gray-700 dark:text-gray-300\">Mostrar en el historial de partos</span>\n            </label>\n            <p class=\"mt-1 text-sm text-gray-500 dark:text-gray-400\">Desmarca esta opción para ocultar este parto del historial y recuentos.</p>\n          </div>\n\n          <!-- Botones de acción -->\n          <div class=\"flex justify-end space-x-3 pt-4\">\n            <a \n              href={`/animals/${parto.animal_id}`}\n              class=\"px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary\"\n            >\n              Cancelar\n            </a>\n            <button \n              type=\"submit\"\n              class=\"px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary\"\n            >\n              Guardar Cambios\n            </button>\n          </div>\n        </form>\n\n        <!-- Debug para desarrollo -->\n        <div id=\"debug-output\" class=\"mt-8 p-4 border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-900 hidden\">\n          <h3 class=\"text-lg font-medium text-gray-900 dark:text-white mb-2\">Información de Depuración</h3>\n          <pre id=\"debug-content\" class=\"text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap\"></pre>\n        </div>\n      </div>\n    </div>\n  )}\n\n  {!loading && !error && !parto && (\n    <MessageContainer \n      type=\"info\"\n      title=\"Parto no encontrado\"\n      message=\"No se encontró el parto solicitado. Puede que haya sido eliminado o que no exista.\"\n    />\n  )}\n</MainLayout>\n\n<script is:inline define:vars={{ partoId: id, animalId: parto?.animal_id }}>\n  document.addEventListener('DOMContentLoaded', () => {\n    const form = document.getElementById('edit-parto-form');\n    const debugOutput = document.getElementById('debug-output');\n    const debugContent = document.getElementById('debug-content');\n    \n    if (form) {\n      form.addEventListener('submit', async (e) => {\n        e.preventDefault();\n        \n        try {\n          // Obtener los valores del formulario\n          const formData = new FormData(form);\n          const partDate = formData.get('part');\n          \n          // Validar campos requeridos\n          if (!partDate || !formData.get('GenereT') || !formData.get('EstadoT')) {\n            alert('Por favor, completa todos los campos obligatorios.');\n            return;\n          }\n          \n          // Formatear fecha correctamente (de YYYY-MM-DD a DD/MM/YYYY)\n          const dateParts = partDate.split('-');\n          const formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;\n          \n          // Crear objeto de datos para la API\n          const apiData = {\n            part: formattedDate,\n            GenereT: formData.get('GenereT'),\n            EstadoT: formData.get('EstadoT'),\n            observacions: formData.get('observacions') || null,\n            visible: formData.get('visible') === 'on' // Convertir checkbox a booleano\n          };\n          \n          // Para desarrollo, mostrar los datos que se enviarán\n          if (debugOutput && debugContent) {\n            debugContent.textContent = JSON.stringify(apiData, null, 2);\n            debugOutput.classList.remove('hidden');\n          }\n          \n          // Obtener token de autenticación (en producción, usar localStorage o cookies)\n          const token = localStorage.getItem('token') || 'admin123';\n          \n          // Enviar datos a la API\n          // Intentar actualizar con PUT en lugar de PATCH\n          const response = await fetch(`http://localhost:8000/api/v1/animals/${animal.id}/partos/${partoId}`, {\n            method: 'PUT',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${token}`\n            },\n            body: JSON.stringify(apiData)\n          });\n          \n          if (!response.ok) {\n            const errorData = await response.json();\n            throw new Error(errorData.detail || 'Error al actualizar el parto');\n          }\n          \n          const data = await response.json();\n          console.log('Parto actualizado:', data);\n          \n          // Guardar mensaje de éxito en sessionStorage para mostrar en la página de detalles\n          sessionStorage.setItem('partoUpdatedMessage', 'El parto ha sido actualizado correctamente');\n          \n          // Redirigir a la página de detalles del animal\n          window.location.href = `/animals/${animalId}`;\n        } catch (error) {\n          console.error('Error:', error);\n          alert('Error al actualizar el parto: ' + error.message);\n        }\n      });\n    }\n  });\n</script>\n"],"names":["$$createAstro","$$createComponent","Astro","$$render","$$renderComponent","MainLayout","$$result","$$maybeRenderHead","$$addAttribute","MessageContainer","$$defineScriptVars"],"mappings":"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"}