import{getCurrentLanguage as C,t as _}from"./config.DUTcyYPh.js";import{b3 as v}from"./vendor.CIJYp_OF.js";import"./hoisted.CJA0zZzA.js";import"./LanguageSwitcher.astro_astro_type_script_index_0_lang.D2FS4ZfD.js";const d="http://localhost:8000/api/v1";console.log("BackupService inicializado - URL de API:",d);async function S(){console.log(`Intentando obtener lista de backups desde: ${d}/backup/list`);try{const e=localStorage.getItem("token");if(!e)throw console.error("No hay token de autenticación disponible"),new Error("No hay token de autenticación. Por favor, inicia sesión nuevamente.");console.log(`Token de autenticación: ${e.substring(0,15)}...`),console.log(`Intentando conectar a: ${d}/backup/list`);const t={"Content-Type":"application/json",Authorization:`Bearer ${e}`};console.log("Headers de la petición:",t);const r=await fetch(`${d}/backup/list`,{method:"GET",headers:t});if(console.log(`Respuesta recibida: Status ${r.status} ${r.statusText}`),console.log("Headers:",r.headers),console.log(`URL completa de la petición: ${d}/backup/list`),!r.ok){console.error(`Error HTTP: ${r.status} ${r.statusText}`);const n=r.clone();try{const s=await n.json();console.error("Detalles del error:",s)}catch(s){console.error("No se pudo parsear la respuesta de error como JSON:",s);try{const c=await r.text();console.error("Texto de error:",c)}catch(c){console.error("No se pudo obtener el texto de la respuesta:",c)}}throw new Error(`Error al obtener la lista de backups: ${r.status} ${r.statusText}`)}const l=await r.json();return console.log("Datos recibidos:",l),l}catch(e){return console.error("Error en getBackupsList:",e),console.error("Detalles del error:",{mensaje:e.message,url:`${d}/backup/list`,stack:e.stack}),[]}}async function D(e={}){console.log(`Intentando crear backup en: ${d}/backup/create`,e);try{const t=localStorage.getItem("token");console.log(`Token de autenticación: ${t?"Presente":"No encontrado"}`);const r={...e,created_by:"usuario_web",description:e.description||`Backup manual creado el ${new Date().toLocaleString()}`};console.log("Opciones de backup:",r);const l="http://localhost:8000/api/v1/backup/create";console.log(`URL absoluta para crear backup: ${l}`);const n=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t?`Bearer ${t}`:""},body:JSON.stringify(r),mode:"cors",cache:"no-cache"});if(console.log(`Respuesta recibida: Status ${n.status} ${n.statusText}`),!n.ok){console.error(`Error HTTP: ${n.status} ${n.statusText}`);let c="Error al crear el backup";try{c=(await n.json()).detail||c}catch(i){console.error("No se pudo parsear la respuesta de error como JSON:",i);try{const b=await n.text();if(console.error("Contenido de la respuesta de error:",b.substring(0,500)),b.includes("<!DOCTYPE"))return console.log("Se detectó HTML en la respuesta, el backup probablemente se creó correctamente"),{message:"Backup iniciado en segundo plano"}}catch(b){console.error("No se pudo obtener el texto de la respuesta:",b)}}throw new Error(c)}const s=await n.json();return console.log("Backup creado correctamente:",s),s}catch(t){if(console.error("Error al crear backup:",t),console.error("Detalles del error:",{mensaje:t.message,url:fullApiUrl||`${d}/backup/create`,opciones:e}),t.message&&t.message.includes("<!DOCTYPE"))return console.log("El error contiene HTML, probablemente el backup se creó correctamente"),{message:"Backup iniciado en segundo plano"};throw new Error(`Error al crear backup: ${t.message}`)}}async function A(e){try{if(!confirm("¿Estás seguro de que quieres restaurar el sistema? Esta acción reemplazará todos los datos actuales."))throw new Error("Restauración cancelada por el usuario");const t=await fetch(`${d}/backup/restore/${e}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!t.ok){const r=await t.json();throw new Error(r.detail||"Error al restaurar el backup")}return await t.json()}catch(t){throw console.error("Error en restoreBackup:",t),t}}async function N(e){try{if(!confirm(`¿Estás seguro de que quieres eliminar el backup ${e}?`))throw new Error("Eliminación cancelada por el usuario");const t=await fetch(`${d}/backup/delete/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`}});if(!t.ok){const r=await t.json();throw new Error(r.detail||"Error al eliminar el backup")}return await t.json()}catch(t){throw console.error("Error en deleteBackup:",t),t}}function P(e){const t=localStorage.getItem("token");return`${d}/backup/download/${e}?token=${t}`}const o=C(),a=(e,t=o)=>{const r=_(e,t);return r===e?{"backup.download":t==="ca"?"Descarregar":"Descargar","backup.restore":"Restaurar","backup.delete":"Eliminar","backup.loading":t==="ca"?"Carregant...":"Cargando...","backup.no_backups":t==="ca"?"No hi ha còpies de seguretat disponibles":"No hay copias de seguridad disponibles","backup.backup_created":t==="ca"?"Còpia de seguretat creada amb èxit":"Copia de seguridad creada con éxito","backup.backup_error":t==="ca"?"Error al crear la còpia de seguretat":"Error al crear la copia de seguridad","backup.restore_success":t==="ca"?"Sistema restaurat correctament":"Sistema restaurado correctamente","backup.restore_error":"Error al restaurar el sistema","backup.deleteSuccess":t==="ca"?"Còpia de seguretat eliminada correctament":"Copia de seguridad eliminada correctamente","backup.deleteInProgress":t==="ca"?"Eliminant...":"Eliminando...","backup.restoreInProgress":t==="ca"?"Restaurant sistema...":"Restaurando sistema...","backup.backupInProgress":t==="ca"?"Creant còpia de seguretat...":"Creando copia de seguridad...","backup.error":"Error"}[e]||e:r};let x=null,p=[];const $=document.getElementById("alert-container"),k=document.getElementById("alert"),j=document.getElementById("alert-message");let m=document.getElementById("create-backup-btn"),u=document.getElementById("restore-backup-btn"),f=document.getElementById("select-backup-btn"),E=document.getElementById("change-backup-btn");const L=document.getElementById("selected-backup-container"),I=document.getElementById("no-selected-backup-container"),R=document.getElementById("selected-backup-name"),B=document.getElementById("backups-table-body"),H=document.getElementById("include-animals"),O=document.getElementById("include-births"),M=document.getElementById("include-config");function g(e,t="success"){$.classList.remove("hidden"),j.innerText=e,k.className="p-4 rounded-md text-center",t==="success"?k.classList.add("bg-green-100","text-green-800","dark:bg-green-900","dark:text-green-200"):t==="error"?k.classList.add("bg-red-100","text-red-800","dark:bg-red-900","dark:text-red-200"):t==="warning"?k.classList.add("bg-yellow-100","text-yellow-800","dark:bg-yellow-900","dark:text-yellow-200"):t==="info"&&k.classList.add("bg-blue-100","text-blue-800","dark:bg-blue-900","dark:text-blue-200"),setTimeout(()=>{$.classList.add("hidden")},5e3)}function w(e,t,r){t?(e.disabled=!0,e.originalText=e.innerText,e.innerText=r||a("backup.loading",o),e.classList.add("opacity-70")):(e.disabled=!1,e.innerText=e.originalText||e.innerText,e.classList.remove("opacity-70"))}function y(e){x=e,e?(R.innerText=e.filename,L.classList.remove("hidden"),I.classList.add("hidden"),u.classList.remove("opacity-50","cursor-not-allowed"),u.disabled=!1):(L.classList.add("hidden"),I.classList.remove("hidden"),u.classList.add("opacity-50","cursor-not-allowed"),u.disabled=!0)}function q(e){switch(e){case"animal_created":return"bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200";case"animal_updated":return"bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200";case"daily":return"bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200";case"import":return"bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200";case"manual":return"bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200";default:return"bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200"}}async function h(){try{p=await S(),console.log("Datos de backups recibidos:",p),console.log("Número de backups:",p.length);const e=document.createElement("div");e.id="debug-message",e.style.padding="10px",e.style.margin="10px 0",e.style.backgroundColor="#f0f0f0",e.style.border="1px solid #ccc",e.style.borderRadius="4px",e.innerHTML=`Datos recibidos: ${p.length} copias de seguridad<br>Último log: ${new Date().toLocaleTimeString()}`;const t=document.querySelector("#backups-table");if(t&&!document.getElementById("debug-message")&&t.parentNode.insertBefore(e,t),p.length===0){B.innerHTML=`
            <tr class="text-center">
              <td colspan="5" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300">${a("backup.no_backups",o)}</td>
            </tr>
          `;return}B.innerHTML=p.map(r=>`
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700" data-filename="${r.filename}">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${r.date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${r.size}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${r.created_by}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
              <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${q(r.backup_type)}">
                ${r.backup_type||"manual"}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 max-w-xs truncate">
              ${r.description||""}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex space-x-2">
                <a href="${P(r.filename)}" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-200" download>${a("backup.download",o)}</a>
                <button class="restore-btn text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-200">
                  ${a("backup.restore",o)}
                </button>
                <button class="delete-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200">
                  ${a("backup.delete",o)}
                </button>
              </div>
            </td>
          </tr>
        `).join(""),document.querySelectorAll(".restore-btn").forEach(r=>{r.addEventListener("click",Y)}),document.querySelectorAll(".delete-btn").forEach(r=>{r.addEventListener("click",V)})}catch(e){console.error("Error al cargar la lista de backups:",e),g(`${a("backup.error")}: ${e.message}`,"error"),B.innerHTML=`
          <tr class="text-center">
            <td colspan="5" class="px-6 py-4 text-sm text-red-500 dark:text-red-300">${a("backup.error",o)}: ${e.message}</td>
          </tr>
        `}}async function z(){console.log("Botón de backup clickeado");const e={include_animals:H.checked,include_births:O.checked,include_config:M.checked,created_by:"usuario"};w(m,!0,a("backup.backupInProgress",o));try{const t=await D(e);console.log("Backup creado correctamente:",t),g(a("backup.backup_created",o),"success"),await h()}catch(t){console.error("Error al crear backup:",t),t.message&&t.message.includes("<!DOCTYPE")?(console.log("El backup probablemente se creó correctamente a pesar del error de parseo"),g(a("backup.backup_created",o),"success"),setTimeout(()=>h(),1e3)):g(`${a("backup.backup_error",o)}: ${t.message||"Error desconocido"}`,"error")}finally{w(m,!1)}}async function U(){if(x)try{w(u,!0,a("backup.restoreInProgress",o)),await A(x.filename),g(a("backup.restore_success",o),"success"),await h(),y(null)}catch(e){console.error("Error al restaurar backup:",e),g(`${a("backup.error",o)}: ${e.message}`,"error")}finally{w(u,!1)}}function F(){p.length>0?y(p[0]):g(a("backup.no_backups",o),"warning")}function J(){y(null)}function Y(e){const r=e.target.closest("tr").dataset.filename,l=p.find(n=>n.filename===r);l&&(y(l),document.getElementById("restore-backup-btn").scrollIntoView({behavior:"smooth"}))}async function V(e){const r=e.target.closest("tr").dataset.filename;try{e.target.disabled=!0,e.target.textContent=a("backup.deleteInProgress",o),await N(r),g(a("backup.deleteSuccess",o),"success"),await h(),x&&x.filename===r&&y(null)}catch(l){console.error("Error al eliminar backup:",l),g(`${a("backup.error",o)}: ${l.message}`,"error"),e.target.disabled=!1,e.target.textContent=a("backup.delete",o)}}function T(){console.log("Inicializando página de backup..."),m||(console.error("No se encontró el botón de crear backup"),m=document.getElementById("create-backup-btn")),u||(console.error("No se encontró el botón de restaurar backup"),u=document.getElementById("restore-backup-btn")),f||(console.error("No se encontró el botón de seleccionar backup"),f=document.getElementById("select-backup-btn")),E||(console.error("No se encontró el botón de cambiar backup"),E=document.getElementById("change-backup-btn")),h(),m&&(console.log("Añadiendo event listener al botón de crear backup"),m.addEventListener("click",z)),u&&u.addEventListener("click",U),f&&f.addEventListener("click",F),E&&E.addEventListener("click",J)}document.addEventListener("DOMContentLoaded",T);setTimeout(T,1e3);try{T()}catch(e){console.error("Error al inicializar la página:",e)}document.addEventListener("DOMContentLoaded",()=>{try{v(async()=>{const{t:e,getCurrentLanguage:t}=await import("./config.DUTcyYPh.js");return{t:e,getCurrentLanguage:t}},[]).then(({t:e,getCurrentLanguage:t})=>{const r=t();console.log("Idioma detectado en cliente:",r);const l=(s,c)=>{const i=document.getElementById(s);i&&(i.textContent=e(c,r))};l("page-title","backup.title"),l("page-subtitle","backup.subtitle"),document.querySelectorAll("[data-i18n-key]").forEach(s=>{const c=s.getAttribute("data-i18n-key");c&&(s.textContent=e(c,r))}),document.title=e("backup.title",r)+" - Masclet Imperi";const n=document.querySelectorAll("th");if(n&&n.length>0){const s={Fecha:r==="ca"?"Data":"Fecha",Tamaño:r==="ca"?"Mida":"Tamaño",Usuario:r==="ca"?"Usuari":"Usuario",Tipo:r==="ca"?"Tipus":"Tipo",Descripción:r==="ca"?"Descripció":"Descripción",Acciones:r==="ca"?"Accions":"Acciones","Historial de copias de seguridad":r==="ca"?"Historial de còpies de seguretat":"Historial de copias de seguridad"},c=document.querySelector(".bg-gray-50.dark\\:bg-gray-700.text-lg");if(c&&c.textContent){const i=c.textContent.trim();s[i]&&(c.textContent=s[i])}n.forEach(i=>{const b=i.textContent.trim();s[b]&&(i.textContent=s[b])})}})}catch(e){console.error("Error al actualizar traducciones estáticas:",e)}});
