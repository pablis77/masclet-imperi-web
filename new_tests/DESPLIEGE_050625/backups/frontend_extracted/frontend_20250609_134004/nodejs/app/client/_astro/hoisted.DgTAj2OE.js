import"./hoisted.BvqcoGvE.js";import"./LanguageSwitcher.astro_astro_type_script_index_0_lang.BEmjKfY9.js";import"./vendor.CwhrWGr6.js";document.addEventListener("DOMContentLoaded",function(){console.log("[Tabs] Inicializando pestañas de animal con traducciones");const s=document.getElementById("tabs-animal-update");if(!s){console.error("[Tabs] No se encontró el contenedor de pestañas");return}const n=s.querySelectorAll(".tab-button");console.log(`[Tabs] Encontradas ${n.length} pestañas`);function e(t){console.log(`[Tabs] Activando pestaña: ${t}`),n.forEach(l=>{const o=l.id===`tab-${t}`;l.classList.toggle("bg-lime-500",o),l.classList.toggle("text-white",o),l.classList.toggle("bg-gray-200",!o),l.classList.toggle("text-gray-700",!o),l.classList.toggle("dark:bg-gray-700",!o),l.classList.toggle("dark:text-gray-300",!o)}),document.querySelectorAll(".tab-content").forEach(l=>{const o=l.id===`content-${t}`;l.classList.toggle("hidden",!o),console.log(`[Tabs] Contenido ${l.id}: ${o?"visible":"oculto"}`)})}n.forEach(t=>{t.addEventListener("click",()=>{const a=t.id.replace("tab-","");e(a)})}),e("general")});document.addEventListener("DOMContentLoaded",function(){console.log("DOM completamente cargado y analizado");const s=document.querySelectorAll("[data-tab]"),n=document.querySelectorAll(".tab-content");s.forEach(o=>{o.addEventListener("click",function(){const r=this.getAttribute("data-tab");s.forEach(c=>c.classList.remove("text-lime-500","border-lime-500","text-primary","border-primary","dark:text-primary-light","dark:border-primary-light")),this.classList.add("text-lime-500","border-lime-500","dark:text-lime-400","dark:border-lime-400"),n.forEach(c=>c.classList.add("hidden")),document.getElementById(`content-${r}`).classList.remove("hidden"),console.log(`Cambio a pestaña ${r}`)})});const e=document.getElementById("form-general"),t=document.getElementById("form-habitual"),a=document.getElementById("form-habituales");console.log("Configurando formularios..."),console.log("Form general encontrado:",e?"Sí":"No"),console.log("Form habitual encontrado:",t?"Sí":"No"),console.log("Form habituales encontrado:",a?"Sí":"No");const l=document.getElementById("registrar-parto-btn");l?(console.log("Botón de registrar parto encontrado, configurando..."),l.addEventListener("click",function(){console.log("Botón de registrar parto clickeado"),$()})):console.log("Botón de registrar parto NO encontrado"),e?(console.log("Formulario general encontrado, configurando..."),e.addEventListener("submit",function(o){o.preventDefault(),console.log("Formulario general enviado"),f(e)})):console.log("Formulario general no encontrado"),t?(console.log("Formulario habitual encontrado, configurando..."),t.addEventListener("submit",function(o){o.preventDefault(),console.log("Formulario habitual enviado"),f(t)})):console.log("Formulario habitual no encontrado"),a?(console.log("Formulario habituales encontrado, configurando..."),a.addEventListener("submit",function(o){o.preventDefault(),console.log("Formulario habituales enviado"),f(a)})):console.log("Formulario habituales no encontrado"),document.querySelectorAll("form").forEach(o=>{o._hasSubmitListener||(o.addEventListener("submit",function(r){r.preventDefault(),console.log("Formulario genérico enviado:",o.id),f(o)}),o._hasSubmitListener=!0)})});async function f(s){try{console.log("Procesando formulario:",s.id);const n=new FormData(s);console.log("Campos en el formulario:");for(let[t,a]of n.entries())console.log(`  ${t}: ${a}`);if(s.id==="form-habituales"&&n.entries().next().done){console.log("Formulario habituales está vacío, verificando campos manualmente...");const t=s.querySelector('select[name="alletar"]');t&&(console.log("Encontrado select alletar con valor:",t.value),n.append("alletar",t.value));const a=s.querySelector('select[name="estado_hab"]');a&&(console.log("Encontrado select estado_hab con valor:",a.value),n.append("estado_hab",a.value))}const e={};for(const[t,a]of n.entries())switch(t){case"nombre":e.nom=a||"";break;case"genere":e.genere=a||"F";break;case"dob":if(a)if(a.match(/^\d{4}-\d{2}-\d{2}$/)){const[l,o,r]=a.split("-");e.dob=`${r}/${o}/${l}`}else e.dob=a;break;case"codigo":e.cod=a||null;break;case"num_serie":e.num_serie=a||null;break;case"explotacio":e.explotacio=a||"";break;case"origen":e.origen=a||null;break;case"pare":e.pare=a||null;break;case"mare":e.mare=a||null;break;case"observaciones":e.observaciones=a||null;break;case"estado_hab":e.estado=a||"OK";break;case"alletar":a===""||a===void 0||a===null?e.alletar="0":e.alletar=String(a);break;case"estado":e.estado=a||"OK";break;default:console.log("Campo no mapeado:",t)}window.mostrarMensaje("Actualizando animal...","info"),window.mostrarMensaje("Enviando actualización al servidor...","info"),window.animalesFormData=e,console.log("Datos a enviar directamente al backend:",e);try{console.log("Obteniendo datos actuales del animal para comparar...");const t=localStorage.getItem("token")||"admin123",a=await fetch(`http://localhost:8000/api/v1/animals/${window.animalId}`,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error(`Error al obtener los datos actuales: ${a.status} ${a.statusText}`);const l=await a.json(),o=l.data||l;console.log("Datos actuales del animal:",o);const r={};console.log("Datos del formulario:");for(const[m,i]of Object.entries(e))console.log(`  ${m}: ${i} (${typeof i})`);console.log("Datos actuales del animal:");for(const[m,i]of Object.entries(o))console.log(`  ${m}: ${i} (${typeof i})`);e.nom!==o.nom&&(r.nom=e.nom),e.genere!==o.genere&&(r.genere=e.genere),e.explotacio!==o.explotacio&&(r.explotacio=e.explotacio),e.estado!==o.estado&&(r.estado=e.estado),e.dob&&e.dob!==o.dob&&(r.dob=e.dob),e.mare!==o.mare&&(r.mare=e.mare),e.pare!==o.pare&&(r.pare=e.pare),e.origen!==o.origen&&(r.origen=e.origen),e.cod!==o.cod&&(r.cod=e.cod),e.num_serie!==o.num_serie&&(r.num_serie=e.num_serie),e.observaciones!==o.observaciones&&(r.observaciones=e.observaciones),console.log("Comparando alletar:",`Valor formulario: ${e.alletar} (${typeof e.alletar})`,`Valor actual: ${o.alletar} (${typeof o.alletar})`);const c=String(e.alletar||"0"),d=String(o.alletar||"0");if(e.alletar&&c!==d&&(console.log(`Valor de alletar diferente: ${c} !== ${d}`),r.alletar=c),console.log("Campos modificados a enviar:",r),Object.keys(r).length===0){window.mostrarMensaje("No se detectaron cambios que actualizar","info");return}console.log("Enviando solo campos modificados para actualización:",r);const u=await fetch(`http://localhost:8000/api/v1/animals/${window.animalId}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify(r)});if(console.log(`Respuesta recibida: ${u.status} ${u.statusText}`),u.ok){const m=await u.json();console.log("Respuesta de actualización:",m),window.mostrarMensaje("¡Animal actualizado con éxito!","success"),setTimeout(()=>{window.location.href=`/animals/${window.animalId}`},1500)}else{let m=`Error ${u.status}: ${u.statusText}`;try{const i=await u.json();console.error("Error detallado:",i),i.detail&&(Array.isArray(i.detail)?m="Errores de validación: "+i.detail.map(g=>g.msg).join(", "):m=i.detail)}catch{try{const g=await u.text();m+=` - ${g}`}catch{console.error("No se pudo obtener detalle del error")}}window.mostrarMensaje("Error: "+m,"error")}}catch(t){console.error("Error en la petición:",t),window.mostrarMensaje("Error: "+(t.message||"Error desconocido"),"error")}}catch(n){console.error("Error al actualizar el animal:",n),window.mostrarMensaje(`Error: ${n.message||"Error desconocido"}`,"error")}}const h=document.getElementById("delete-animal-btn"),b=document.getElementById("delete-animal-modal"),E=document.getElementById("close-delete-modal"),w=document.getElementById("cancel-delete"),p=document.getElementById("confirm-delete"),v=document.getElementById("animal-name-confirm");if(h&&b){const s=document.querySelector("h1.text-3xl")?.textContent||"este animal",n=window.animalId;h.addEventListener("click",()=>{v&&(v.textContent=s),b.classList.remove("hidden")});const e=()=>{b.classList.add("hidden")};E&&E.addEventListener("click",e),w&&w.addEventListener("click",e),p&&p.addEventListener("click",async()=>{try{p.disabled=!0,p.innerHTML='<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Eliminando...';const t=localStorage.getItem("token"),l=await fetch(`http://localhost:8000/api/v1/animals/${n}`,{method:"DELETE",headers:{"Content-Type":"application/json",...t?{Authorization:`Bearer ${t}`}:{}}});if(l.ok)window.mostrarMensaje("Animal eliminado correctamente","success"),setTimeout(()=>{window.location.href="/animals"},1500);else{let o="Error al eliminar el animal";try{const r=await l.json();o=r.detail||r.message||o}catch{}window.mostrarMensaje(`Error: ${o}`,"error"),e(),p.disabled=!1,p.textContent="Eliminar definitivamente"}}catch(t){console.error("Error al eliminar animal:",t),window.mostrarMensaje("Error de conexión al intentar eliminar el animal","error"),e(),p.disabled=!1,p.textContent="Eliminar definitivamente"}})}async function $(){console.log("Iniciando proceso de registro de parto...");try{const s=document.getElementById("part")?.value,n=document.getElementById("GenereT")?.value,e=document.getElementById("EstadoT")?.value,t=document.getElementById("observacions")?.value;if(console.log("Datos del parto:",{part:s,genereT:n,estadoT:e,observacions:t}),!s||!n||!e){window.mostrarMensaje("Por favor, completa todos los campos obligatorios (fecha, género y estado)","error");return}let a=s;if(s.match(/^\d{4}-\d{2}-\d{2}$/)){const[c,d,u]=s.split("-");a=`${u}/${d}/${c}`}const l={part:a,GenereT:n,EstadoT:e};t&&(l.observacions=t),console.log("Datos del parto formateados:",l);const o=localStorage.getItem("token")||"admin123";window.mostrarMensaje("Registrando nuevo parto...","info");const r=await fetch(`http://localhost:8000/api/v1/animals/${window.animalId}/partos`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(l)});if(console.log(`Respuesta recibida: ${r.status} ${r.statusText}`),r.ok){const c=await r.json();console.log("Respuesta de registro de parto:",c),window.mostrarMensaje("¡Parto registrado con éxito!","success"),document.getElementById("part").value="",document.getElementById("GenereT").value="",document.getElementById("EstadoT").value="",document.getElementById("observacions")&&(document.getElementById("observacions").value=""),setTimeout(()=>{window.location.href=`/animals/${window.animalId}`},1500)}else{let c="Error al registrar el parto";try{const d=await r.json();c=d.detail||d.message||c,console.error("Error detallado:",d)}catch(d){console.error("Error al procesar respuesta de error:",d)}window.mostrarMensaje(`Error: ${c}`,"error")}}catch(s){console.error("Error en el registro de parto:",s),window.mostrarMensaje(`Error: ${s.message||"Error desconocido al registrar el parto"}`,"error")}}document.addEventListener("DOMContentLoaded",function(){const s=localStorage.getItem("userLanguage"),n=localStorage.getItem("lastPageLang");if(console.log("[Language] Página cargada - Idioma actual:",s,"Idioma anterior:",n),n&&s!==n&&!window.location.search.includes("lang=")){console.log("[Language] Detectado cambio de idioma, forzando recarga completa");const e=new URL(window.location.href);e.searchParams.set("lang",s),e.searchParams.set("_t",Date.now()),window.location.href=e.toString();return}localStorage.setItem("lastPageLang",s)});document.addEventListener("DOMContentLoaded",function(){const s=document.getElementById("registrar-parto-btn");s?(console.log("Configurando botón de registro de partos..."),s.addEventListener("click",async function(){console.log("Botón de registrar parto clickeado");try{const n=document.getElementById("part")?.value,e=document.getElementById("GenereT")?.value,t=document.getElementById("EstadoT")?.value,a=document.getElementById("observacions")?.value;if(console.log("Datos del parto:",{part:n,genereT:e,estadoT:t,observacions:a}),!n||!e||!t){window.mostrarMensaje("Por favor, completa todos los campos obligatorios (fecha, género y estado)","error");return}let l=n;if(n.match(/^\d{4}-\d{2}-\d{2}$/)){const[i,g,y]=n.split("-");l=`${y}/${g}/${i}`}const o={part:l,GenereT:e,EstadoT:t};a&&(o.observacions=a),console.log("Datos del parto formateados:",o);const r=localStorage.getItem("token")||"admin123",c=window.animalId;if(!c){window.mostrarMensaje("Error: No se pudo determinar el ID del animal","error");return}window.mostrarMensaje("Registrando nuevo parto...","info");let d="";typeof window<"u"?window.location.hostname.includes("loca.lt")?(d="https://api-masclet-imperi.loca.lt/api/v1",console.log("Usando URL de túnel para API: "+d)):(d="http://127.0.0.1:8000/api/v1",console.log("Usando URL local para API (IP literal): "+d)):d="http://127.0.0.1:8000/api/v1";const u=`/animals/${c}/partos/`;console.log(`Enviando petición a: ${d}${u}`);const m=await fetch(`${d}${u}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(o)});if(console.log(`Respuesta recibida: ${m.status} ${m.statusText}`),m.ok){const i=await m.json();console.log("Respuesta de registro de parto:",i),window.mostrarMensaje("¡Parto registrado con éxito!","success"),document.getElementById("part").value="",document.getElementById("GenereT").value="",document.getElementById("EstadoT").value="",document.getElementById("observacions")&&(document.getElementById("observacions").value=""),setTimeout(()=>{window.location.href=`/animals/${c}`},1500)}else{let i="Error al registrar el parto";try{const g=await m.json();i=g.detail||g.message||i,console.error("Error detallado:",g)}catch(g){console.error("Error al procesar respuesta de error:",g)}window.mostrarMensaje(`Error: ${i}`,"error")}}catch(n){console.error("Error en el registro de parto:",n),window.mostrarMensaje(`Error: ${n.message||"Error desconocido al registrar el parto"}`,"error")}})):console.warn("No se encontró el botón de registrar parto")});
