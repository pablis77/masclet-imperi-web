# 12. COMANDOS IMPORTANTES DE MASCLETI IMPERI WEB

Este documento contiene todos los comandos importantes para gestionar nuestro sistema en diferentes entornos.

## üöÄ Comandos para Despliegue en AWS

### Despliegue Frontend

```powershell
# Despliegue principal del frontend
.\new_tests\DESPLIEGE_050625\frontend-mixto\desplegar_frontend_mixto_aws.ps1

# Verificar integridad de archivos despu√©s del despliegue
.\new_tests\DESPLIEGE_050625\frontend-mixto\verify-integrity.ps1

# Verificar configuraci√≥n de red Docker
.\new_tests\DESPLIEGE_050625\frontend-mixto\verify-network.ps1

# Verificaciones post-despliegue
.\new_tests\DESPLIEGE_050625\frontend-mixto\post-deploy-check.ps1

# Preparar respaldo para rollback (ejecutar ANTES del despliegue)
.\new_tests\DESPLIEGE_050625\frontend-mixto\prepare-rollback.ps1

# Ejecutar rollback si algo falla (en el servidor remoto)
ssh -i "C:\Proyectos\primeros proyectos\AWS\masclet-imperi-key.pem" ec2-user@34.253.203.194 "~/masclet-imperi-web-deploy/rollback.sh"
```

## üìä Comandos para Diagn√≥stico

### Diagn√≥stico de Red Docker

```bash
# Ver redes Docker
docker network ls

# Inspeccionar red masclet-network
docker network inspect masclet-network

# Verificar conectividad entre contenedores
docker exec masclet-frontend-node getent hosts masclet-db
docker exec masclet-frontend-node curl -v http://masclet-db:8000/api/v1/health
```

### Monitoreo de Contenedores

```bash
# Ver todos los contenedores
docker ps

# Ver logs de contenedores
docker logs masclet-frontend-node --tail 20
docker logs masclet-backend --tail 20
docker logs masclet-db --tail 20
docker logs masclet-frontend --tail 20

# Ver estad√≠sticas de uso (CPU, memoria)
docker stats
```

### Diagn√≥stico del Sistema

```bash
# Ejecutar diagn√≥stico completo desde el contenedor frontend
docker exec masclet-frontend-node node /app/docker-diagnose.js

# Ver variables de entorno en contenedor
docker exec masclet-frontend-node env | grep -E 'API_|NODE_|DOCKER_'

# Verificar DNS entre contenedores
docker exec masclet-frontend-node nslookup masclet-db
```

## üíæ Comandos de Base de Datos

### Gesti√≥n de Backups

```bash
# LOCAL: Crear backup de la base de datos
python backend\scripts\backup_database.py

# AWS: Crear backup de la base de datos en servidor
ssh -i "C:\Proyectos\primeros proyectos\AWS\masclet-imperi-key.pem" ec2-user@34.253.203.194 "cd ~/masclet-imperi-web-deploy && docker exec masclet-db pg_dump -U postgres masclet_imperi > ~/backup_masclet_imperi_aws_$(date +%Y%m%d_%H%M%S).sql"
```

### Restaurar Base de Datos

```bash
# NUNCA EJECUTAR AUTOM√ÅTICAMENTE - Pedir permiso expl√≠cito primero
python backend\scripts\restore_database.py --latest

# En AWS (tambi√©n requiere permiso expl√≠cito)
ssh -i "C:\Proyectos\primeros proyectos\AWS\masclet-imperi-key.pem" ec2-user@34.253.203.194 "cd ~/masclet-imperi-web-deploy && cat ~/backup_para_restaurar.sql | docker exec -i masclet-db psql -U postgres masclet_imperi"
```

### Consulta y An√°lisis

```bash
# Ver estructura de la base de datos
python new_tests\complementos\show_db_structure.py -v

# Ver endpoints activos
python new_tests\complementos\list_endpoints.py -v

# Comprobar rol de usuario (script espec√≠fico)
python new_tests\complementos\check_ramon_role.py
```

## üõ†Ô∏è Comandos de Mantenimiento

### Gesti√≥n de Docker

```bash
# Reiniciar contenedores
docker restart masclet-frontend-node masclet-backend masclet-db masclet-frontend

# Limpiar im√°genes no utilizadas (liberar espacio)
docker images | grep -v masclet-api-imagen-completa | grep -v masclet-db-imagen-completa | grep -v REPOSITORY | awk '{print $3}' | xargs -r docker rmi -f

# Limpiar vol√∫menes hu√©rfanos
docker volume prune -f
```

### Servidores de Desarrollo

```bash
# Servidor de backend
python -m uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload

# Servidor de frontend
npm run dev -- --host
```

### AWS Remote Connection

```powershell
# Conexi√≥n SSH al servidor AWS
ssh -i "C:\Proyectos\primeros proyectos\AWS\masclet-imperi-key.pem" ec2-user@34.253.203.194

# Transferencia de archivos a AWS
scp -i "C:\Proyectos\primeros proyectos\AWS\masclet-imperi-key.pem" -r ruta_local ec2-user@34.253.203.194:ruta_remota

# Ejecutar comando remoto
ssh -i "C:\Proyectos\primeros proyectos\AWS\masclet-imperi-key.pem" ec2-user@34.253.203.194 "comando_a_ejecutar"
```

## üîç Comandos de Verificaci√≥n R√°pida

### Estado del Sistema

```bash
# Estado del disco
df -h

# Contenedores activos y su estado
docker ps

# Im√°genes Docker disponibles
docker images

# Redes Docker configuradas
docker network ls
```

### Estado de la Aplicaci√≥n

```bash
# Comprobar salud del backend
curl http://localhost:8000/api/v1/health

# Comprobar conexi√≥n frontend-backend (desde el contenedor frontend)
docker exec masclet-frontend-node curl http://masclet-db:8000/api/v1/health

# Comprobar frontend
curl http://localhost/index.html
```

## üìù Notas Importantes

1. **NUNCA ejecutar scripts de reset o restauraci√≥n** de base de datos sin aprobaci√≥n expl√≠cita.
2. Antes de cualquier despliegue importante, **crear backup** de la base de datos.
3. El frontend se comunica con el backend a trav√©s de la red Docker `masclet-network`.
4. Para los despliegues, usamos una estrategia mixta: Nginx para archivos est√°ticos + Node.js para SSR.
5. Los nuevos scripts de diagn√≥stico (`docker-diagnose.js`) facilitan la detecci√≥n de problemas de comunicaci√≥n entre contenedores.
