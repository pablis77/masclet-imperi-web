# üöÄ Plan para un Despliegue PERFECTO - Masclet Imperi Web

## üìã Estrategia para un despliegue sin fallos

Tras nuestra auditor√≠a completa, hemos identificado las mejoras necesarias para garantizar que lo que vemos en AWS (http://3.253.32.134/) sea **id√©ntico** a lo que vemos localmente (http://127.0.0.1:63834/).

## 1. Modificaciones al script de despliegue

El script `desplegar_frontend_mixto_aws.ps1` necesita estos ajustes:

### 1.1. Verificaci√≥n de consistencia de archivos

```powershell
# A√±adir despu√©s de transferir los archivos
# Verificar checksums de archivos cr√≠ticos para garantizar integridad
Write-ColorMessage "PASO EXTRA: Verificando integridad de archivos cr√≠ticos... üîç" $colorInfo
$filesToVerify = @(
    "docker-api-config.js",
    "docker-api-master.js",
    "node.Dockerfile",
    "nginx.conf"
)

foreach ($file in $filesToVerify) {
    $localHash = (Get-FileHash -Algorithm MD5 -Path "$deploySourceDir\$file").Hash
    $remoteHashCmd = "md5sum $remoteDeployDir/$file | awk '{print \$1}'"
    $remoteHash = Invoke-SshCommand $remoteHashCmd
    
    if ($localHash -eq $remoteHash) {
        Write-ColorMessage "‚úÖ Verificaci√≥n de integridad correcta para $file" $colorSuccess
    } else {
        Write-ColorMessage "‚ö†Ô∏è Advertencia: Posible corrupci√≥n en $file, intentando transferir de nuevo" $colorWarning
        Invoke-ScpTransfer "$deploySourceDir\$file" "$remoteDeployDir/"
    }
}
```

### 1.2. Verificaci√≥n de conexi√≥n al backend

```powershell
# A√±adir antes de finalizar el despliegue
Write-ColorMessage "Verificando conectividad con el backend..." $colorInfo
$backendCheck = Invoke-SshCommand "curl -s -o /dev/null -w '%{http_code}' http://masclet-db:8000/api/v1/health || echo 'Error'"

if ($backendCheck -eq "200") {
    Write-ColorMessage "‚úÖ Conectividad con backend establecida correctamente" $colorSuccess
} else {
    Write-ColorMessage "‚ö†Ô∏è No se detecta conectividad con el backend. Verificando red Docker..." $colorWarning
    # Verificar que ambos contenedores est√©n en la misma red
    Invoke-SshCommand "docker network inspect masclet-network"
}
```

### 1.3. Verificaci√≥n de configuraci√≥n autom√°tica de API

Mejorar el script `docker-api-config.js` para garantizar que detecte correctamente la URL del backend:

```javascript
// Verificaci√≥n mejorada con reintentos
function testBackendConnection(apiUrl, maxRetries = 5) {
    console.log(`Probando conexi√≥n al backend: ${apiUrl}`);
    
    let retries = 0;
    
    function attemptConnection() {
        retries++;
        console.log(`Intento ${retries}/${maxRetries}...`);
        
        try {
            // Usar XMLHttpRequest en lugar de fetch para mayor compatibilidad
            const http = new XMLHttpRequest();
            http.open('GET', apiUrl + '/health', false);
            http.send();
            
            if (http.status === 200) {
                console.log('‚úÖ Conexi√≥n exitosa al backend!');
                return true;
            } else {
                console.log(`‚ùå Error: El backend respondi√≥ con c√≥digo ${http.status}`);
                return false;
            }
        } catch (error) {
            console.log(`‚ùå Error al conectar al backend: ${error.message}`);
            return false;
        }
    }
    
    // Intentar conexi√≥n con reintentos
    let success = false;
    while (retries < maxRetries && !success) {
        success = attemptConnection();
        if (!success) {
            console.log(`Esperando 2 segundos antes del siguiente intento...`);
            // Esperar 2 segundos (implementaci√≥n s√≠ncrona)
            const startTime = new Date().getTime();
            while (new Date().getTime() < startTime + 2000) {}
        }
    }
    
    return success;
}
```

## 2. Mejoras al Archivo Docker Compose

Actualizar `docker-compose.yml` para garantizar que los contenedores se reinician autom√°ticamente:

```yaml
services:
  masclet-frontend-node:
    build:
      context: .
      dockerfile: node.Dockerfile
    restart: always # Garantiza reinicio autom√°tico
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request('http://localhost:8080/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).end()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - masclet-network
    volumes:
      - node_modules:/app/node_modules
      
  masclet-frontend:
    build:
      context: .
      dockerfile: nginx.Dockerfile
    ports:
      - "80:80"
    restart: always # Garantiza reinicio autom√°tico
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      - masclet-frontend-node
    networks:
      - masclet-network
```

## 3. Mejoras al Dockerfile de Node.js

Actualizar `node.Dockerfile` para mejorar la estabilidad y el diagn√≥stico:

```dockerfile
# Usar versi√≥n espec√≠fica para evitar problemas de compatibilidad
FROM node:18.19.0-alpine3.17

# Instalar herramientas de diagn√≥stico
RUN apk add --no-cache curl busybox-extras nano iputils

# Crear un usuario no privilegiado
RUN addgroup -S nodeuser && adduser -S -G nodeuser nodeuser

# Crear directorios necesarios
WORKDIR /app

# Copiar archivos de proyecto
COPY package*.json ./
RUN npm ci --only=production

# Copiar resto de archivos
COPY . .

# Copiar scripts de configuraci√≥n y diagn√≥stico
COPY docker-api-*.js /app/
COPY docker-diagnose.js /app/

# Verificar archivos cr√≠ticos
RUN ls -la /app/docker-api-*.js || echo "Error: Falta alg√∫n script de configuraci√≥n"

# Configurar permisos
RUN chown -R nodeuser:nodeuser /app
USER nodeuser

# Script de entrada mejorado
CMD ["/bin/sh", "-c", "node docker-diagnose.js --background & node docker-api-master.js && npm run start -- --host"]
```

## 4. Plan de Verificaci√≥n Post-Despliegue

A√±adir estos pasos de verificaci√≥n para garantizar que todo funciona correctamente:

```powershell
# A√±adir al final del script de despliegue
Write-ColorMessage "PASO FINAL: Verificaci√≥n completa del despliegue... üß™" $colorSuccess

# 1. Verificar que la aplicaci√≥n responde correctamente
$httpStatus = Invoke-SshCommand "curl -s -o /dev/null -w '%{http_code}' http://$remoteHost/ || echo 'Error'"
if ($httpStatus -eq "200") {
    Write-ColorMessage "‚úÖ Frontend responde correctamente (HTTP 200)" $colorSuccess
} else {
    Write-ColorMessage "‚ùå Error: Frontend no responde con HTTP 200 (Respuesta: $httpStatus)" $colorError
}

# 2. Verificar logs de aplicaci√≥n
Write-ColorMessage "√öltimas l√≠neas del log de Node.js:" $colorInfo
Invoke-SshCommand "docker logs masclet-frontend-node --tail 20"

Write-ColorMessage "√öltimas l√≠neas del log de Nginx:" $colorInfo
Invoke-SshCommand "docker logs masclet-frontend --tail 20"

# 3. Verificar que las rutas principales funcionan
$mainRoutes = @("/", "/dashboard", "/login")
foreach ($route in $mainRoutes) {
    $routeStatus = Invoke-SshCommand "curl -s -o /dev/null -w '%{http_code}' http://$remoteHost$route || echo 'Error'"
    Write-ColorMessage "Ruta $route: HTTP $routeStatus" $colorInfo
}

# 4. Tomar captura para inspecci√≥n visual
Write-ColorMessage "Para completar la verificaci√≥n visual, accede a: http://$remoteHost" $colorSuccess
```

## 5. Conclusi√≥n

Con estas modificaciones, garantizamos que nuestro despliegue en AWS ser√° **id√©ntico** al entorno local, asegurando:

1. ‚úÖ Integridad de todos los archivos transferidos
2. ‚úÖ Configuraci√≥n correcta de red entre contenedores
3. ‚úÖ Reinicio autom√°tico en caso de fallos
4. ‚úÖ Verificaci√≥n de conexi√≥n al backend
5. ‚úÖ Diagn√≥stico completo post-despliegue

La mayor√≠a de los problemas de inconsistencia entre entornos se deben a:
1. Archivos corrompidos durante la transferencia
2. Problemas de red entre contenedores
3. Configuraciones incorrectas de URL del backend
4. Errores no detectados en el proceso de build

Estas mejoras abordan todos estos puntos de fallo potenciales.
