# 🗺️ MAPA DE DEPENDENCIAS INTERNO - MASCLET IMPERI WEB

## 1. Módulos Clave del Frontend

```
┌─────────────────────────────────────────────────────────────┐
│                  ARQUITECTURA FRONTEND                      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐     ┌───────────────────┐    ┌────────────────────┐
│                 │     │                   │    │                    │
│    PÁGINAS      │────▶│  COMPONENTES UI   │───▶│  STORE DE ESTADO   │
│   (ASTRO/REACT) │     │   (REACT/TREMOR)  │    │    (NANOSTORES)    │
│                 │     │                   │    │                    │
└────────┬────────┘     └─────────┬─────────┘    └──────────┬─────────┘
         │                        │                         │
         │                        │                         │
         │                        ▼                         │
┌────────▼────────┐     ┌─────────────────────┐            │
│                 │     │                     │            │
│   SERVICIOS     │────▶│      UTILIDADES     │◄───────────┘
│     (AXIOS)     │     │  (FORMATEO, CÁLCULO)│
│                 │     │                     │
└─────────────────┘     └─────────────────────┘
```

### 1.1 Módulos y Responsabilidades

| Módulo | Ubicación | Responsabilidades | Dependencias |
|--------|-----------|-------------------|--------------|
| **Páginas** | `/frontend/src/pages` | Definición de rutas, layouts y contenedores de componentes | Astro, React, Componentes UI |
| **Componentes UI** | `/frontend/src/components` | Interfaces de usuario reutilizables | React, Tremor, TailwindCSS |
| **Store de Estado** | `/frontend/src/stores` | Gestión del estado global de la aplicación | Nanostores |
| **Servicios** | `/frontend/src/services` | Comunicación con el backend y APIs externas | Axios |
| **Utilidades** | `/frontend/src/utils` | Funciones auxiliares para formateo, cálculos y transformaciones | - |
| **Assets** | `/frontend/public` | Recursos estáticos (imágenes, fuentes, etc.) | - |
| **Generación PDF** | `/frontend/src/pdf` | Generación de informes y documentos PDF | jspdf, jspdf-autotable |

### 1.2 Principales Componentes y su Función

#### Core UI
- **Layout.astro**: Estructura base de todas las páginas
- **Navbar.jsx**: Barra de navegación superior
- **Sidebar.jsx**: Menú lateral de navegación
- **Modal.jsx**: Componente modal reutilizable
- **Table.jsx**: Tabla de datos interactiva

#### Páginas Principales
- **Dashboard.astro**: Panel principal de control
- **Animals.astro**: Gestión de animales
- **Explotacions.astro**: Gestión de explotaciones
- **Parts.astro**: Registro de partos
- **Users.astro**: Administración de usuarios
- **Reports.astro**: Generación de informes

#### Servicios API
- **api.js**: Cliente Axios configurado
- **authService.js**: Gestión de autenticación
- **animalService.js**: CRUD para animales
- **explotacioService.js**: CRUD para explotaciones
- **partService.js**: CRUD para partos
- **userService.js**: CRUD para usuarios

## 2. Servicios del Backend y sus Interacciones

```
┌───────────────────────────────────────────────────────────────────┐
│                       ARQUITECTURA BACKEND                        │
└───────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌────────────────┐    ┌────────────────────┐
│                 │    │                │    │                    │
│    ENDPOINTS    │───▶│   SERVICIOS    │───▶│      MODELOS       │
│    (FASTAPI)    │    │  (LÓGICA BIZ)  │    │    (SQLALCHEMY)    │
│                 │    │                │    │                    │
└────────┬────────┘    └────────┬───────┘    └──────────┬─────────┘
         │                      │                       │
         │                      │                       │
         │                      ▼                       │
┌────────▼────────┐    ┌────────────────┐               │
│                 │    │                │               │
│  AUTENTICACIÓN  │    │   UTILIDADES   │◄──────────────┘
│     (JWT)       │    │ (VALIDACIÓN)   │
│                 │    │                │
└─────────────────┘    └────────────────┘
```

### 2.1 Servicios y Responsabilidades

| Servicio | Ubicación | Responsabilidades | Dependencias |
|----------|-----------|-------------------|--------------|
| **FastAPI App** | `/backend/app/main.py` | Punto de entrada, configuración de middleware | FastAPI, Middleware |
| **Endpoints** | `/backend/app/api/endpoints` | Definición de rutas HTTP y validaciones | FastAPI, Pydantic, Servicios |
| **Servicios** | `/backend/app/services` | Lógica de negocio | SQLAlchemy, Modelos |
| **Modelos** | `/backend/app/models` | Definición de entidades y relaciones | SQLAlchemy, Pydantic |
| **Auth** | `/backend/app/auth` | Autenticación y autorización | JWT, FastAPI Security |
| **Schemas** | `/backend/app/schemas` | Validación de datos y serialización | Pydantic |
| **Core** | `/backend/app/core` | Configuración central | - |
| **Backups** | `/backend/app/backup_routes` | Gestión de copias de seguridad | - |

### 2.2 Principales Endpoints y sus Dependencias

#### Autenticación
- `/api/v1/auth/login`: Servicio de autenticación, UserModel
- `/api/v1/auth/me`: Servicio de autenticación, UserModel

#### Gestión de Animales
- `/api/v1/animals`: AnimalService, AnimalModel, ExplotacioModel
- `/api/v1/animals/{id}`: AnimalService, AnimalModel, PartModel
- `/api/v1/animals/import`: AnimalService, ImportService

#### Gestión de Explotaciones
- `/api/v1/explotacions`: ExplotacioService, ExplotacioModel
- `/api/v1/explotacions/{id}`: ExplotacioService, ExplotacioModel, AnimalModel

#### Gestión de Partos
- `/api/v1/parts`: PartService, PartModel, AnimalModel
- `/api/v1/parts/{id}`: PartService, PartModel

#### Usuarios y Permisos
- `/api/v1/users`: UserService, UserModel, RoleModel
- `/api/v1/users/{id}/role`: UserService, RoleService

#### Sistema de Backups
- `/api/v1/scheduled-backup/history`: BackupService
- `/api/v1/scheduled-backup/trigger`: BackupService

## 3. Puntos de Integración entre Sistemas

```
┌────────────────────────────────────────────────────────────────────┐
│                   INTEGRACIÓN ENTRE SISTEMAS                       │
└────────────────────────────────────────────────────────────────────┘

┌─────────────────────┐                      ┌─────────────────────┐
│                     │                      │                     │
│    FRONTEND SSR     │◄────── HTTP ─────────┤  NAVEGADOR CLIENTE  │
│    (NODE ALPINE)    │                      │                     │
│                     │                      │                     │
└──────────┬──────────┘                      └─────────────────────┘
           │
           │ HTTP/REST API
           │
┌──────────▼──────────┐     ┌─────────────────────────┐
│                     │     │                         │
│   BACKEND FASTAPI   │◄────┤  SERVICIOS EXTERNOS     │
│                     │     │  (AWS, EMAIL, ETC)      │
│                     │     │                         │
└──────────┬──────────┘     └─────────────────────────┘
           │
           │ SQL/ORM
           │
┌──────────▼──────────┐
│                     │
│     POSTGRESQL      │
│                     │
│                     │
└─────────────────────┘
```

### 3.1 Interfaces de Comunicación

| Interfaz | Tipo | Origen | Destino | Protocolo | Autenticación |
|----------|------|--------|---------|-----------|---------------|
| **Frontend ↔ Backend** | REST API | Frontend (Axios) | Backend (FastAPI) | HTTP/HTTPS | JWT |
| **SSR Renders** | Server-Side | Node.js Alpine | Cliente | HTTP | Cookies de sesión |
| **Backend ↔ DB** | ORM | SQLAlchemy | PostgreSQL | SQL | Credenciales DB |
| **Backend ↔ Servicios** | API | Backend | AWS S3, SMTP, etc. | HTTP/HTTPS | API Keys/IAM |
| **Nginx ↔ Node.js** | Proxy | Nginx | Node.js | HTTP | - |
| **Backups DB** | Interno | Backend | Sistema de archivos | SQL Dump | - |

### 3.2 Flujos de Datos Críticos

#### 1. Flujo de Autenticación
```
Cliente → [POST /api/v1/auth/login] → Backend → Verifica credenciales con BD → 
Genera JWT → Devuelve token → Frontend almacena token → 
Incluye token en cabecera Authorization para futuras peticiones
```

#### 2. Flujo de Importación de Animales
```
Cliente → Carga CSV → [POST /api/v1/animals/import] con archivo → 
Backend procesa CSV → Valida formato → Crea registros en BD → 
Devuelve resultado con éxitos/errores → Frontend muestra resultado
```

#### 3. Flujo de Generación de Reportes
```
Cliente → Solicita informe → Frontend llama a API para datos → 
Backend consulta y agrega datos → Frontend recibe datos → 
Frontend genera PDF con jspdf → Cliente descarga PDF
```

#### 4. Flujo de Backup Automático
```
Cron job → Trigger backup endpoint → Backend ejecuta dump PostgreSQL → 
Guarda en filesystem → Actualiza registro de backups → 
Limpia backups antiguos según política retención
```

## 4. Dependencias Externas y Servicios de Terceros

### 4.1 Servicios AWS
- **EC2**: Alojamiento de contenedores Docker 
- **S3** (Potencial): Almacenamiento de backups

### 4.2 Bibliotecas Críticas
- **Astro**: Framework principal del frontend
- **FastAPI**: Framework principal del backend
- **SQLAlchemy**: ORM para la base de datos
- **Nginx**: Proxy inverso y servidor web
- **Docker + Compose**: Contenerización y orquestación

### 4.3 Datos Externos
- **Importaciones CSV**: Para la carga masiva de datos de animales

## 5. Puntos de Extensión y Módulos Futuros

### 5.1 Extensiones Planificadas
- **Sistema de notificaciones**: Email/SMS para eventos importantes
- **API pública**: Para integraciones con sistemas externos
- **Aplicación móvil**: Cliente móvil conectado a la misma API

### 5.2 Áreas de Mejora
- **Microservicios**: División potencial en servicios más pequeños
- **Cache**: Implementación de capa de caché para mejorar rendimiento
- **Mejoras de seguridad**: Implementación de autenticación 2FA
