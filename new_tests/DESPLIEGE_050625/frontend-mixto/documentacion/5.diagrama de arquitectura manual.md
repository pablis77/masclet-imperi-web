# 🏗️ DIAGRAMA DE ARQUITECTURA DE MASCLET IMPERI WEB

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ARQUITECTURA MASCLET IMPERI                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                           CLIENTE (NAVEGADOR)                           │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          CONTENEDOR AWS (EC2)                           │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                        masclet-network                          │   │
│   │                                                                 │   │
│   │   ┌───────────────────┐       ┌───────────────────┐            │   │
│   │   │                   │       │                   │            │   │
│   │   │  FRONTEND MIXTO   │       │     BACKEND       │            │   │
│   │   │                   │       │                   │            │   │
│   │   │ ┌───────────────┐ │       │ ┌───────────────┐ │            │   │
│   │   │ │  Nginx Alpine │ │       │ │   FastAPI     │ │            │   │
│   │   │ │  Puerto: 80   │◄┼───────┼─┤   Puerto: 8000│ │            │   │
│   │   │ └───────┬───────┘ │       │ └───────┬───────┘ │            │   │
│   │   │         │         │       │         │         │            │   │
│   │   │         ▼         │       │         │         │            │   │
│   │   │ ┌───────────────┐ │       │         ▼         │            │   │
│   │   │ │ Node.js Alpine│ │       │ ┌───────────────┐ │            │   │
│   │   │ │ Puerto: 3000  │ │       │ │  PostgreSQL   │◄┼────────────┤   │
│   │   │ └───────────────┘ │       │ │  Puerto: 5432 │ │            │   │
│   │   │                   │       │ └───────────────┘ │            │   │
│   │   └───────────────────┘       └───────────────────┘            │   │
│   │                                                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔄 FLUJO DE DATOS

```
┌─────────────────┐     ┌────────────────┐     ┌───────────────┐     ┌───────────────┐
│                 │     │                │     │               │     │               │
│    CLIENTE      │     │  NGINX ALPINE  │     │  NODE ALPINE  │     │    FASTAPI    │
│    Navegador    │     │  (Puerto 80)   │     │  (Puerto 3000)│     │  (Puerto 8000)│
│                 │     │                │     │               │     │               │
└────────┬────────┘     └───────┬────────┘     └───────┬───────┘     └───────┬───────┘
         │                      │                      │                     │
         │   1. Solicitud HTTP  │                      │                     │
         ├─────────────────────►│                      │                     │
         │                      │                      │                     │
         │                      │ 2a. Si es estático   │                     │
         │                      │    (CSS, JS, IMG)    │                     │
         │                      │    Sirve directo     │                     │
         │                      │                      │                     │
         │                      │ 2b. Si es dinámico   │                     │
         │                      ├─────────────────────►│                     │
         │                      │                      │                     │
         │                      │                      │ 3a. Renderiza SSR   │
         │                      │                      │     con Astro       │
         │                      │                      │                     │
         │                      │                      │ 3b. Si requiere     │
         │                      │                      │     datos de API    │
         │                      │                      ├────────────────────►│
         │                      │                      │                     │
         │                      │                      │                     │ 4. Consulta
         │                      │                      │                     │    Base de Datos
         │                      │                      │                     │
         │                      │                      │                     │ 5. Procesa 
         │                      │                      │                     │    resultados
         │                      │                      │                     │
         │                      │                      │◄────────────────────┤
         │                      │                      │ 6. Devuelve datos   │
         │                      │                      │                     │
         │                      │                      │ 7. Completa         │
         │                      │                      │    renderizado      │
         │                      │                      │                     │
         │                      │◄─────────────────────┤                     │
         │                      │ 8. Devuelve HTML     │                     │
         │                      │    renderizado       │                     │
         │                      │                      │                     │
         │◄─────────────────────┤                      │                     │
         │ 9. Entrega respuesta │                      │                     │
         │                      │                      │                     │
         │                      │                      │                     │
```

## 🧱 ARQUITECTURA DETALLADA

### 1️⃣ FRONTEND MIXTO - ESTRUCTURA

```
┌─────────────────────────────────────────────────────────┐
│               CONTENEDOR NGINX (FRONTEND)               │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────┐       ┌────────────────────────┐   │
│  │  CONFIGURACIÓN  │       │   ARCHIVOS ESTÁTICOS   │   │
│  ├─────────────────┤       ├────────────────────────┤   │
│  │ - nginx.conf    │       │ - /client/_astro       │   │
│  │ - proxy config  │       │   (Assets compilados)  │   │
│  │ - cache config  │       │ - /client/images       │   │
│  │ - health checks │       │ - /client/css          │   │
│  └─────────────────┘       │ - /client/js           │   │
│                            └────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│               CONTENEDOR NODE.JS (SSR)                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────┐       ┌────────────────────────┐   │
│  │   APLICACIÓN    │       │  SCRIPTS DE SOPORTE    │   │
│  ├─────────────────┤       ├────────────────────────┤   │
│  │ - server/       │       │ - docker-api-master.js │   │
│  │   entry.mjs     │       │ - docker-api-detector  │   │
│  │ - client/       │       │ - docker-api-config    │   │
│  │   (Vista Astro) │       │ - docker-api-injector  │   │
│  └─────────────────┘       │ - docker-diagnose.js   │   │
│                            └────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2️⃣ BACKEND - ESTRUCTURA

```
┌─────────────────────────────────────────────────────────┐
│                 CONTENEDOR BACKEND                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────┐       ┌────────────────────────┐   │
│  │     FastAPI     │       │       ENDPOINTS        │   │
│  ├─────────────────┤       ├────────────────────────┤   │
│  │ - app/main.py   │       │ - /api/v1/animals      │   │
│  │ - middlewares   │       │ - /api/v1/users        │   │
│  │ - configuración │       │ - /api/v1/explotacions │   │
│  │ - seguridad     │       │ - /api/v1/health       │   │
│  └─────────────────┘       │ - /api/v1/auth         │   │
│                            └────────────────────────┘   │
│                                                         │
│  ┌─────────────────┐       ┌────────────────────────┐   │
│  │    SERVICIOS    │       │        MODELOS         │   │
│  ├─────────────────┤       ├────────────────────────┤   │
│  │ - auth service  │       │ - Animal               │   │
│  │ - user service  │       │ - User                 │   │
│  │ - animal service│       │ - Explotacio           │   │
│  │ - backup service│       │ - Part                 │   │
│  └─────────────────┘       └────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│               CONTENEDOR POSTGRESQL                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐    │
│  │                 BASE DE DATOS                   │    │
│  ├─────────────────────────────────────────────────┤    │
│  │  - Tablas: animals, users, explotacions, parts  │    │
│  │  - Índices y relaciones                         │    │
│  │  - Volumen persistente (Docker volume)          │    │
│  │  - Scripts de backup automático                 │    │
│  └─────────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3️⃣ TECNOLOGÍAS POR CAPA

```
┌──────────────────────────────────────────────────────────────────────┐
│                          STACK TECNOLÓGICO                           │
├─────────────────┬────────────────────┬─────────────────┬─────────────┤
│    FRONTEND     │   SERVIDOR SSR     │      API        │    BASE     │
│     (ASTRO)     │     (NODE.JS)      │    (FASTAPI)    │   DATOS     │
├─────────────────┼────────────────────┼─────────────────┼─────────────┤
│ - Astro 4.16    │ - Node.js 18       │ - Python 3.10+  │ - Postgres  │
│ - React 19.0    │ - Express 4.21     │ - FastAPI 0.85+ │ - SQLAlchemy│
│ - TailwindCSS   │ - Alpine Linux     │ - Pydantic 2.0+ │ - Tortoise  │
│ - React Router  │ - node-fetch 3.3   │ - Uvicorn       │ - Alembic   │
│ - Chart.js      │ - ES Modules       │ - JWT           │ - Asyncpg   │
│ - Tremor UI     │                    │ - Pandas        │             │
└─────────────────┴────────────────────┴─────────────────┴─────────────┘
```

### 4️⃣ FLUJO DE DESPLIEGUE (CI/CD)

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│          │     │          │     │          │     │          │
│ CÓDIGO   │     │ SCRIPT   │     │ INSTANCIA│     │ DOCKER   │
│ LOCAL    │──►  │ POWERSHELL│──►  │ AWS EC2  │──►  │ COMPOSE  │
│          │     │          │     │          │     │          │
└──────────┘     └──────────┘     └──────────┘     └──────────┘
      │                                                  │
      │                                                  ▼
┌─────▼──────┐                                    ┌──────────┐
│            │                                    │          │
│  RESPALDO  │                                    │ CONTENEDO│
│  DATABASE  │◄───────────────────────────────────│ RES      │
│            │                                    │          │
└────────────┘                                    └──────────┘
```

## 📚 COMPONENTES CLAVE Y SUS RELACIONES

### Componentes del Frontend:
- **Nginx**: Proxy inverso y servidor de archivos estáticos
  - ↔️ Se comunica con: Node.js (masclet-frontend-node)
  - ↔️ Se comunica con: Backend (masclet-backend)
  - 🔄 Sirve: Archivos estáticos compilados (CSS, JS, imágenes)
  - 🔄 Proxy: Solicitudes de API y renderizado dinámico

- **Node.js (SSR)**:
  - ↔️ Se comunica con: Backend API (para datos)
  - 🔄 Ejecuta: Astro SSR (Server Side Rendering)
  - 🔄 Gestiona: API client-side
  - 🔄 Detecta: Configuración de red Docker

### Componentes del Backend:
- **FastAPI**:
  - ↔️ Se comunica con: PostgreSQL (para persistencia)
  - 🔄 Gestiona: Autenticación y autorización
  - 🔄 Expone: RESTful API endpoints
  - 🔄 Procesa: Lógica de negocio

- **PostgreSQL**:
  - 🔄 Almacena: Todos los datos de la aplicación
  - 🔄 Gestiona: Transacciones e integridad referencial
  - 🔄 Soporta: Backup y restauración

## 🔄 SISTEMA DE COMUNICACIÓN DOCKER

```
┌──────────────────────────────────────────────────────────────────────┐
│                      COMUNICACIÓN ENTRE CONTENEDORES                  │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  masclet-frontend (Nginx) ◄──────► masclet-frontend-node (Node.js)   │
│            │                                   │                     │
│            │                                   │                     │
│            ▼                                   ▼                     │
│  masclet-backend (FastAPI) ◄────────────────► masclet-db (Postgres)  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```
