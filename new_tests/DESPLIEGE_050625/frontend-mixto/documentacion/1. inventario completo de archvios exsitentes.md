
# Inventario Completo de Archivos de Despliegue Frontend Mixto

## 1. Archivos de Configuración Docker

### 📄 docker-compose.yml

* **Función** : Define la estructura de los contenedores y su relación
* **Componentes principales** :
* Servicio

  ```
  masclet-frontend-node
  ```

  : Contenedor Node.js para SSR
* Servicio

  ```
  masclet-frontend-nginx
  ```

  : Proxy inverso y servidor de estáticos
* Red

  ```
  masclet-network
  ```

  : Red compartida (externa)
* **Observación** : Los contenedores se configuran correctamente para reiniciarse automáticamente (

```
  restart: unless-stopped
```

  )

### 📄 node.Dockerfile

* **Función** : Configuración para el contenedor Node.js (Alpine)
* **Características** :
* Construcción multi-etapa para optimizar tamaño
* Instalación de dependencias y herramientas de diagnóstico
* Script de arranque mejorado para mantener el contenedor activo
* Configuración de variables de entorno y puertos
* Scripts de diagnóstico para detectar problemas
* Incluye mecanismo para mantener el contenedor activo con
  ```
  tail -f
  ```

### 📄 nginx.Dockerfile

* **Función** : Configuración para el contenedor Nginx (Alpine)
* **Características** :
* Copia archivos estáticos y configuración
* Expone puerto 80
* Incluye healthcheck básico

### 📄 nginx.conf

* **Función** : Configuración detallada de Nginx
* **Configuraciones clave** :
* Proxy hacia el contenedor Node.js para SSR (

  ```
  masclet-frontend-node:3000
  ```

  )
* Proxy hacia el backend para API (

  ```
  masclet-backend:8000
  ```

  )
* Gestión de activos estáticos con caché optimizada
* Headers de seguridad
* Healthchecks internos

## 2. Scripts de Configuración Automática de API

### 📄 docker-api-master.js

* **Función** : Coordinador principal del sistema de configuración API
* **Proceso** :

1. Detecta si estamos en Docker
2. Obtiene la IP del backend
3. Genera configuración y ajusta archivos
4. Crea registro de diagnóstico

* **Dependencias** : Utiliza los módulos detector, config e injector

### 📄 docker-api-detector.js

* **Función** : Detectar entorno Docker y localizar IP del backend
* **Métodos de detección** :
* Variables de entorno Docker
* Archivos del sistema Docker
* Múltiples métodos para detectar IP (getent, nslookup, ping, docker inspect)
* Pruebas de conectividad DNS y HTTP
* **Fallback** : Si todo falla, usa

```
  masclet-backend
```

   como hostname

### 📄 docker-api-config.js

* **Función** : Generar configuración de API para el cliente
* **Operaciones** :
* Configurar URLs de API para el cliente
* Modificar puntos de entrada del servidor
* Pruebas de conexión al backend

### 📄 docker-api-injector.js

* **Función** : Inyectar configuraciones en tiempo de ejecución
* **Capacidades** :
* Configura interceptores HTTP
* Configura middleware para Express
* Modifica rutas de API dinámicamente

### 📄 docker-api-fix.js (+ archivos .bak y .new)

* **Función** : Script para arreglos específicos de configuración API
* **Observación** : Parece haber versiones de backup y nuevas versiones

### 📄 docker-diagnose.js

* **Función** : Script independiente para diagnóstico
* **Pruebas** :
* Resolución DNS
* Ping
* Conexiones HTTP
* Conexiones TCP
* Información del sistema

## 3. Scripts de Despliegue

### 📄 desplegar_frontend_mixto_aws.ps1

* **Función** : Script PowerShell para desplegar en AWS
* **Operaciones principales** :
* Transferencia de archivos (SCP)
* Ejecución de comandos remotos (SSH)
* Limpieza de contenedores e imágenes antiguas
* Construcción y arranque de contenedores

## 4. Archivos de Configuración de Aplicación

### 📄 package.json

* **Función** : Define dependencias mínimas para el contenedor
* **Observación** : Parece ser un archivo simplificado

## Análisis de Problemas y Recomendaciones

### Comunicación entre contenedores

1. **Red Docker** : Todos los contenedores deben estar en la misma red

```
   masclet-network
```

1. **Resolución DNS** : El sistema intenta usar nombres de servicio como

```
   masclet-backend
```

1. **IP Directa** : Como fallback, se intenta detectar la IP directamente

### Problemas detectados

1. **Terminación del contenedor Node.js** :

* El script principal termina inmediatamente, hemos añadido

  ```
  tail -f
  ```

  para mantenerlo activo
* Posible problema con la existencia de

  ```
  entry.mjs
  ```

  o su ejecución

1. **Configuración de Alpine Linux** :

* Se ha corregido para usar

  ```
  apk
  ```

  en lugar de

  ```
  apt-get
  ```
* Se instalaron herramientas de diagnóstico específicas para Alpine

1. **Espacio en disco** :

* AWS tiene problemas de espacio (85% ocupado)
* Probablemente causando errores de construcción de imágenes

### Flujo de inicio correcto

1. El contenedor

   ```
   masclet-frontend-node
   ```

   inicia y ejecuta:

   * Verificación de archivos
   * Diagnóstico en segundo plano
   * Configuración de API
   * Inicialización del servidor Node.js
2. El contenedor

   ```
   masclet-frontend-nginx
   ```

   espera que el Node.js esté listo

   * Sirve archivos estáticos directamente
   * Envía solicitudes dinámicas a Node.js
   * Dirige solicitudes de API al backend

## Siguientes pasos recomendados

1. **Verificar archivos críticos** :

* Confirmar la existencia de

  ```
  /app/server/entry.mjs
  ```

  en el contenedor Node.js
* Revisar permisos y estructura de directorios

1. **Analizar logs del contenedor** :

* Revisar

  ```
  docker logs masclet-frontend-node
  ```

  después del intento de inicio
* Revisar

  ```
  /app/diagnostico.log
  ```

  dentro del contenedor

1. **Optimizar espacio en disco** :

* Limpiar imágenes y contenedores antiguos
* Considerar incrementar el espacio en el servidor AWS

1. **Estrategia de despliegue** :

* Mantener la estructura mixta (Node.js + Nginx)
* Garantizar la persistencia del contenedor Node.js
* Asegurar la correcta comunicación entre contenedores
