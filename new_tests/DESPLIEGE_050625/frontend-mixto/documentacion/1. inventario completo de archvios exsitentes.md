
# Inventario Completo de Archivos de Despliegue Frontend Mixto

## 1. Archivos de Configuraci贸n Docker

###  docker-compose.yml

* **Funci贸n** : Define la estructura de los contenedores y su relaci贸n
* **Componentes principales** :
* Servicio

  ```
  masclet-frontend-node
  ```

  : Contenedor Node.js para SSR
* Servicio

  ```
  masclet-frontend-nginx
  ```

  : Proxy inverso y servidor de est谩ticos
* Red

  ```
  masclet-network
  ```

  : Red compartida (externa)
* **Observaci贸n** : Los contenedores se configuran correctamente para reiniciarse autom谩ticamente (

```
  restart: unless-stopped
```

  )

###  node.Dockerfile

* **Funci贸n** : Configuraci贸n para el contenedor Node.js (Alpine)
* **Caracter铆sticas** :
* Construcci贸n multi-etapa para optimizar tama帽o
* Instalaci贸n de dependencias y herramientas de diagn贸stico
* Script de arranque mejorado para mantener el contenedor activo
* Configuraci贸n de variables de entorno y puertos
* Scripts de diagn贸stico para detectar problemas
* Incluye mecanismo para mantener el contenedor activo con
  ```
  tail -f
  ```

###  nginx.Dockerfile

* **Funci贸n** : Configuraci贸n para el contenedor Nginx (Alpine)
* **Caracter铆sticas** :
* Copia archivos est谩ticos y configuraci贸n
* Expone puerto 80
* Incluye healthcheck b谩sico

###  nginx.conf

* **Funci贸n** : Configuraci贸n detallada de Nginx
* **Configuraciones clave** :
* Proxy hacia el contenedor Node.js para SSR (

  ```
  masclet-frontend-node:3000
  ```

  )
* Proxy hacia el backend para API (

  ```
  masclet-backend:8000
  ```

  )
* Gesti贸n de activos est谩ticos con cach茅 optimizada
* Headers de seguridad
* Healthchecks internos

## 2. Scripts de Configuraci贸n Autom谩tica de API

###  docker-api-master.js

* **Funci贸n** : Coordinador principal del sistema de configuraci贸n API
* **Proceso** :

1. Detecta si estamos en Docker
2. Obtiene la IP del backend
3. Genera configuraci贸n y ajusta archivos
4. Crea registro de diagn贸stico

* **Dependencias** : Utiliza los m贸dulos detector, config e injector

###  docker-api-detector.js

* **Funci贸n** : Detectar entorno Docker y localizar IP del backend
* **M茅todos de detecci贸n** :
* Variables de entorno Docker
* Archivos del sistema Docker
* M煤ltiples m茅todos para detectar IP (getent, nslookup, ping, docker inspect)
* Pruebas de conectividad DNS y HTTP
* **Fallback** : Si todo falla, usa

```
  masclet-backend
```

   como hostname

###  docker-api-config.js

* **Funci贸n** : Generar configuraci贸n de API para el cliente
* **Operaciones** :
* Configurar URLs de API para el cliente
* Modificar puntos de entrada del servidor
* Pruebas de conexi贸n al backend

###  docker-api-injector.js

* **Funci贸n** : Inyectar configuraciones en tiempo de ejecuci贸n
* **Capacidades** :
* Configura interceptores HTTP
* Configura middleware para Express
* Modifica rutas de API din谩micamente

###  docker-api-fix.js (+ archivos .bak y .new)

* **Funci贸n** : Script para arreglos espec铆ficos de configuraci贸n API
* **Observaci贸n** : Parece haber versiones de backup y nuevas versiones

###  docker-diagnose.js

* **Funci贸n** : Script independiente para diagn贸stico
* **Pruebas** :
* Resoluci贸n DNS
* Ping
* Conexiones HTTP
* Conexiones TCP
* Informaci贸n del sistema

## 3. Scripts de Despliegue

###  desplegar_frontend_mixto_aws.ps1

* **Funci贸n** : Script PowerShell para desplegar en AWS
* **Operaciones principales** :
* Transferencia de archivos (SCP)
* Ejecuci贸n de comandos remotos (SSH)
* Limpieza de contenedores e im谩genes antiguas
* Construcci贸n y arranque de contenedores

## 4. Archivos de Configuraci贸n de Aplicaci贸n

###  package.json

* **Funci贸n** : Define dependencias m铆nimas para el contenedor
* **Observaci贸n** : Parece ser un archivo simplificado

## An谩lisis de Problemas y Recomendaciones

### Comunicaci贸n entre contenedores

1. **Red Docker** : Todos los contenedores deben estar en la misma red

```
   masclet-network
```

1. **Resoluci贸n DNS** : El sistema intenta usar nombres de servicio como

```
   masclet-backend
```

1. **IP Directa** : Como fallback, se intenta detectar la IP directamente

### Problemas detectados

1. **Terminaci贸n del contenedor Node.js** :

* El script principal termina inmediatamente, hemos a帽adido

  ```
  tail -f
  ```

  para mantenerlo activo
* Posible problema con la existencia de

  ```
  entry.mjs
  ```

  o su ejecuci贸n

1. **Configuraci贸n de Alpine Linux** :

* Se ha corregido para usar

  ```
  apk
  ```

  en lugar de

  ```
  apt-get
  ```
* Se instalaron herramientas de diagn贸stico espec铆ficas para Alpine

1. **Espacio en disco** :

* AWS tiene problemas de espacio (85% ocupado)
* Probablemente causando errores de construcci贸n de im谩genes

### Flujo de inicio correcto

1. El contenedor

   ```
   masclet-frontend-node
   ```

   inicia y ejecuta:

   * Verificaci贸n de archivos
   * Diagn贸stico en segundo plano
   * Configuraci贸n de API
   * Inicializaci贸n del servidor Node.js
2. El contenedor

   ```
   masclet-frontend-nginx
   ```

   espera que el Node.js est茅 listo

   * Sirve archivos est谩ticos directamente
   * Env铆a solicitudes din谩micas a Node.js
   * Dirige solicitudes de API al backend

## Siguientes pasos recomendados

1. **Verificar archivos cr铆ticos** :

* Confirmar la existencia de

  ```
  /app/server/entry.mjs
  ```

  en el contenedor Node.js
* Revisar permisos y estructura de directorios

1. **Analizar logs del contenedor** :

* Revisar

  ```
  docker logs masclet-frontend-node
  ```

  despu茅s del intento de inicio
* Revisar

  ```
  /app/diagnostico.log
  ```

  dentro del contenedor

1. **Optimizar espacio en disco** :

* Limpiar im谩genes y contenedores antiguos
* Considerar incrementar el espacio en el servidor AWS

1. **Estrategia de despliegue** :

* Mantener la estructura mixta (Node.js + Nginx)
* Garantizar la persistencia del contenedor Node.js
* Asegurar la correcta comunicaci贸n entre contenedores
